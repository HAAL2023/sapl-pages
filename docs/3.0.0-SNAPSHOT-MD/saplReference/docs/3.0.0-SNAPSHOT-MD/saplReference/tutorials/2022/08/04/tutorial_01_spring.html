<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.8.0 -->
<title>Implementing Attribute-based Access Control (ABAC) with Spring and SAPL | SAPL - The Streaming Attribute Policy Language and Engine</title>
<meta name="generator" content="Jekyll v4.2.2" />
<meta property="og:title" content="Implementing Attribute-based Access Control (ABAC) with Spring and SAPL" />
<meta name="author" content="Dominic Heutelbeck" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="What is Attribute-based Access Control? Attribute-based Access Control (ABAC) is an expressive access control model. In this tutorial, you will learn how secure services and APIs of a Spring Boot application using the SAPL Engine to implement ABAC. The tutorial assumes basic familiarity with the development process of Spring applications." />
<meta property="og:description" content="What is Attribute-based Access Control? Attribute-based Access Control (ABAC) is an expressive access control model. In this tutorial, you will learn how secure services and APIs of a Spring Boot application using the SAPL Engine to implement ABAC. The tutorial assumes basic familiarity with the development process of Spring applications." />
<link rel="canonical" href="https://heutelbeck.github.io/tutorials/2022/08/04/tutorial_01_spring.html" />
<meta property="og:url" content="https://heutelbeck.github.io/tutorials/2022/08/04/tutorial_01_spring.html" />
<meta property="og:site_name" content="SAPL - The Streaming Attribute Policy Language and Engine" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2022-08-04T00:00:00+00:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Implementing Attribute-based Access Control (ABAC) with Spring and SAPL" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Dominic Heutelbeck"},"dateModified":"2022-08-04T00:00:00+00:00","datePublished":"2022-08-04T00:00:00+00:00","description":"What is Attribute-based Access Control? Attribute-based Access Control (ABAC) is an expressive access control model. In this tutorial, you will learn how secure services and APIs of a Spring Boot application using the SAPL Engine to implement ABAC. The tutorial assumes basic familiarity with the development process of Spring applications.","headline":"Implementing Attribute-based Access Control (ABAC) with Spring and SAPL","mainEntityOfPage":{"@type":"WebPage","@id":"https://heutelbeck.github.io/tutorials/2022/08/04/tutorial_01_spring.html"},"url":"https://heutelbeck.github.io/tutorials/2022/08/04/tutorial_01_spring.html"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/css/style.css"><link type="application/atom+xml" rel="alternate" href="https://heutelbeck.github.io/feed.xml" title="SAPL - The Streaming Attribute Policy Language and Engine" />    <link rel="icon" href="/assets/favicon.png" type="image/png">
    <!-- Matomo -->
    <script type="text/javascript">
        var _paq = window._paq || [];    
        _paq.push(["disableCookies"]);
        _paq.push(['trackPageView']);
        _paq.push(['enableLinkTracking']);
        (function() {
            var u="//www.ftk.de/statistik/";
            _paq.push(['setTrackerUrl', u+'matomo.php']);
            _paq.push(['setSiteId', '2']);
            var d=document, g=d.createElement('script'), s=d.getElementsByTagName('script')[0];
            g.type='text/javascript'; g.async=true; g.defer=true; g.src=u+'matomo.js'; s.parentNode.insertBefore(g,s);
        })();
    </script>
    <!-- End Matomo Code --></head>
<body><header class="site-header">
    <div class="wrapper"><a class="site-logo" rel="author" href="/"><img src="/assets/logo-header-45.png" alt="SAPL - The Streaming Attribute Policy Language and Engine"  height="45px" width="282px"></a><nav class="site-nav">
          <input type="checkbox" id="nav-trigger" class="nav-trigger" />
          <label for="nav-trigger">
            <span class="menu-icon">
              <svg viewBox="0 0 18 15" width="18px" height="15px">
                <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
              </svg>
            </span>
          </label>
  
          <div class="trigger">
                    <a class="page-link" href="/about">About</a>
                
                    <a class="page-link" href="/blog">Blog</a>
                
                    <a class="page-link" href="/documentation">Docs</a>
                
                    <a class="page-link" href="/faq">FAQ</a>
                
                    <a class="page-link" href="/publications">Publications</a>
                <a class="page-link" href="https://playground.sapl.io/">Playground</a>
            <a class="page-link" href="https://discord.gg/pRXEVWm3xM">
                <img alt="Discord" src="/assets/Discord-Logo-White.svg" height="15px"/>
            </a>
            <a class="page-link" href="https://github.com/heutelbeck?tab=repositories">
              <img alt="GitHub" src="/assets/GitHub-Mark-Light-32px.png" height="15px"/>
            </a>
          </div>
        </nav></div>
  </header><main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">Implementing Attribute-based Access Control (ABAC) with Spring and SAPL</h1>
    <p class="post-meta"><time class="dt-published" datetime="2022-08-04T00:00:00+00:00" itemprop="datePublished">
        Aug 4, 2022
      </time>• 
          <span itemprop="author" itemscope itemtype="http://schema.org/Person">
            <span class="p-author h-card" itemprop="name">Dominic Heutelbeck</span></span></p>
  </header>

  <div class="post-content e-content" itemprop="articleBody">
    <h2 id="what-is-attribute-based-access-control">What is Attribute-based Access Control?</h2>

<p>Attribute-based Access Control (ABAC) is an expressive access control model. 
In this tutorial, you will learn how secure services and APIs of a Spring Boot application using the SAPL Engine to implement ABAC. The tutorial assumes basic familiarity with the development process of Spring applications.</p>

<!--more-->

<p><img src="/assets/tutorial_01/abac.png" alt="ABAC" /></p>

<p>ABAC decides on granting access by inspecting attributes of the subject, resource, action, and environment.</p>

<p>The subject is the user or system requesting access to a resource. Attributes may include information such as the user’s department in an organization, a security clearance level, schedules, location, or qualifications in the form of certifications.</p>

<p>The action is how the subject attempts to access the resource. An action may be one of the typical CRUD operations or something more domain-specific like “assign new operator,” and attributes could include parameters of the operation.</p>

<p>Resource attributes may include owners, security classification, categories, or other arbitrary domain-specific data.</p>

<p>Environment attributes include data like the system and infrastructure context or time.</p>

<p>An application performing authorization of an action formulates an authorization question by collecting attributes of the subject, action, resource, and environment as required by the domain and asks a decision-making component which then makes a decision based on domain-specific rules which the application then has to enforce.</p>

<h3 id="the-sapl-attribute-based-access-control-abac-architecture">The SAPL Attribute-Based Access Control (ABAC) Architecture</h3>

<p>SAPL implements its interpretation of ABAC called Attribute Stream-Based Access Control (ASBAC). It uses publish-subscribe as its primary mode of interaction between the individual components. This tutorial will explain the basic ideas. The <a href="/docs/2.1.0-SNAPSHOT/sapl-reference.html#reference-architecture">SAPL Documentation</a> provides a more complete discussion of the architecture.</p>

<p><img src="/assets/sapl-architecture.png" alt="SAPL ABAC/ASBAC Architecture" /></p>

<p>In your application, there will be several code paths where a subject attempts to perform some action on a resource, and based on the domain’s requirements, the action must be authorized. For example, in a zero-trust system, all actions triggered by users or other components must be explicitly authorized.</p>

<p>A <em>Policy Enforcement Point (PEP)</em> is the logic in your application in these code paths that do:</p>
<ul>
  <li>mediate access to the <em>Resource Access Point (RAP)</em>, i.e., the component executing the action and potentially retrieving data</li>
  <li>formulate the authorization question in the form of an <em>authorization subscription</em>, i.e., a JSON object containing values for the subject, resource, action, and possibly the environment. The PEP determines the values based on the domain and context of the current attempt to execute the action.</li>
  <li>delegates the decision-making for the authorization question to the <em>Policy Decision Point (PDP)</em> by subscribing to it using the authorization subscription.</li>
  <li>enforces all decisions made by the PDP.</li>
</ul>

<p>This tutorial will not examine the subscription nature of SAPL authorization. And instead, it will only look at PEPs requiring a single decision. Later tutorials will teach you how to use authorization subscriptions to handle reactive datatypes like <code class="language-plaintext highlighter-rouge">Flux&lt;&gt;</code>, Axon subscription queries, or interactive web applications with Vaadin.</p>

<p>In SAPL, decisions may contain additional requirements for the PEP to enforce beyond the simple permission or denial of access. SAPL decisions may include constraints, i.e., further actions the PEP has to perform to grant success. If a constraint is optional, it is called <em>advice</em>. If the constraint is mandatory, it is called an <em>obligation</em>.</p>

<p>SAPL also denotes a policy language used to express the rules describing the overall policies governing access control in the organization. For each authorization subscription, the PDP monitors the <em>Policy Retrieval Point (PRP)</em> for policies responsible, i.e., <em>applicable</em>, to the subscription. Individual policies may refer to attributes not stored within the authorization subscription. The PDP can subscribe to these attributes using domain-specific <em>Policy Information Points (PIPs)</em>. The PDP continuously evaluates the policies as the PIP attributes change and the policy documents are updated. It notifies the PEP whenever the implied <em>authorization decision</em> changes.</p>

<p>When developing an application using SAPL or ABAC in general, the PDP and systems used by the PDP are usually well developed and only require the integration of domain-specific PIPs. A significant part of the effort in adopting the ABAC pattern lies in implementing the PEPs. Developing a PEP capable of flexible handling of decisions with constraints can become very complex. SAPL provides several libraries that make this process as unintrusive as possible and integrate deeply into the supported frameworks. This tutorial will teach you how to deploy PEPs in a Spring Boot application, securing a JPA repository as an example.</p>

<h2 id="project-setup">Project Setup</h2>

<p>First, you will implement a simple Spring Boot application. Go to Go to Spring Initializr and add the following dependencies to a project:</p>
<ul>
  <li>Web (to provide a REST API for testing your application)</li>
  <li>JPA (to develop the domain model of your application)</li>
  <li>H2 (as a simple in-memory database backing the application)</li>
  <li>Lombok (to eliminate some boilerplate code)</li>
</ul>

<p>Name your project template as you like. SAPL is compatible with Java 11 and above. So feel free to select your preferred version. For this tutorial, use Maven as your build tool and Java as the language.
Your Initializr settings should now look something like this:</p>

<p><img src="/assets/tutorial_01/spring_initializr.png" alt="Spring Initializr" /></p>

<p>Now click “GENERATE.” Your browser will download the project template as a “.zip” file.</p>

<p>Now unzip the project and import it into your preferred IDE.</p>

<h3 id="adding-sapl-dependencies">Adding SAPL Dependencies</h3>

<p>This tutorial uses the <code class="language-plaintext highlighter-rouge">2.1.0-SNAPSHOT</code> version of SAPL. For Maven to be able to download the respective libraries, add the central snapshot repository to your POM:</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="nt">&lt;repositories&gt;</span>
        <span class="nt">&lt;repository&gt;</span>
            <span class="nt">&lt;id&gt;</span>ossrh<span class="nt">&lt;/id&gt;</span>
            <span class="nt">&lt;url&gt;</span>https://s01.oss.sonatype.org/content/repositories/snapshots<span class="nt">&lt;/url&gt;</span>
            <span class="nt">&lt;snapshots&gt;</span>
                <span class="nt">&lt;enabled&gt;</span>true<span class="nt">&lt;/enabled&gt;</span>
            <span class="nt">&lt;/snapshots&gt;</span>
        <span class="nt">&lt;/repository&gt;</span>
    <span class="nt">&lt;/repositories&gt;</span>
</code></pre></div></div>

<p>SAPL provides a bill of materials module, helping you to use compatible versions of SAPL modules. After adding the following to your POM, you do not need to declare the <code class="language-plaintext highlighter-rouge">&lt;version&gt;</code> of individual SAPL dependencies:</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="nt">&lt;dependencyManagement&gt;</span>
        <span class="nt">&lt;dependencies&gt;</span>
            <span class="nt">&lt;dependency&gt;</span>
                <span class="nt">&lt;groupId&gt;</span>io.sapl<span class="nt">&lt;/groupId&gt;</span>
                <span class="nt">&lt;artifactId&gt;</span>sapl-bom<span class="nt">&lt;/artifactId&gt;</span>
                <span class="nt">&lt;version&gt;</span>2.1.0-SNAPSHOT<span class="nt">&lt;/version&gt;</span>
                <span class="nt">&lt;type&gt;</span>pom<span class="nt">&lt;/type&gt;</span>
                <span class="nt">&lt;scope&gt;</span>import<span class="nt">&lt;/scope&gt;</span>
            <span class="nt">&lt;/dependency&gt;</span>
        <span class="nt">&lt;/dependencies&gt;</span>
    <span class="nt">&lt;/dependencyManagement&gt;</span>
</code></pre></div></div>

<p>To develop an application using SAPL, you need two components. First, you need a component for making authorization decisions, the so-called policy decision point (PDP). You may embed the PDP within your application or use a dedicated server application and delegate the decision-making to this remote service. This tutorial uses an embedded PDP making decisions locally based on policies stored in the application resources. Add the following dependency to your project:</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code>        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>io.sapl<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>sapl-spring-pdp-embedded<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>
</code></pre></div></div>

<p>SAPL provides deep integration with Spring Security. This integration enables simple deployment of policy enforcement points in Spring application using a declarative aspect-oriented programming style. Add the following dependency to your project:</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code>        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>io.sapl<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>sapl-spring-security<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>
</code></pre></div></div>

<p>Finally, create a new folder in the resources folder <code class="language-plaintext highlighter-rouge">src/main/resources</code> called <code class="language-plaintext highlighter-rouge">policies</code> and create a file called <code class="language-plaintext highlighter-rouge">pdp.json</code>:</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
    </span><span class="nl">"algorithm"</span><span class="p">:</span><span class="w"> </span><span class="s2">"DENY_UNLESS_PERMIT"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"variables"</span><span class="p">:</span><span class="w"> </span><span class="p">{}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>The <code class="language-plaintext highlighter-rouge">algorithm</code> property selects an algorithm used to resolve conflicting results from policy evaluation. In this case, the algorithm will ensure that the PDP always returns a <code class="language-plaintext highlighter-rouge">deny</code> decision if no policy evaluation returns an explicit <code class="language-plaintext highlighter-rouge">permit</code> decision. You can use the <code class="language-plaintext highlighter-rouge">variables</code> property to define environment variables, e.g., the configuration of policy information points (PIPs). All policies can access the content of these variables.</p>

<p>This file completes the basic setup of the Maven project. Next, we can begin with the implementation of the application.</p>

<p>You can get a demo project in this state from the <a href="https://github.com/heutelbeck/sapl-tutorial-01-spring/tree/d41d643a97d74abafedf2300d95fa3522fb8e538">GitHub repository for this tutorial</a>.</p>

<h2 id="the-project-domain">The Project Domain</h2>

<p>The application domain of this tutorial will be a library of books, where the books may only be seen and borrowed if the user has the minimum age indicated to be appropriate for the book. If you are already proficient with Spring, JPA, and Spring Security basics, you can skip this section and directly jump to <a href="#securing-a-service-method-with-sapl">Securing a Service Method with SAPL</a>.</p>

<h3 id="define-the-book-entity-and-repository">Define the Book Entity and Repository</h3>

<p>First, define a book entity. You can use project Lombok annotations to create getters, setters, and constructors as follows automatically:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Data</span>
<span class="nd">@Entity</span>
<span class="nd">@NoArgsConstructor</span>
<span class="nd">@AllArgsConstructor</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Book</span> <span class="o">{</span>
    <span class="nd">@Id</span>
    <span class="nc">Long</span> <span class="n">id</span><span class="o">;</span>
    <span class="nc">String</span> <span class="n">name</span><span class="o">;</span>
    <span class="nc">Integer</span> <span class="n">ageRating</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></div></div>

<p>Now define a matching repository interface. For now, only include a <code class="language-plaintext highlighter-rouge">findAll</code>, <code class="language-plaintext highlighter-rouge">findById</code>, and <code class="language-plaintext highlighter-rouge">save</code> method:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">BookRepository</span> <span class="o">{</span>
    <span class="nc">Iterable</span><span class="o">&lt;</span><span class="nc">Book</span><span class="o">&gt;</span> <span class="nf">findAll</span><span class="o">();</span>
    <span class="nc">Optional</span><span class="o">&lt;</span><span class="nc">Book</span><span class="o">&gt;</span> <span class="nf">findById</span><span class="o">(</span><span class="nc">Long</span> <span class="n">id</span><span class="o">);</span>
    <span class="nc">Book</span> <span class="nf">save</span><span class="o">(</span><span class="nc">Book</span> <span class="n">entity</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div></div>

<p>Also, define a matching repository bean to have Spring Data automatically instantiate a repository implementing your interface:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Repository</span>
<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">JpaBookRepository</span> <span class="kd">extends</span> <span class="nc">CrudRepository</span><span class="o">&lt;</span><span class="nc">Book</span><span class="o">,</span> <span class="nc">Long</span><span class="o">&gt;,</span> <span class="nc">BookRepository</span> <span class="o">{</span> <span class="o">}</span>
</code></pre></div></div>

<h3 id="expose-the-books-using-a-rest-controller">Expose the Books using a REST Controller</h3>

<p>To expose the books to the users, implement a simple REST controller. We use Lombok annotation to create a constructor taking the required beans as parameters for dependency injection of the repository implementation:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@RestController</span>
<span class="nd">@RequiredArgsConstructor</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">BookController</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">BookRepository</span> <span class="n">repository</span><span class="o">;</span>

    <span class="nd">@GetMapping</span><span class="o">(</span><span class="s">"/api/books"</span><span class="o">)</span>
    <span class="nc">Iterable</span><span class="o">&lt;</span><span class="nc">Book</span><span class="o">&gt;</span> <span class="nf">findAll</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">repository</span><span class="o">.</span><span class="na">findAll</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="nd">@GetMapping</span><span class="o">(</span><span class="s">"/api/books/{id}"</span><span class="o">)</span>
    <span class="nc">Optional</span><span class="o">&lt;</span><span class="nc">Book</span><span class="o">&gt;</span> <span class="nf">findById</span><span class="o">(</span><span class="nd">@PathVariable</span> <span class="nc">Long</span> <span class="n">id</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">repository</span><span class="o">.</span><span class="na">findById</span><span class="o">(</span><span class="n">id</span><span class="o">);</span>
    <span class="o">}</span>

<span class="o">}</span>
</code></pre></div></div>

<h3 id="create-a-custom-userdetails-implementation">Create a Custom <code class="language-plaintext highlighter-rouge">UserDetails</code> Implementation</h3>

<p>Now create a custom <code class="language-plaintext highlighter-rouge">UserDetails</code> implementation which contains the birthdate of the user:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@ToString</span><span class="o">(</span><span class="n">callSuper</span> <span class="o">=</span> <span class="kc">true</span><span class="o">)</span>
<span class="nd">@EqualsAndHashCode</span><span class="o">(</span><span class="n">callSuper</span> <span class="o">=</span> <span class="kc">true</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">LibraryUser</span> <span class="kd">extends</span> <span class="nc">User</span> <span class="kd">implements</span> <span class="nc">UserDetails</span> <span class="o">{</span>

    <span class="nd">@Getter</span>
    <span class="kd">private</span> <span class="nc">LocalDate</span> <span class="n">birthday</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">LibraryUser</span><span class="o">(</span><span class="nc">String</span> <span class="n">username</span><span class="o">,</span> <span class="nc">LocalDate</span> <span class="n">birthday</span><span class="o">,</span> <span class="nc">String</span> <span class="n">password</span><span class="o">)</span> <span class="o">{</span>
        <span class="kd">super</span><span class="o">(</span><span class="n">username</span><span class="o">,</span> <span class="n">password</span><span class="o">,</span> <span class="kc">true</span><span class="o">,</span> <span class="kc">true</span><span class="o">,</span> <span class="kc">true</span><span class="o">,</span> <span class="kc">true</span><span class="o">,</span> <span class="nc">List</span><span class="o">.</span><span class="na">of</span><span class="o">());</span>
        <span class="k">this</span><span class="o">.</span><span class="na">birthday</span><span class="o">=</span><span class="n">birthday</span><span class="o">;</span>
    <span class="o">}</span>

<span class="o">}</span>
</code></pre></div></div>

<p>To make sure the custom <code class="language-plaintext highlighter-rouge">UserDetails</code> class will end up in the security context, implement a custom <code class="language-plaintext highlighter-rouge">UserDetailsService</code>. If you omit this service, you will still be able to authenticate using <code class="language-plaintext highlighter-rouge">LibraryUser</code> users stored in a default Spring <code class="language-plaintext highlighter-rouge">InMemoryUserDetailsManager</code>. However, your principal will only contain a <code class="language-plaintext highlighter-rouge">User</code> object, and the <code class="language-plaintext highlighter-rouge">birthday</code> would be unavailable. So for the tutorial, implement a simple custom in-memory <code class="language-plaintext highlighter-rouge">UserDetailsService</code>:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Service</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">LibraryUserDetailsService</span> <span class="kd">implements</span> <span class="nc">UserDetailsService</span> <span class="o">{</span>

    <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">LibraryUser</span><span class="o">&gt;</span> <span class="n">users</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">HashMap</span><span class="o">&lt;&gt;();</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">load</span><span class="o">(</span><span class="nc">LibraryUser</span> <span class="n">user</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">users</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">user</span><span class="o">.</span><span class="na">getUsername</span><span class="o">(),</span> <span class="n">user</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="nc">UserDetails</span> <span class="nf">loadUserByUsername</span><span class="o">(</span><span class="nc">String</span> <span class="n">username</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">UsernameNotFoundException</span> <span class="o">{</span>
        <span class="kt">var</span> <span class="n">user</span> <span class="o">=</span> <span class="n">users</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">username</span><span class="o">);</span>
        <span class="k">if</span><span class="o">(</span><span class="n">user</span><span class="o">==</span><span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">UsernameNotFoundException</span><span class="o">(</span><span class="s">"User not found"</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="n">user</span><span class="o">;</span>
    <span class="o">}</span>

<span class="o">}</span>
</code></pre></div></div>

<h3 id="generate-test-data-and-test-users-on-application-startup">Generate Test-Data and Test-Users on Application Startup</h3>

<p>The default configuration with H2 and JPA will create a volatile in-memory database. Therefore, we want the system to contain some books and users each time the application starts. For this, create a <code class="language-plaintext highlighter-rouge">CommandLineRunner</code>. This class executes once the application context is loaded successfully:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Component</span>
<span class="nd">@RequiredArgsConstructor</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">DemoData</span> <span class="kd">implements</span> <span class="nc">CommandLineRunner</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">BookRepository</span> <span class="n">bookRepository</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">LibraryUserDetailsService</span> <span class="n">userDetailsService</span><span class="o">;</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">(</span><span class="nc">String</span><span class="o">...</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">bookRepository</span><span class="o">.</span><span class="na">save</span><span class="o">(</span><span class="k">new</span> <span class="nc">Book</span><span class="o">(</span><span class="mi">1L</span><span class="o">,</span> <span class="s">"Clifford: It's Pool Time!"</span><span class="o">,</span>                                  <span class="mi">0</span><span class="o">));</span>
        <span class="n">bookRepository</span><span class="o">.</span><span class="na">save</span><span class="o">(</span><span class="k">new</span> <span class="nc">Book</span><span class="o">(</span><span class="mi">2L</span><span class="o">,</span> <span class="s">"The Rescue Mission: (Pokemon: Kalos Reader #1)"</span><span class="o">,</span>             <span class="mi">4</span><span class="o">));</span>
        <span class="n">bookRepository</span><span class="o">.</span><span class="na">save</span><span class="o">(</span><span class="k">new</span> <span class="nc">Book</span><span class="o">(</span><span class="mi">3L</span><span class="o">,</span> <span class="s">"Dragonlance Chronicles Vol. 1: Dragons of Autumn Twilight"</span><span class="o">,</span>  <span class="mi">9</span><span class="o">));</span>
        <span class="n">bookRepository</span><span class="o">.</span><span class="na">save</span><span class="o">(</span><span class="k">new</span> <span class="nc">Book</span><span class="o">(</span><span class="mi">4L</span><span class="o">,</span> <span class="s">"The Three-Body Problem"</span><span class="o">,</span>                                    <span class="mi">14</span><span class="o">));</span>

        <span class="n">userDetailsService</span><span class="o">.</span><span class="na">load</span><span class="o">(</span><span class="k">new</span> <span class="nc">LibraryUser</span><span class="o">(</span><span class="s">"zoe"</span><span class="o">,</span>     <span class="n">birthdayForAgeInYears</span><span class="o">(</span><span class="mi">17</span><span class="o">),</span> <span class="s">"{noop}password"</span><span class="o">));</span>
        <span class="n">userDetailsService</span><span class="o">.</span><span class="na">load</span><span class="o">(</span><span class="k">new</span> <span class="nc">LibraryUser</span><span class="o">(</span><span class="s">"bob"</span><span class="o">,</span>     <span class="n">birthdayForAgeInYears</span><span class="o">(</span><span class="mi">10</span><span class="o">),</span> <span class="s">"{noop}password"</span><span class="o">));</span>
        <span class="n">userDetailsService</span><span class="o">.</span><span class="na">load</span><span class="o">(</span><span class="k">new</span> <span class="nc">LibraryUser</span><span class="o">(</span><span class="s">"alice"</span><span class="o">,</span>   <span class="n">birthdayForAgeInYears</span><span class="o">(</span><span class="mi">3</span><span class="o">),</span>  <span class="s">"{noop}password"</span><span class="o">));</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="nc">LocalDate</span> <span class="nf">birthdayForAgeInYears</span><span class="o">(</span><span class="kt">int</span> <span class="n">age</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="nc">LocalDate</span><span class="o">.</span><span class="na">now</span><span class="o">().</span><span class="na">minusYears</span><span class="o">(</span><span class="n">age</span><span class="o">).</span><span class="na">minusDays</span><span class="o">(</span><span class="mi">20</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>The application domain is complete, and you can test the application. Run it by executing <code class="language-plaintext highlighter-rouge">mvn spring-boot:run</code> on the command line or use the matching tools in your IDE. After the application starts, go to <code class="language-plaintext highlighter-rouge">http://localhost:8080/api/books</code>. The browser will forward you to the login page. Use one of the users above to log in. You will end up on an error page, as we have not set up forwarding after successful login. But we try to keep configuration to a minimum in this tutorial. You can go back to <code class="language-plaintext highlighter-rouge">http://localhost:8080/api/books</code>, and you should see a list of all books:</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">[</span><span class="w">
    </span><span class="p">{</span><span class="w">
        </span><span class="nl">"id"</span><span class="w">       </span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w">
        </span><span class="nl">"name"</span><span class="w">     </span><span class="p">:</span><span class="w"> </span><span class="s2">"Clifford: It's Pool Time!"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"ageRating"</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="p">{</span><span class="w">
        </span><span class="nl">"id"</span><span class="w">       </span><span class="p">:</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w">
        </span><span class="nl">"name"</span><span class="w">     </span><span class="p">:</span><span class="w"> </span><span class="s2">"The Rescue Mission: (Pokemon: Kalos Reader #1)"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"ageRating"</span><span class="p">:</span><span class="w"> </span><span class="mi">4</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="p">{</span><span class="w">
        </span><span class="nl">"id"</span><span class="w">       </span><span class="p">:</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span><span class="w">
        </span><span class="nl">"name"</span><span class="w">     </span><span class="p">:</span><span class="w"> </span><span class="s2">"Dragonlance Chronicles Vol. 1: Dragons of Autumn Twilight"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"ageRating"</span><span class="p">:</span><span class="w"> </span><span class="mi">9</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="p">{</span><span class="w">
        </span><span class="nl">"id"</span><span class="w">       </span><span class="p">:</span><span class="w"> </span><span class="mi">4</span><span class="p">,</span><span class="w">
        </span><span class="nl">"name"</span><span class="w">     </span><span class="p">:</span><span class="w"> </span><span class="s2">"The Three-Body Problem"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"ageRating"</span><span class="p">:</span><span class="w"> </span><span class="mi">14</span><span class="w">
    </span><span class="p">}</span><span class="w">
</span><span class="p">]</span><span class="w">
</span></code></pre></div></div>

<p>So far, this tutorial has not used any features of SAPL, and you just created a basic Spring Boot application. Note that we did not explicitly add any dependency on Spring Security. The SAPL Spring integration has a transitive dependency on Spring Security which activated it for the application.</p>

<p>You can get a demo project in this state from the <a href="https://github.com/heutelbeck/sapl-tutorial-01-spring/tree/0f937c9cecaa5eb44b1740b0caa7c247cbd24a2d">GitHub repository for this tutorial</a>.</p>

<h2 id="securing-repository-methods-with-sapl">Securing Repository Methods with SAPL</h2>

<h3 id="setting-up-method-security">Setting Up Method Security</h3>

<p>SAPL extends the Spring Security framework’s method security features. To activate SAPL’s method security, add the following configuration to the application:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Configuration</span>
<span class="nd">@EnableGlobalMethodSecurity</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">MethodSecurityConfiguration</span> <span class="kd">extends</span> <span class="nc">SaplMethodSecurityConfiguration</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="nf">MethodSecurityConfiguration</span><span class="o">(</span><span class="nc">ObjectFactory</span><span class="o">&lt;</span><span class="nc">PolicyDecisionPoint</span><span class="o">&gt;</span> <span class="n">pdpFactory</span><span class="o">,</span>
            <span class="nc">ObjectFactory</span><span class="o">&lt;</span><span class="nc">ConstraintEnforcementService</span><span class="o">&gt;</span> <span class="n">constraintHandlerFactory</span><span class="o">,</span>
            <span class="nc">ObjectFactory</span><span class="o">&lt;</span><span class="nc">ObjectMapper</span><span class="o">&gt;</span> <span class="n">objectMapperFactory</span><span class="o">,</span>
            <span class="nc">ObjectFactory</span><span class="o">&lt;</span><span class="nc">AuthorizationSubscriptionBuilderService</span><span class="o">&gt;</span> <span class="n">subscriptionBuilderFactory</span><span class="o">)</span> <span class="o">{</span>
        <span class="kd">super</span><span class="o">(</span><span class="n">pdpFactory</span><span class="o">,</span> <span class="n">constraintHandlerFactory</span><span class="o">,</span> <span class="n">objectMapperFactory</span><span class="o">,</span> <span class="n">subscriptionBuilderFactory</span><span class="o">);</span>
    <span class="o">}</span>

<span class="o">}</span>
</code></pre></div></div>

<h3 id="adding-the-first-pep">Adding the first PEP</h3>

<p>The SAPL Spring Boot integration uses annotations to add PEPs to methods and classes. As a first example, add the <code class="language-plaintext highlighter-rouge">@PreEnforce</code> annotation the <code class="language-plaintext highlighter-rouge">findById</code>method of the <code class="language-plaintext highlighter-rouge">BookRepository</code> interface:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">BookRepository</span> <span class="o">{</span>
    <span class="nc">Iterable</span><span class="o">&lt;</span><span class="nc">Book</span><span class="o">&gt;</span> <span class="nf">findAll</span><span class="o">();</span>

    <span class="nd">@PreEnforce</span>
    <span class="nc">Optional</span><span class="o">&lt;</span><span class="nc">Book</span><span class="o">&gt;</span> <span class="nf">findById</span><span class="o">(</span><span class="nc">Long</span> <span class="n">id</span><span class="o">);</span>

    <span class="nc">Book</span> <span class="nf">save</span><span class="o">(</span><span class="nc">Book</span> <span class="n">entity</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div></div>

<p>Also, add <code class="language-plaintext highlighter-rouge">logging.level.io.sapl=DEBUG</code> to your <code class="language-plaintext highlighter-rouge">application.properties</code> file. This property will provide some insights into what is happening during policy enforcement.</p>

<p>Restart the application, log in, and navigate to <a href="http://localhost:8080/api/books/1">http://localhost:8080/api/books/1</a>. 
You now should get an error page including the statement: <code class="language-plaintext highlighter-rouge">There was an unexpected error (type=Forbidden, status=403).</code></p>

<p>Inspect the console, and you will find out what happened behind the scenes. The logs should contain some statements similar to the following:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code> [nio-8080-exec-5] io.sapl.pdp.EmbeddedPolicyDecisionPoint  : - START DECISION: AuthorizationSubscription(subject={"authorities":[],"details":{"remoteAddress":"0:0:0:0:0:0:0:1","sessionId":"5065925D227E3E154C5C967C987A47E0"},"authenticated":true,"principal":{"username":"zoe","authorities":[],"accountNonExpired":true,"accountNonLocked":true,"credentialsNonExpired":true,"enabled":true,"birthday":"2005-07-11"},"name":"zoe"}, action={"http":{"characterEncoding":"UTF-8","protocol":"HTTP/1.1","scheme":"http","serverName":"localhost","serverPort":8080,"remoteAddress":"0:0:0:0:0:0:0:1","remoteHost":"0:0:0:0:0:0:0:1","remotePort":57231,"isSecure":false,"localName":"0:0:0:0:0:0:0:1","localAddress":"0:0:0:0:0:0:0:1","localPort":8080,"method":"GET","contextPath":"","requestedSessionId":"9AC851C0F24A51691A06BBA118E6E0D8","requestedURI":"/api/books/1","requestURL":"http://localhost:8080/api/books/1","servletPath":"/api/books/1","headers":{"host":["localhost:8080"],"connection":["keep-alive"],"sec-ch-ua":["\".Not/A)Brand\";v=\"99\", \"Google Chrome\";v=\"103\", \"Chromium\";v=\"103\""],"sec-ch-ua-mobile":["?0"],"sec-ch-ua-platform":["\"Windows\""],"dnt":["1"],"upgrade-insecure-requests":["1"],"user-agent":["Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/103.0.0.0 Safari/537.36"],"accept":["text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9"],"sec-fetch-site":["none"],"sec-fetch-mode":["navigate"],"sec-fetch-user":["?1"],"sec-fetch-dest":["document"],"accept-encoding":["gzip, deflate, br"],"accept-language":["de-DE,de;q=0.9,en;q=0.8,en-US;q=0.7,pt;q=0.6"]},"cookies":[{"name":"JSESSIONID","value":"9AC851C0F24A51691A06BBA118E6E0D8"}],"locale":"de_DE","locales":["de_DE","de","en","en_US","pt"]},"java":{"name":"findById","declaringTypeName":"io.sapl.tutorial.domain.BookRepository","modifiers":["public"],"instanceof":[{"name":"jdk.proxy3.$Proxy112","simpleName":"$Proxy112"},{"name":"io.sapl.tutorial.domain.JpaBookRepository","simpleName":"JpaBookRepository"},{"name":"org.springframework.data.repository.CrudRepository","simpleName":"CrudRepository"},{"name":"org.springframework.data.repository.Repository","simpleName":"Repository"},{"name":"io.sapl.tutorial.domain.BookRepository","simpleName":"BookRepository"},{"name":"org.springframework.data.repository.Repository","simpleName":"Repository"},{"name":"org.springframework.transaction.interceptor.TransactionalProxy","simpleName":"TransactionalProxy"},{"name":"org.springframework.aop.SpringProxy","simpleName":"SpringProxy"},{"name":"org.springframework.aop.framework.Advised","simpleName":"Advised"},{"name":"org.springframework.aop.TargetClassAware","simpleName":"TargetClassAware"},{"name":"org.springframework.core.DecoratingProxy","simpleName":"DecoratingProxy"},{"name":"java.lang.reflect.Proxy","simpleName":"Proxy"},{"name":"java.io.Serializable","simpleName":"Serializable"},{"name":"java.lang.Object","simpleName":"Object"}],"arguments":[1]}}, resource={"http":{"characterEncoding":"UTF-8","protocol":"HTTP/1.1","scheme":"http","serverName":"localhost","serverPort":8080,"remoteAddress":"0:0:0:0:0:0:0:1","remoteHost":"0:0:0:0:0:0:0:1","remotePort":57231,"isSecure":false,"localName":"0:0:0:0:0:0:0:1","localAddress":"0:0:0:0:0:0:0:1","localPort":8080,"method":"GET","contextPath":"","requestedSessionId":"9AC851C0F24A51691A06BBA118E6E0D8","requestedURI":"/api/books/1","requestURL":"http://localhost:8080/api/books/1","servletPath":"/api/books/1","headers":{"host":["localhost:8080"],"connection":["keep-alive"],"sec-ch-ua":["\".Not/A)Brand\";v=\"99\", \"Google Chrome\";v=\"103\", \"Chromium\";v=\"103\""],"sec-ch-ua-mobile":["?0"],"sec-ch-ua-platform":["\"Windows\""],"dnt":["1"],"upgrade-insecure-requests":["1"],"user-agent":["Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/103.0.0.0 Safari/537.36"],"accept":["text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9"],"sec-fetch-site":["none"],"sec-fetch-mode":["navigate"],"sec-fetch-user":["?1"],"sec-fetch-dest":["document"],"accept-encoding":["gzip, deflate, br"],"accept-language":["de-DE,de;q=0.9,en;q=0.8,en-US;q=0.7,pt;q=0.6"]},"cookies":[{"name":"JSESSIONID","value":"9AC851C0F24A51691A06BBA118E6E0D8"}],"locale":"de_DE","locales":["de_DE","de","en","en_US","pt"]},"java":{"name":"findById","declaringTypeName":"io.sapl.tutorial.domain.BookRepository","modifiers":["public"],"instanceof":[{"name":"jdk.proxy3.$Proxy112","simpleName":"$Proxy112"},{"name":"io.sapl.tutorial.domain.JpaBookRepository","simpleName":"JpaBookRepository"},{"name":"org.springframework.data.repository.CrudRepository","simpleName":"CrudRepository"},{"name":"org.springframework.data.repository.Repository","simpleName":"Repository"},{"name":"io.sapl.tutorial.domain.BookRepository","simpleName":"BookRepository"},{"name":"org.springframework.data.repository.Repository","simpleName":"Repository"},{"name":"org.springframework.transaction.interceptor.TransactionalProxy","simpleName":"TransactionalProxy"},{"name":"org.springframework.aop.SpringProxy","simpleName":"SpringProxy"},{"name":"org.springframework.aop.framework.Advised","simpleName":"Advised"},{"name":"org.springframework.aop.TargetClassAware","simpleName":"TargetClassAware"},{"name":"org.springframework.core.DecoratingProxy","simpleName":"DecoratingProxy"},{"name":"java.lang.reflect.Proxy","simpleName":"Proxy"},{"name":"java.io.Serializable","simpleName":"Serializable"},{"name":"java.lang.Object","simpleName":"Object"}]}}, environment=null)
 [nio-8080-exec-1] nericInMemoryIndexedPolicyRetrievalPoint :   |- Matching documents: NONE
 [nio-8080-exec-1] s.s.m.b.PreEnforcePolicyEnforcementPoint : AuthzDecision    : AuthorizationDecision(decision=DENY, resource=Optional.empty, obligations=Optional.empty, advice=Optional.empty)

</code></pre></div></div>

<p>The first log entry states that the PDP is starting the decision-making process for an authorization subscription. The subscription is not very readable this way. Let us apply some formatting to the JSON data to unpack what the subscription object:</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
    </span><span class="nl">"subject"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"name"</span><span class="p">:</span><span class="s2">"zoe"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"authorities"</span><span class="p">:[],</span><span class="w">
        </span><span class="nl">"authenticated"</span><span class="p">:</span><span class="kc">true</span><span class="p">,</span><span class="w">
        </span><span class="nl">"details"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
            </span><span class="nl">"remoteAddress"</span><span class="p">:</span><span class="s2">"0:0:0:0:0:0:0:1"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"sessionId"</span><span class="p">:</span><span class="s2">"3EB8C81E289D18BC471DD7EDFD3A22B0"</span><span class="w">
        </span><span class="p">},</span><span class="w">
        </span><span class="nl">"principal"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
            </span><span class="nl">"username"</span><span class="p">:</span><span class="s2">"zoe"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"authorities"</span><span class="p">:[],</span><span class="w">
            </span><span class="nl">"accountNonExpired"</span><span class="p">:</span><span class="kc">true</span><span class="p">,</span><span class="w">
            </span><span class="nl">"accountNonLocked"</span><span class="p">:</span><span class="kc">true</span><span class="p">,</span><span class="w">
            </span><span class="nl">"credentialsNonExpired"</span><span class="p">:</span><span class="kc">true</span><span class="p">,</span><span class="w">
            </span><span class="nl">"enabled"</span><span class="p">:</span><span class="kc">true</span><span class="p">,</span><span class="w">
            </span><span class="nl">"birthday"</span><span class="p">:</span><span class="s2">"2005-07-11"</span><span class="w">
        </span><span class="p">}</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="nl">"action"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"http"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
            </span><span class="nl">"method"</span><span class="p">:</span><span class="s2">"GET"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"contextPath"</span><span class="p">:</span><span class="s2">""</span><span class="p">,</span><span class="w">
            </span><span class="nl">"requestedURI"</span><span class="p">:</span><span class="s2">"/api/books/1"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"requestURL"</span><span class="p">:</span><span class="s2">"http://localhost:8080/api/books/1"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"servletPath"</span><span class="p">:</span><span class="s2">"/api/books/1"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"characterEncoding"</span><span class="p">:</span><span class="s2">"UTF-8"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"protocol"</span><span class="p">:</span><span class="s2">"HTTP/1.1"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"scheme"</span><span class="p">:</span><span class="s2">"http"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"serverName"</span><span class="p">:</span><span class="s2">"localhost"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"serverPort"</span><span class="p">:</span><span class="mi">8080</span><span class="p">,</span><span class="w">
            </span><span class="nl">"remoteAddress"</span><span class="p">:</span><span class="s2">"0:0:0:0:0:0:0:1"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"remoteHost"</span><span class="p">:</span><span class="s2">"0:0:0:0:0:0:0:1"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"remotePort"</span><span class="p">:</span><span class="mi">61476</span><span class="p">,</span><span class="w">
            </span><span class="nl">"isSecure"</span><span class="p">:</span><span class="kc">false</span><span class="p">,</span><span class="w">
            </span><span class="nl">"localName"</span><span class="p">:</span><span class="s2">"0:0:0:0:0:0:0:1"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"localAddress"</span><span class="p">:</span><span class="s2">"0:0:0:0:0:0:0:1"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"localPort"</span><span class="p">:</span><span class="mi">8080</span><span class="p">,</span><span class="w">
            </span><span class="nl">"requestedSessionId"</span><span class="p">:</span><span class="s2">"F19999E939334243AA01EDED24EA7EBB"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"headers"</span><span class="p">:{</span><span class="w">
                </span><span class="nl">"host"</span><span class="p">:[</span><span class="s2">"localhost:8080"</span><span class="p">],</span><span class="w">
                </span><span class="nl">"connection"</span><span class="p">:[</span><span class="s2">"keep-alive"</span><span class="p">],</span><span class="w">
                </span><span class="nl">"cache-control"</span><span class="p">:[</span><span class="s2">"max-age=0"</span><span class="p">],</span><span class="w">
                </span><span class="nl">"sec-ch-ua"</span><span class="p">:[</span><span class="s2">"</span><span class="se">\"</span><span class="s2">.Not/A)Brand</span><span class="se">\"</span><span class="s2">;v=</span><span class="se">\"</span><span class="s2">99</span><span class="se">\"</span><span class="s2">, </span><span class="se">\"</span><span class="s2">Google Chrome</span><span class="se">\"</span><span class="s2">;v=</span><span class="se">\"</span><span class="s2">103</span><span class="se">\"</span><span class="s2">, </span><span class="se">\"</span><span class="s2">Chromium</span><span class="se">\"</span><span class="s2">;v=</span><span class="se">\"</span><span class="s2">103</span><span class="se">\"</span><span class="s2">"</span><span class="p">],</span><span class="w">
                </span><span class="nl">"sec-ch-ua-mobile"</span><span class="p">:[</span><span class="s2">"?0"</span><span class="p">],</span><span class="w">
                </span><span class="nl">"sec-ch-ua-platform"</span><span class="p">:[</span><span class="s2">"</span><span class="se">\"</span><span class="s2">Windows</span><span class="se">\"</span><span class="s2">"</span><span class="p">],</span><span class="w">
                </span><span class="nl">"dnt"</span><span class="p">:[</span><span class="s2">"1"</span><span class="p">],</span><span class="w">
                </span><span class="nl">"upgrade-insecure-requests"</span><span class="p">:[</span><span class="s2">"1"</span><span class="p">],</span><span class="w">
                </span><span class="nl">"user-agent"</span><span class="p">:[</span><span class="s2">"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/103.0.0.0 Safari/537.36"</span><span class="p">],</span><span class="w">
                </span><span class="nl">"accept"</span><span class="p">:[</span><span class="s2">"text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9"</span><span class="p">],</span><span class="w">
                </span><span class="nl">"sec-fetch-site"</span><span class="p">:[</span><span class="s2">"none"</span><span class="p">],</span><span class="w">
                </span><span class="nl">"sec-fetch-mode"</span><span class="p">:[</span><span class="s2">"navigate"</span><span class="p">],</span><span class="w">
                </span><span class="nl">"sec-fetch-user"</span><span class="p">:[</span><span class="s2">"?1"</span><span class="p">],</span><span class="w">
                </span><span class="nl">"sec-fetch-dest"</span><span class="p">:[</span><span class="s2">"document"</span><span class="p">],</span><span class="w">
                </span><span class="nl">"accept-encoding"</span><span class="p">:[</span><span class="s2">"gzip, deflate, br"</span><span class="p">],</span><span class="w">
                </span><span class="nl">"accept-language"</span><span class="p">:[</span><span class="s2">"de-DE,de;q=0.9,en;q=0.8,en-US;q=0.7,pt;q=0.6"</span><span class="p">]</span><span class="w">
            </span><span class="p">},</span><span class="w">
            </span><span class="nl">"cookies"</span><span class="p">:[{</span><span class="nl">"name"</span><span class="p">:</span><span class="s2">"JSESSIONID"</span><span class="p">,</span><span class="nl">"value"</span><span class="p">:</span><span class="s2">"F19999E939334243AA01EDED24EA7EBB"</span><span class="p">}],</span><span class="w">
            </span><span class="nl">"locale"</span><span class="p">:</span><span class="s2">"de_DE"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"locales"</span><span class="p">:[</span><span class="s2">"de_DE"</span><span class="p">,</span><span class="s2">"de"</span><span class="p">,</span><span class="s2">"en"</span><span class="p">,</span><span class="s2">"en_US"</span><span class="p">,</span><span class="s2">"pt"</span><span class="p">]</span><span class="w">
        </span><span class="p">},</span><span class="w">
        </span><span class="nl">"java"</span><span class="p">:{</span><span class="w">
            </span><span class="nl">"name"</span><span class="p">:</span><span class="s2">"findById"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"declaringTypeName"</span><span class="p">:</span><span class="s2">"io.sapl.tutorial.domain.BookRepository"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"modifiers"</span><span class="p">:[</span><span class="s2">"public"</span><span class="p">],</span><span class="w">
            </span><span class="nl">"arguments"</span><span class="p">:[</span><span class="mi">1</span><span class="p">],</span><span class="w">
            </span><span class="nl">"instanceof"</span><span class="p">:[</span><span class="w">
                </span><span class="p">{</span><span class="w"> </span><span class="nl">"name"</span><span class="p">:</span><span class="s2">"jdk.proxy10.$Proxy179"</span><span class="p">,</span><span class="w"> </span><span class="nl">"simpleName"</span><span class="p">:</span><span class="s2">"$Proxy179"</span><span class="w"> </span><span class="p">},</span><span class="w">
                </span><span class="p">{</span><span class="w"> </span><span class="nl">"name"</span><span class="p">:</span><span class="s2">"io.sapl.tutorial.domain.JpaBookRepository"</span><span class="p">,</span><span class="w"> </span><span class="nl">"simpleName"</span><span class="p">:</span><span class="s2">"JpaBookRepository"</span><span class="w"> </span><span class="p">},</span><span class="w">
                </span><span class="p">{</span><span class="w"> </span><span class="nl">"name"</span><span class="p">:</span><span class="s2">"org.springframework.data.repository.CrudRepository"</span><span class="p">,</span><span class="w"> </span><span class="nl">"simpleName"</span><span class="p">:</span><span class="s2">"CrudRepository"</span><span class="w"> </span><span class="p">},</span><span class="w">
                </span><span class="p">{</span><span class="w"> </span><span class="nl">"name"</span><span class="p">:</span><span class="s2">"org.springframework.data.repository.Repository"</span><span class="p">,</span><span class="w"> </span><span class="nl">"simpleName"</span><span class="p">:</span><span class="s2">"Repository"</span><span class="w"> </span><span class="p">},</span><span class="w">
                </span><span class="p">{</span><span class="w"> </span><span class="nl">"name"</span><span class="p">:</span><span class="s2">"io.sapl.tutorial.domain.BookRepository"</span><span class="p">,</span><span class="w"> </span><span class="nl">"simpleName"</span><span class="p">:</span><span class="s2">"BookRepository"</span><span class="w"> </span><span class="p">},</span><span class="w">
                </span><span class="p">{</span><span class="w"> </span><span class="nl">"name"</span><span class="p">:</span><span class="s2">"org.springframework.data.repository.Repository"</span><span class="p">,</span><span class="w"> </span><span class="nl">"simpleName"</span><span class="p">:</span><span class="s2">"Repository"</span><span class="w"> </span><span class="p">},</span><span class="w">
                </span><span class="p">{</span><span class="w"> </span><span class="nl">"name"</span><span class="p">:</span><span class="s2">"org.springframework.transaction.interceptor.TransactionalProxy"</span><span class="p">,</span><span class="w"> </span><span class="nl">"simpleName"</span><span class="p">:</span><span class="s2">"TransactionalProxy"</span><span class="w"> </span><span class="p">},</span><span class="w">
                </span><span class="p">{</span><span class="w"> </span><span class="nl">"name"</span><span class="p">:</span><span class="s2">"org.springframework.aop.SpringProxy"</span><span class="p">,</span><span class="w"> </span><span class="nl">"simpleName"</span><span class="p">:</span><span class="s2">"SpringProxy"</span><span class="w"> </span><span class="p">},</span><span class="w">
                </span><span class="p">{</span><span class="w"> </span><span class="nl">"name"</span><span class="p">:</span><span class="s2">"org.springframework.aop.framework.Advised"</span><span class="p">,</span><span class="w"> </span><span class="nl">"simpleName"</span><span class="p">:</span><span class="s2">"Advised"</span><span class="w"> </span><span class="p">},</span><span class="w">
                </span><span class="p">{</span><span class="w"> </span><span class="nl">"name"</span><span class="p">:</span><span class="s2">"org.springframework.aop.TargetClassAware"</span><span class="p">,</span><span class="w"> </span><span class="nl">"simpleName"</span><span class="p">:</span><span class="s2">"TargetClassAware"</span><span class="w"> </span><span class="p">},</span><span class="w">
                </span><span class="p">{</span><span class="w"> </span><span class="nl">"name"</span><span class="p">:</span><span class="s2">"org.springframework.core.DecoratingProxy"</span><span class="p">,</span><span class="w"> </span><span class="nl">"simpleName"</span><span class="p">:</span><span class="s2">"DecoratingProxy"</span><span class="w"> </span><span class="p">},</span><span class="w">
                </span><span class="p">{</span><span class="w"> </span><span class="nl">"name"</span><span class="p">:</span><span class="s2">"java.lang.reflect.Proxy"</span><span class="p">,</span><span class="w"> </span><span class="nl">"simpleName"</span><span class="p">:</span><span class="s2">"Proxy"</span><span class="w"> </span><span class="p">},</span><span class="w">
                </span><span class="p">{</span><span class="w"> </span><span class="nl">"name"</span><span class="p">:</span><span class="s2">"java.io.Serializable"</span><span class="p">,</span><span class="w"> </span><span class="nl">"simpleName"</span><span class="p">:</span><span class="s2">"Serializable"</span><span class="w"> </span><span class="p">},</span><span class="w">
                </span><span class="p">{</span><span class="w"> </span><span class="nl">"name"</span><span class="p">:</span><span class="s2">"java.lang.Object"</span><span class="p">,</span><span class="w"> </span><span class="nl">"simpleName"</span><span class="p">:</span><span class="s2">"Object"</span><span class="w"> </span><span class="p">}]</span><span class="w">
        </span><span class="p">}</span><span class="w">
    </span><span class="p">},</span><span class="w"> 
    </span><span class="nl">"resource"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"http"</span><span class="p">:{</span><span class="w">
            </span><span class="p">[</span><span class="err">...</span><span class="p">]</span><span class="w">
        </span><span class="p">},</span><span class="w">
        </span><span class="nl">"java"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> 
            </span><span class="p">[</span><span class="err">...</span><span class="p">]</span><span class="w">
        </span><span class="p">}</span><span class="w">
    </span><span class="p">},</span><span class="w"> 
    </span><span class="nl">"environment"</span><span class="p">:</span><span class="w"> </span><span class="kc">null</span><span class="w"> 
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>As you can see, without any specific configuration, the subscription is a massive object with significant redundancies. 
The reason for this is that the SPAL Engine and Spring integration do not have any domain knowledge regarding the application. 
Thus, the PEP gathers any information it can find that could reasonably describe the three required objects for an authorization subscription.</p>

<p>By default, the PEP attempts to marshall the <code class="language-plaintext highlighter-rouge">Authentication</code> object from Spring’s <code class="language-plaintext highlighter-rouge">SecurityContext</code> directly into a JSON object for the <code class="language-plaintext highlighter-rouge">subject</code>. 
This is a reasonable approach in most cases, and as you can see, <code class="language-plaintext highlighter-rouge">subject.principal.birthday</code> contains the data you defined earlier for
the custom <code class="language-plaintext highlighter-rouge">UserDetails</code> class is made available for the PDP.</p>

<p>The <code class="language-plaintext highlighter-rouge">action</code> and <code class="language-plaintext highlighter-rouge">resource</code> objects are almost identical. Consider where one can find information from the application context to describe these objects. 
Without any domain knowledge, the PEP can only gather technical information.</p>

<p>First, the PEP can consider the name of and types of the protected classes and methods to describe the action, e.g., the method name <code class="language-plaintext highlighter-rouge">findById</code> can be considered a  verb describing the action, and the argument <code class="language-plaintext highlighter-rouge">1</code> is an attribute of this action.
At the same time, the argument <code class="language-plaintext highlighter-rouge">1</code> can also be considered the resource’s id. 
What information about the PEP’s Java context is actually relevant is unknown to the PEP. 
Therefore, it adds all information it can gather to the action and resource.</p>

<p>Second, if the action happens in the context of a web application, often the application context contains an HTTP request. 
Again, this HTTP request can describe the action, e.g., the HTTP method GET, or the resource, e.g., the URL naturally identifies a resource.</p>

<p>This kind of subscription object is wasteful. Later, you will learn how to customize the subscription to be more compact and match your application domain. 
For now, we stick with the default configuration to progress quickly.</p>

<h3 id="storing-sapl-polices-for-an-embedded-pdp">Storing SAPL Polices for an Embedded PDP</h3>

<p>As you can see in the second line in the console log, the PDP did not find any policy document matching the authorization subscription, 
as we have not yet defined any policy for the application.
With an embedded PDP, policies can be stored alongside the application’s resources folder or somewhere on the host’s filesystem. 
The difference between these options is that with policies in the resources, once you have built and started the application, the policies are static at runtime. 
When using the filesystem, the PDP will actively monitor the folder and update its behavior accordingly when policies change at runtime.</p>

<p>As it is the default configuration of the embedded PDP, the application currently uses the first option to embed the policies in the resources.</p>

<p>The set of policy documents stored must adhere to some rules:</p>
<ul>
  <li>The SAPL PDP will only load documents that have the suffix <code class="language-plaintext highlighter-rouge">.sapl</code></li>
  <li>The documents may not have a byte order mark (to be updated in future versions)</li>
  <li>Each document contains exactly one policy or one policy set</li>
  <li>the top-level policy or policy set in all documents must have pairwise-different names</li>
  <li>All <code class="language-plaintext highlighter-rouge">.sapl</code> documents must be syntactically correct, or the PDP may fall back to a default decision determined by the algorithm given in the ```pdp.json`` configuration.</li>
</ul>

<h3 id="first-sapl-policies---permit-all-or-deny-all">First SAPL Policies - Permit All or Deny All</h3>

<p>The most basic policies are the policies to either permit or deny all actions without further inspection of any attributes.</p>

<p>Let us start with a “permit all” policy. Add a file <code class="language-plaintext highlighter-rouge">permit_all.sapl</code> to the <code class="language-plaintext highlighter-rouge">resources/policies</code> folder of the maven project with the following contents:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>policy "permit all" permit
</code></pre></div></div>

<p>The keyword <code class="language-plaintext highlighter-rouge">policy</code> indicates that the document contains a single policy, not a policy set. You will learn about policy sets later.
This keyword is always followed by the name of the SPAL document as a string, i.e., <code class="language-plaintext highlighter-rouge">"permit all"</code>. 
The name of a policy must always be followed by the <em>entitlement</em> which is either <code class="language-plaintext highlighter-rouge">permit</code> or <code class="language-plaintext highlighter-rouge">deny</code>.
The entitlement expresses which decision the PDP should return when all policy rules are satisfied. 
In this case, the policy does not have any rules. Therefore, all of its rules are satisfied, and the policy tells the PDP always to return a <code class="language-plaintext highlighter-rouge">permit</code>
decision, regardless of any details of the attributes contained in the authorization subscription or any external attributes from PIPs.
This kind of policy is dangerous and not very practical for production systems. However, it is helpful during development to be able 
to perform quick tests without authorization getting in the way.</p>

<p>Now restart the application, authenticate with any user and again try to access <a href="http://localhost:8080/api/books/1">http://localhost:8080/api/books/1</a>.</p>

<p>Now you should get the data for book 1:</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
    </span><span class="nl">"id"</span><span class="w">        </span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w">
    </span><span class="nl">"name"</span><span class="w">      </span><span class="p">:</span><span class="w"> </span><span class="s2">"Clifford: It's Pool Time!"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"ageRating"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>And your log should read like this:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code> nericInMemoryIndexedPolicyRetrievalPoint :   |- Matching documents:
 nericInMemoryIndexedPolicyRetrievalPoint :   |  * 'permit all'
 i.s.g.s.i.CombiningAlgorithmImplCustom   :   |- Evaluate: permit all 
 i.s.grammar.sapl.impl.PolicyImplCustom   :   |  |- Evaluate 'permit all'
 i.s.grammar.sapl.impl.PolicyImplCustom   :   |     |- PERMIT 'permit all': AuthorizationDecision(decision=PERMIT, resource=Optional.empty, obligations=Optional.empty, advice=Optional.empty)
 UnlessPermitCombiningAlgorithmImplCustom :   |- *PERMIT* Combined AuthorizationDecision(decision=PERMIT, resource=Optional.empty, obligations=Optional.empty, advice=Optional.empty)
 s.s.m.b.PreEnforcePolicyEnforcementPoint : AuthzDecision    : AuthorizationDecision(decision=PERMIT, resource=Optional.empty, obligations=Optional.empty, advice=Optional.empty)
</code></pre></div></div>

<p>In this log, you can see that the PRP identified the <code class="language-plaintext highlighter-rouge">'permit all'</code> policy document relevant for the authorization subscription. It proceeded to evaluate the document and, as expected, concluded that all rules are satisfied and that the decision indicated by the policy is <code class="language-plaintext highlighter-rouge">permit</code>. Finally, as this is the only matching document with a decision, the combining algorithm also concludes to return a <code class="language-plaintext highlighter-rouge">permit</code>. Therefore, the PEP allows access to the repository method.</p>

<p>Now, add a “deny all” policy. Add a file <code class="language-plaintext highlighter-rouge">deny_all.sapl</code> to the <code class="language-plaintext highlighter-rouge">resources/policies</code> folder of the maven project with the following contents:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>policy "deny all" deny
</code></pre></div></div>

<p>Now restart the application, authenticate with any user and again try to access <a href="http://localhost:8080/api/books/1">http://localhost:8080/api/books/1</a>.</p>

<p>The PDP will grant access, and the log will look similar to this:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code> nericInMemoryIndexedPolicyRetrievalPoint :   |- Matching documents:
 nericInMemoryIndexedPolicyRetrievalPoint :   |  * 'permit all'
 nericInMemoryIndexedPolicyRetrievalPoint :   |  * 'deny all'
 i.s.g.s.i.CombiningAlgorithmImplCustom   :   |- Evaluate: permit all 
 i.s.grammar.sapl.impl.PolicyImplCustom   :   |  |- Evaluate 'permit all'
 i.s.grammar.sapl.impl.PolicyImplCustom   :   |     |- PERMIT 'permit all': AuthorizationDecision(decision=PERMIT, resource=Optional.empty, obligations=Optional.empty, advice=Optional.empty)
 i.s.g.s.i.CombiningAlgorithmImplCustom   :   |- Evaluate: deny all 
 i.s.grammar.sapl.impl.PolicyImplCustom   :   |  |- Evaluate 'deny all'
 i.s.grammar.sapl.impl.PolicyImplCustom   :   |     |- DENY 'deny all': AuthorizationDecision(decision=DENY, resource=Optional.empty, obligations=Optional.empty, advice=Optional.empty)
 UnlessPermitCombiningAlgorithmImplCustom :   |- *PERMIT* Combined AuthorizationDecision(decision=PERMIT, resource=Optional.empty, obligations=Optional.empty, advice=Optional.empty)
 s.s.m.b.PreEnforcePolicyEnforcementPoint : AuthzDecision    : AuthorizationDecision(decision=PERMIT, resource=Optional.empty, obligations=Optional.empty, advice=Optional.empty)
</code></pre></div></div>

<p>Note that your system’s ordering of the log entries may be slightly different. The log indicates that both policies match the subscription and that the PDP evaluates them. Then the combining algorithm resolves the two decisions, i.e., one <code class="language-plaintext highlighter-rouge">permit</code> and one <code class="language-plaintext highlighter-rouge">deny</code>, to <code class="language-plaintext highlighter-rouge">permit</code>.</p>

<p>The PDP uses the combining algorithm selected in the <code class="language-plaintext highlighter-rouge">pdp.json</code> configuration file: <code class="language-plaintext highlighter-rouge">"algorithm": "DENY_UNLESS_PERMIT",</code>. 
This algorithm only returns <code class="language-plaintext highlighter-rouge">deny</code> if no <code class="language-plaintext highlighter-rouge">permit</code> is present. This algorithm is relatively permissive. The SAPL engine implements alternative algorithms to resolve the presence of different, potentially contradicting, decisions (also see <a href="/docs/2.1.0-SNAPSHOT/sapl-reference.html#combining-algorithm-2">SAPL Documentation - Combining Algorithm</a>). For the tutorial domain, select a more restrictive algorithm. Replace <code class="language-plaintext highlighter-rouge">DENY_UNLESS_PERMIT</code> in the configuration with <code class="language-plaintext highlighter-rouge">DENY_OVERRIDES</code>. This algorithm prioritizes <code class="language-plaintext highlighter-rouge">deny</code> decisions over <code class="language-plaintext highlighter-rouge">permit</code>.</p>

<p>Now restart the application, authenticate with any user and again try to access <a href="http://localhost:8080/api/books/1">http://localhost:8080/api/books/1</a>.</p>

<p>The application denies access and the log will look similar to this (remember, the line order may vary):</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code> nericInMemoryIndexedPolicyRetrievalPoint :   |- Matching documents:
 nericInMemoryIndexedPolicyRetrievalPoint :   |  * 'permit all'
 nericInMemoryIndexedPolicyRetrievalPoint :   |  * 'deny all'
 i.s.g.s.i.CombiningAlgorithmImplCustom   :   |- Evaluate: permit all 
 i.s.grammar.sapl.impl.PolicyImplCustom   :   |  |- Evaluate 'permit all'
 i.s.g.s.i.CombiningAlgorithmImplCustom   :   |- Evaluate: deny all 
 i.s.grammar.sapl.impl.PolicyImplCustom   :   |  |- Evaluate 'deny all'
 i.s.grammar.sapl.impl.PolicyImplCustom   :   |     |- PERMIT 'permit all': AuthorizationDecision(decision=PERMIT, resource=Optional.empty, obligations=Optional.empty, advice=Optional.empty)
 i.s.grammar.sapl.impl.PolicyImplCustom   :   |     |- DENY 'deny all': AuthorizationDecision(decision=DENY, resource=Optional.empty, obligations=Optional.empty, advice=Optional.empty)
 enyOverridesCombiningAlgorithmImplCustom :   | |-- DENY Combined AuthorizationDecision: AuthorizationDecision(decision=DENY, resource=Optional.empty, obligations=Optional.empty, advice=Optional.empty)
 s.s.m.b.PreEnforcePolicyEnforcementPoint :   AuthzDecision    : AuthorizationDecision(decision=DENY, resource=Optional.empty, obligations=Optional.empty, advice=Optional.empty)
</code></pre></div></div>

<p>As expected, the combining algorithm gave precedence to the <code class="language-plaintext highlighter-rouge">deny</code> decision.</p>

<p>Finally, rename <code class="language-plaintext highlighter-rouge">deny_all.sapl</code> to <code class="language-plaintext highlighter-rouge">deny_all.sapl.off</code> and <code class="language-plaintext highlighter-rouge">permit_all.sapl</code> to <code class="language-plaintext highlighter-rouge">permit_all.sapl.off</code>. Now access to the book should be denied, as the PDP only loads documents with the <code class="language-plaintext highlighter-rouge">.sapl</code>suffix.</p>

<p>The log now reads like this:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code> nericInMemoryIndexedPolicyRetrievalPoint :   |- Matching documents: NONE
 s.s.m.b.PreEnforcePolicyEnforcementPoint : AuthzDecision    : AuthorizationDecision(decision=NOT_APPLICABLE, resource=Optional.empty, obligations=Optional.empty, advice=Optional.empty)
</code></pre></div></div>

<p>The PDP returns <code class="language-plaintext highlighter-rouge">not applicable</code> because it did not find a document making a decision explicitly, and <code class="language-plaintext highlighter-rouge">deny-overrides</code> does not have a default decision. The PDP may also return <code class="language-plaintext highlighter-rouge">indeterminate</code> if an error occurred during policy evaluation. In both cases, a PEP must not grant access.</p>

<p>In this section, you learned how a PEP and PDP interact in SAPL and how the PDP combines outcomes of different policies. In the next step, you will learn how to write more practical policies and when precisely a policy is <em>applicable</em>, i.e., matches, for an authorization subscription.</p>

<h3 id="create-domain-specific-policies">Create Domain-Specific Policies</h3>

<p>In this step, you will build the application and configuration. You can also download the tutorial application in this stage from GitHub <a href="https://github.com/heutelbeck/sapl-tutorial-01-spring/tree/f7d636de156674c2a3e15dbbe6a1160c5217008b">here</a>.</p>

<p>First, add a PEP to the <code class="language-plaintext highlighter-rouge">findAll</code> method of the <code class="language-plaintext highlighter-rouge">BookRepository</code>:</p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">BookRepository</span> <span class="o">{</span>

    <span class="nd">@PreEnforce</span>
    <span class="nc">Iterable</span><span class="o">&lt;</span><span class="nc">Book</span><span class="o">&gt;</span> <span class="nf">findAll</span><span class="o">();</span>

    <span class="nd">@PreEnforce</span>
    <span class="nc">Optional</span><span class="o">&lt;</span><span class="nc">Book</span><span class="o">&gt;</span> <span class="nf">findById</span><span class="o">(</span><span class="nc">Long</span> <span class="n">id</span><span class="o">);</span>

    <span class="nc">Book</span> <span class="nf">save</span><span class="o">(</span><span class="nc">Book</span> <span class="n">entity</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div></div>

<p>Let us write a policy that states, “only bob may see individual book entries.” Note that this kind of statement is a requirement also called a <em>natural language policy (NLP)</em>. Create the policy document <code class="language-plaintext highlighter-rouge">permit_bob_for_books.sapl</code> in the policies folder of the resources. And translate the NLP to a SAPL policy document as follows:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>policy "only bob may see individual book entries"
permit action.java.name == "findById" &amp; action.java.declaringTypeName =~ ".*BookRepository$"
where
  subject.name == "bob";
</code></pre></div></div>

<p>Now restart, log in as Bob, and try to access <a href="http://localhost:8080/api/books/1">http://localhost:8080/api/books/1</a>.</p>

<p>Access will be granted and the log reads:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code> nericInMemoryIndexedPolicyRetrievalPoint :   |- Matching documents:
 nericInMemoryIndexedPolicyRetrievalPoint :   |  * 'only bob may see individual book entries'
 i.s.g.s.i.CombiningAlgorithmImplCustom   :   |- Evaluate: only bob may see individual book entries 
 i.s.grammar.sapl.impl.PolicyImplCustom   :   |  |- Evaluate 'only bob may see individual book entries'
 i.s.grammar.sapl.impl.PolicyImplCustom   :   |     |- PERMIT 'only bob may see individual book entries': AuthorizationDecision(decision=PERMIT, resource=Optional.empty, obligations=Optional.empty, advice=Optional.
 enyOverridesCombiningAlgorithmImplCustom : | |-- PERMIT Combined AuthorizationDecision: AuthorizationDecision(decision=PERMIT, resource=Optional.empty, obligations=Optional.empty, advice=Optional.empty)
 s.s.m.b.PreEnforcePolicyEnforcementPoint : AuthzDecision    : AuthorizationDecision(decision=PERMIT, resource=Optional.empty, obligations=Optional.empty, advice=Optional.empty)
</code></pre></div></div>

<p>Now access the list of books: <a href="http://localhost:8080/api/books">http://localhost:8080/api/books</a>.</p>

<p>The application grants access, and the log reads:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code> nericInMemoryIndexedPolicyRetrievalPoint :   |- Matching documents: NONE
 s.s.m.b.PreEnforcePolicyEnforcementPoint : AuthzDecision    : AuthorizationDecision(decision=NOT_APPLICABLE, resource=Optional.empty, obligations=Optional.empty, advice=Optional.empty)
</code></pre></div></div>

<p>Now go to <a href="http://localhost:8080/logout">http://localhost:8080/logout</a> and log out. Then log in as Zoe and try to access <a href="http://localhost:8080/api/books/1">http://localhost:8080/api/books/1</a>.</p>

<p>The application denies access, and the log reads:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code> nericInMemoryIndexedPolicyRetrievalPoint :   |- Matching documents:
 nericInMemoryIndexedPolicyRetrievalPoint :   |  * 'only bob may see individual book entries'
 i.s.g.s.i.CombiningAlgorithmImplCustom   :   |- Evaluate: only bob may see individual book entries 
 i.s.grammar.sapl.impl.PolicyImplCustom   :   |  |- Evaluate 'only bob may see individual book entries'
 i.s.grammar.sapl.impl.PolicyImplCustom   :   |     |- NOT_APPLICABLE 'only bob may see individual book entries': AuthorizationDecision(decision=NOT_APPLICABLE, resource=Optional.empty, obligations=Optional.empty, 
 enyOverridesCombiningAlgorithmImplCustom : | |-- NOT_APPLICABLE Combined AuthorizationDecision: AuthorizationDecision(decision=NOT_APPLICABLE, resource=Optional.empty, obligations=Optional.empty, advice=Optional.
 s.s.m.b.PreEnforcePolicyEnforcementPoint : AuthzDecision    : AuthorizationDecision(decision=NOT_APPLICABLE, resource=Optional.empty, obligations=Optional.empty, advice=Optional.empty)
</code></pre></div></div>

<p>As you can see, there are several differences in the decision-making process of the PDP. First, let us examine what leads to the fact that there are no applicable (matching) documents when accessing <code class="language-plaintext highlighter-rouge">/api/books</code>.</p>

<p>If you look at the policy, there is an expression following the entitlement <code class="language-plaintext highlighter-rouge">permit</code> that states <code class="language-plaintext highlighter-rouge">action.java.name == "findById" &amp; action.java.declaringTypeName =~ ".*BookRepository$"</code> and ends before the (optional) keyword <code class="language-plaintext highlighter-rouge">where</code>.
An expression at this position in a policy is called the <em>target expression</em>. 
The target expression is a rule which determines if the policy is applicable to a given authorization subscription. 
A policy is applicable if the expression evaluates to <code class="language-plaintext highlighter-rouge">true</code> for the given subscription. 
The PDP only evaluates applicable policies. 
As seen with the permit all example, if the target expression is missing, the policy is always considered applicable.
Also, the PDP only evaluates the remaining rules following the <code class="language-plaintext highlighter-rouge">where</code> keyword for applicable policies.</p>

<p>In this case, the target expression examines two attributes of the action. It validates, if <code class="language-plaintext highlighter-rouge">action.java.name</code> is equal to <code class="language-plaintext highlighter-rouge">"findById"</code> and if <code class="language-plaintext highlighter-rouge">action.java.declaringTypeName</code> matches the regular expression <code class="language-plaintext highlighter-rouge">".*BookRepository$"</code>, i.e., the attribute string ends with <code class="language-plaintext highlighter-rouge">BookRepository</code>, using the regex comparison operator <code class="language-plaintext highlighter-rouge">=~</code>.</p>

<p>These expressions explain why the PDP identified the policy as applicable in both cases attempting to access a single book. Still, it did not find an applicable policy when accessing the book collection.</p>

<p>Please note that SAPL distinguishes between lazy Boolean operators, i.e., <code class="language-plaintext highlighter-rouge">&amp;&amp;</code> and <code class="language-plaintext highlighter-rouge">||</code> for AND and OR, and eager Boolean operators <code class="language-plaintext highlighter-rouge">&amp;</code> and <code class="language-plaintext highlighter-rouge">|</code> respectively. Target expressions only allow eager operators, a requirement for efficient indexing of larger sets of policies.</p>

<p>The PDP evaluates the complete policy in the two cases where the user attempts to access the individual book, i.e., the rules following <code class="language-plaintext highlighter-rouge">where</code> are evaluated. This section of the policy is called the <strong>where block</strong>. 
The where contains an arbitrary number of rules. Each rule is a Boolean expression ending with a <code class="language-plaintext highlighter-rouge">;</code>. The where block as a whole evaluates to <code class="language-plaintext highlighter-rouge">true</code> when all of its rules evaluate to true. Rules are evaluated lazily from top to bottom.</p>

<p>In the situations above, the rule <code class="language-plaintext highlighter-rouge">subject.name == "bob";</code> is only <code class="language-plaintext highlighter-rouge">true</code> for the case where bob is accessing the book.</p>

<p>In this section, you have learned when a SAPL document is applicable, the purpose of the target expression, and what the where block of a policy is.</p>

<p>Next, you will learn how to customize the authorization subscription and use temporal functions to only grant access to age-appropriate books.</p>

<h3 id="enforce-the-age-rating-of-individual-books">Enforce the Age Rating of individual Books</h3>

<p>First, in preparation, deactivate all existing policies in your project by deleting or appending the <code class="language-plaintext highlighter-rouge">.off</code> suffix to the filename.</p>

<p>The goal of this section is only to grant access to books appropriate for the user’s age. To make this decision, the PDP needs the birthdate of the user (attribute of the subject), the age rating of the book (attribute of the resource), and the current date (attribute of the environment).
When you examine the authorization subscription sent in the previous examples, you will notice that only the user’s birth date is currently available in the subscription. How can we make the other attributes available for the PDP in the policies?</p>

<p>Generally, there are two potential sources for attributes: the authorization subscription or Policy Information Points (PIPs).</p>

<p>Consider the age rating of the book. This information is not known to the PEP before executing the query. Therefore, in the <code class="language-plaintext highlighter-rouge">BookRepository</code>, replace the <code class="language-plaintext highlighter-rouge">@PreEnforce</code> on <code class="language-plaintext highlighter-rouge">findById</code> with a <code class="language-plaintext highlighter-rouge">@PostEnforce</code> annotation as follows:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">BookRepository</span> <span class="o">{</span>
    
    <span class="nd">@PreEnforce</span>
    <span class="nc">Iterable</span><span class="o">&lt;</span><span class="nc">Book</span><span class="o">&gt;</span> <span class="nf">findAll</span><span class="o">();</span>

    <span class="nd">@PostEnforce</span><span class="o">(</span><span class="n">subject</span>  <span class="o">=</span> <span class="s">"authentication.getPrincipal()"</span><span class="o">,</span> 
                 <span class="n">action</span>   <span class="o">=</span> <span class="s">"'read book'"</span><span class="o">,</span> 
                 <span class="n">resource</span> <span class="o">=</span> <span class="s">"returnObject"</span><span class="o">)</span>
    <span class="nc">Optional</span><span class="o">&lt;</span><span class="nc">Book</span><span class="o">&gt;</span> <span class="nf">findById</span><span class="o">(</span><span class="nc">Long</span> <span class="n">id</span><span class="o">);</span>

    <span class="nc">Book</span> <span class="nf">save</span><span class="o">(</span><span class="nc">Book</span> <span class="n">entity</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div></div>

<p>This annotation does a couple of things:</p>
<ul>
  <li>First invoke the method.</li>
  <li>Construct a custom authorization subscription with <a href="https://docs.spring.io/spring-framework/docs/current/reference/html/core.html#expressions">Spring Expression Language (SpEL)</a>.</li>
  <li>Subscribe to the PDP with the custom authorization subscription.</li>
  <li>Enforce the decision.</li>
</ul>

<p>When we inspected the original automatically generated authorization subscription, you will remember that the resulting object was relatively large and technical. 
Here, the parameters of the <code class="language-plaintext highlighter-rouge">@PostEnforce</code> annotation help create a more domain-specific precise authorization subscription.</p>

<p>The parameter <code class="language-plaintext highlighter-rouge">subject = "authentication.getPrincipal()"</code> extracts the principal object from the authentication object and uses it as the subject-object in the subscription.</p>

<p>The parameter <code class="language-plaintext highlighter-rouge">action = "'read book'"</code> sets the action-object in the subscription to the string constant <code class="language-plaintext highlighter-rouge">read book</code>.</p>

<p>Finally, the parameter <code class="language-plaintext highlighter-rouge">resource = "returnObject"</code> sets the resource-object in the subscription to the method invocation result. 
As this resource is the book entity, it will automatically contain its <code class="language-plaintext highlighter-rouge">ageRating</code> attribute.</p>

<p>After identifying these objects, the PEP uses the <code class="language-plaintext highlighter-rouge">ObjectMapper</code> in the Spring application context to serialize the objects to JSON.</p>

<p>The resulting authorization subscription will look similar to this:</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
    </span><span class="nl">"subject"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"username"</span><span class="p">:</span><span class="w"> </span><span class="s2">"zoe"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"birthday"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2005-07-11"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"authorities"</span><span class="p">:</span><span class="w"> </span><span class="p">[],</span><span class="w">
        </span><span class="nl">"accountNonExpired"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w">
        </span><span class="nl">"accountNonLocked"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w">
        </span><span class="nl">"credentialsNonExpired"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w">
        </span><span class="nl">"enabled"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="nl">"action"</span><span class="p">:</span><span class="w"> </span><span class="s2">"read book"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"resource"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"id"</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w">
        </span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Clifford: It's Pool Time!"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"ageRating"</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="w">
    </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>This authorization subscription is much more manageable and practical than the automatic guesswork the Spring integration performs without any customization.</p>

<p>The policy we will write to enforce the book age restriction will introduce a number of new concepts:</p>
<ul>
  <li>definition of local attribute variables</li>
  <li>usage of policy information points</li>
  <li>function libraries</li>
  <li>logging for debugging policy information</li>
</ul>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>policy "check age" 
permit action == "read book"
where 
   var birthday    = log.infoSpy("birthday     : ", subject.birthday);
   var today       = log.infoSpy("today        : ", time.dateOf(|&lt;time.now&gt;));
   var age         = log.infoSpy("age          : ", time.timeBetween(birthday, today, "years"));
   var ageRating   = log.infoSpy("age rating   : ", resource.ageRating);
                     log.infoSpy("is older     : ", age &gt;= ageRating );
</code></pre></div></div>

<p>In its target expression, the policy <code class="language-plaintext highlighter-rouge">check age</code> scopes its applicability to all authorization subscriptions with the action <code class="language-plaintext highlighter-rouge">read book</code>.</p>

<p>In the first line of the <code class="language-plaintext highlighter-rouge">where</code> block, using the <code class="language-plaintext highlighter-rouge">var</code> keyword, the policy defines a local attribute variable named <code class="language-plaintext highlighter-rouge">birthday</code> and assigns it to the <code class="language-plaintext highlighter-rouge">subject.birthday</code> attribute. While doing so, the expression <code class="language-plaintext highlighter-rouge">subject.birthday</code> is wrapped in a function call. The function <code class="language-plaintext highlighter-rouge">log.infoSpy</code> is a utility function, logging its parameter to the console using the log level <code class="language-plaintext highlighter-rouge">INFO</code>. The function is the identity function with the logging as a side-effect. Similar functions exist for other log levels. The logging function library also contains functions like <code class="language-plaintext highlighter-rouge">log.debug</code>, without the <code class="language-plaintext highlighter-rouge">Spy</code> which logs their parameter and always returns <code class="language-plaintext highlighter-rouge">true</code>. These log functions can be used as single rule lines in a <code class="language-plaintext highlighter-rouge">where</code> block.</p>

<p>The second line of the <code class="language-plaintext highlighter-rouge">where</code> block assigns the current date to the variable <code class="language-plaintext highlighter-rouge">today</code>. 
In SAPL, angled brackets <code class="language-plaintext highlighter-rouge">&lt;ATTRIBUTE_IDENTIFIER&gt;</code> always denotes an attribute stream, a subscription to an external attribute source, using a Policy Information Point (PIP). 
In this case, the identifier <code class="language-plaintext highlighter-rouge">time.now</code> is used to access the current time in UTC from the system clock. 
In this scenario, we do not need the streaming nature of the time, and we are only interested in the first event in the attribute stream. Prepending the pipe symbol to the angled brackets <code class="language-plaintext highlighter-rouge">|&lt;&gt;</code> only takes the head element, i.e., the first event in the attribute stream, and then unsubscribes from the PIP. The time libraries in SAPL use ISO 8601 strings to represent time. The function <code class="language-plaintext highlighter-rouge">time.dateOF</code> is then used to extract the date component of the timestamp retrieved from the PIP.</p>

<p>Then, the policy calculates the subject’s age using the function <code class="language-plaintext highlighter-rouge">time.timeBetween</code>. And the <code class="language-plaintext highlighter-rouge">ageRating</code> of the book is stored in the matching variable.</p>

<p>Note that the engine evaluates variable assignment rules from top to bottom. And each rule has access to variables defined above it. Also, these assignment rules always evaluate to <code class="language-plaintext highlighter-rouge">true</code> unless an error occurs during evaluation.</p>

<p>Finally, the <code class="language-plaintext highlighter-rouge">age</code> is compared with the <code class="language-plaintext highlighter-rouge">ageRating</code> and the policy returns true if the subject’s age is above the book’s age rating.</p>

<p>For example, if you log in as Zoe and access the first book, the logs will read similar to this:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code> nericInMemoryIndexedPolicyRetrievalPoint :   |- Matching documents:
 nericInMemoryIndexedPolicyRetrievalPoint :   |  * 'check age'
 i.s.g.s.i.CombiningAlgorithmImplCustom   :   |- Evaluate: check age 
 i.s.grammar.sapl.impl.PolicyImplCustom   :   |  |- Evaluate 'check age'
 i.sapl.functions.LoggingFunctionLibrary  :   |     [LOG] birthday     :  "2005-07-11"
 i.sapl.functions.LoggingFunctionLibrary  :   |     [LOG] today        :  "2022-07-31"
 i.sapl.functions.LoggingFunctionLibrary  :   |     [LOG] age          :  17
 i.sapl.functions.LoggingFunctionLibrary  :   |     [LOG] age rating   :  0
 i.sapl.functions.LoggingFunctionLibrary  :   |     [LOG] is older     :  true
 i.s.grammar.sapl.impl.PolicyImplCustom   :   |     |- PERMIT 'check age': AuthorizationDecision(decision=PERMIT, resource=Optional.empty, obligations=Optional.empty, advice=Optional.empty)
 enyOverridesCombiningAlgorithmImplCustom : | |-- PERMIT Combined AuthorizationDecision: AuthorizationDecision(decision=PERMIT, resource=Optional.empty, obligations=Optional.empty, advice=Optional.empty)
</code></pre></div></div>

<p>However, if Alice attempts to access book four, access will be denied because the policy is not applicable, i.e., not all rules evaluate <code class="language-plaintext highlighter-rouge">true</code>:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code> nericInMemoryIndexedPolicyRetrievalPoint :   |- Matching documents:
 nericInMemoryIndexedPolicyRetrievalPoint :   |  * 'check age'
 i.s.g.s.i.CombiningAlgorithmImplCustom   :   |- Evaluate: check age 
 i.s.grammar.sapl.impl.PolicyImplCustom   :   |  |- Evaluate 'check age'
 i.sapl.functions.LoggingFunctionLibrary  :   |     [LOG] birthday     :  "2019-07-11"
 i.sapl.functions.LoggingFunctionLibrary  :   |     [LOG] today        :  "2022-07-31"
 i.sapl.functions.LoggingFunctionLibrary  :   |     [LOG] age          :  3
 i.sapl.functions.LoggingFunctionLibrary  :   |     [LOG] age rating   :  14
 i.sapl.functions.LoggingFunctionLibrary  :   |     [LOG] is older     :  false
 i.s.grammar.sapl.impl.PolicyImplCustom   :   |     |- NOT_APPLICABLE 'check age': AuthorizationDecision(decision=NOT_APPLICABLE, resource=Optional.empty, obligations=Optional.empty, advice=Optional.empty)
 enyOverridesCombiningAlgorithmImplCustom : | |-- NOT_APPLICABLE Combined AuthorizationDecision: AuthorizationDecision(decision=NOT_APPLICABLE, resource=Optional.empty, obligations=Optional.empty, advice=Optional.
</code></pre></div></div>

<p>The policy can be written more compact without logging and using an <code class="language-plaintext highlighter-rouge">import</code> statement:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>import time.*
policy "check age compact" 
permit action == "read book"
where 
   var age = timeBetween(subject.birthday, dateOf(|&lt;now&gt;), "years");
   age &gt;= resource.ageRating;
</code></pre></div></div>

<p>You can download a project version with the age enforcement in place from <a href="https://github.com/heutelbeck/sapl-tutorial-01-spring/tree/0e154a6a92765dad32882c0a5a082b344730c7d7">GitHub</a>.</p>

<h2 id="how-to-use-sapl-policies-to-transform-a-resource">How to use SAPL Policies to Transform a Resource?</h2>

<p>In this part of the tutorial, you will learn how to use policies to change the outcome of queries and how to trigger side effects using constraints.</p>

<p>To have some more data to work with, first, extend the domain model by adding some content to the books:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Data</span>
<span class="nd">@Entity</span>
<span class="nd">@NoArgsConstructor</span>
<span class="nd">@AllArgsConstructor</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Book</span> <span class="o">{</span>
    <span class="nd">@Id</span>
    <span class="nc">Long</span> <span class="n">id</span><span class="o">;</span>
    <span class="nc">String</span> <span class="n">name</span><span class="o">;</span>
    <span class="nc">Integer</span> <span class="n">ageRating</span><span class="o">;</span>
    <span class="nc">String</span> <span class="n">content</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></div></div>

<p>Also, extend the <code class="language-plaintext highlighter-rouge">DemoData</code> accordingly:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">bookRepository</span><span class="o">.</span><span class="na">save</span><span class="o">(</span><span class="k">new</span> <span class="nc">Book</span><span class="o">(</span><span class="mi">1L</span><span class="o">,</span> <span class="s">"Clifford: It's Pool Time!"</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="s">"*Woof*"</span><span class="o">));</span>
<span class="n">bookRepository</span><span class="o">.</span><span class="na">save</span><span class="o">(</span><span class="k">new</span> <span class="nc">Book</span><span class="o">(</span><span class="mi">2L</span><span class="o">,</span> <span class="s">"The Rescue Mission: (Pokemon: Kalos Reader #1)"</span><span class="o">,</span> <span class="mi">4</span><span class="o">,</span> <span class="s">"Gotta catch 'em all!"</span><span class="o">));</span>
<span class="n">bookRepository</span><span class="o">.</span><span class="na">save</span><span class="o">(</span><span class="k">new</span> <span class="nc">Book</span><span class="o">(</span><span class="mi">3L</span><span class="o">,</span> <span class="s">"Dragonlance Chronicles Vol. 1: Dragons of Autumn Twilight"</span><span class="o">,</span> <span class="mi">9</span><span class="o">,</span> <span class="s">"Some fantasy story."</span><span class="o">));</span>
<span class="n">bookRepository</span><span class="o">.</span><span class="na">save</span><span class="o">(</span><span class="k">new</span> <span class="nc">Book</span><span class="o">(</span><span class="mi">4L</span><span class="o">,</span> <span class="s">"The Three-Body Problem"</span><span class="o">,</span> <span class="mi">14</span><span class="o">,</span> <span class="s">"Space is scary."</span><span class="o">));</span>
</code></pre></div></div>

<p>We want to change the policies of the library in a way that users not meeting the age requirement do not get their access denied. 
Instead, only the contents of the book should be blackened. Add the following policy, <code class="language-plaintext highlighter-rouge">check_age_transform.sapl</code> to the application’s policies:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>import time.*
policy "check age transform" 
permit action == "read book"
where 
   var age = timeBetween(subject.birthday, dateOf(|&lt;now&gt;), "years");
   age &lt; resource.ageRating;
transform
   resource |- {
        @.content : filter.blacken(3,0,"\u2588")
   }
</code></pre></div></div>

<p>This policy introduces a new concept, i.e., the <code class="language-plaintext highlighter-rouge">transform</code> expression. 
If the policy is applicable, i.e., all rules evaluate to <code class="language-plaintext highlighter-rouge">true</code>, whatever 
JSON value the <code class="language-plaintext highlighter-rouge">transform</code> expression evaluates to is added to the authorization decision as the property <code class="language-plaintext highlighter-rouge">resource</code>.
The presence of a <code class="language-plaintext highlighter-rouge">resource</code> object instructs the PEP to replace the resource data with itself.</p>

<p>In this case, the so-called filter operator <code class="language-plaintext highlighter-rouge">|-</code> is applied to the resource object. 
The filter operator enables the selection of individual parts of a JSON value for manipulation, e.g., applying a function to the selected value. 
In this case, the operator selects the <code class="language-plaintext highlighter-rouge">content</code> key of the resource and replaces it with a version of its content, only exposing the three leftmost characters and replacing the rest with 
a black square (“\u2588” in Unicode). 
The selection expression is very powerful. 
Please refer to the <a href="/docs/2.1.0-SNAPSHOT/sapl-reference.html#filtering">SAPL Documentation</a> for a full explanation.</p>

<p>Ensure that the original age checking policy is still in place. Now, restart and log in as Alice.</p>

<p>When accessing <code class="language-plaintext highlighter-rouge">http://localhost:8080/api/books/1</code>, you will get:</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
    </span><span class="nl">"id"</span><span class="w">        </span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w">
    </span><span class="nl">"name"</span><span class="w">      </span><span class="p">:</span><span class="w"> </span><span class="s2">"Clifford: It's Pool Time!"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"ageRating"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w">
    </span><span class="nl">"content"</span><span class="w">   </span><span class="p">:</span><span class="w"> </span><span class="s2">"*Woof*"</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>But of course, because Alice is only three years old, the content of the age-inappropriate book <code class="language-plaintext highlighter-rouge">http://localhost:8080/api/books/4</code> will be blackened:</p>
<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
    </span><span class="nl">"id"</span><span class="w">        </span><span class="p">:</span><span class="w"> </span><span class="mi">4</span><span class="p">,</span><span class="w">
    </span><span class="nl">"name"</span><span class="w">      </span><span class="p">:</span><span class="w"> </span><span class="s2">"The Three-Body Problem"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"ageRating"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w">
    </span><span class="nl">"content"</span><span class="w">   </span><span class="p">:</span><span class="w"> </span><span class="s2">"Spa████████████"</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>The logs for this access attempt read as follows:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code> nericInMemoryIndexedPolicyRetrievalPoint :   |- Matching documents:
 nericInMemoryIndexedPolicyRetrievalPoint :   |  * 'check age compact'
 nericInMemoryIndexedPolicyRetrievalPoint :   |  * 'check age transform'
 i.s.g.s.i.CombiningAlgorithmImplCustom   :   |- Evaluate: check age compact 
 i.s.grammar.sapl.impl.PolicyImplCustom   :   |  |- Evaluate 'check age compact'
 i.s.g.s.i.CombiningAlgorithmImplCustom   :   |- Evaluate: check age transform 
 i.s.grammar.sapl.impl.PolicyImplCustom   :   |  |- Evaluate 'check age transform'
 i.s.grammar.sapl.impl.PolicyImplCustom   :   |     |- NOT_APPLICABLE 'check age compact': AuthorizationDecision(decision=NOT_APPLICABLE, resource=Optional.empty, obligations=Optional.empty, advice=Optional.empty)
 i.s.grammar.sapl.impl.PolicyImplCustom   :   |     |- PERMIT 'check age transform': AuthorizationDecision(decision=PERMIT, resource=Optional[{"id":4,"name":"The Three-Body Problem","ageRating":14,"content":"Spa████████████"}], obligations=Optional.empty, advice=Optional.empty)
 enyOverridesCombiningAlgorithmImplCustom : | |-- PERMIT Combined AuthorizationDecision: AuthorizationDecision(decision=PERMIT, resource=Optional[{"id":4,"name":"The Three-Body Problem","ageRating":14,"content":"Spa████████████"}], obligations=Optional.empty, advice=Optional.empty)
</code></pre></div></div>

<p>The PRP discovered both policies to be matching the subscription. 
The PDP starts to evaluate both, and the <code class="language-plaintext highlighter-rouge">check age compact</code> policy evaluates to <code class="language-plaintext highlighter-rouge">NOT_APPLICABLE</code>, because Alice is not old enough to read “The Three-Body Problem”. 
At the same time, the <code class="language-plaintext highlighter-rouge">check age transform</code> policy evaluates to <code class="language-plaintext highlighter-rouge">permit</code>. 
However, the authorization decision also contains a <code class="language-plaintext highlighter-rouge">resource</code> object. 
Thus, the PEP replaced the value returned by the modified <code class="language-plaintext highlighter-rouge">resource</code> object.</p>

<h2 id="how-to-enforce-obligations-and-advice-of-sapl-policies">How to enforce Obligations and Advice of SAPL Policies?</h2>

<p>The <code class="language-plaintext highlighter-rouge">transform</code> expression of SAPL policies is the first example of a policy that instructs the PEP to only grant access while enforcing the execution of additional instructions. SAPL calls this type of instruction <em>constraints</em>. SAPL supports three types of constraints:</p>
<ul>
  <li><em>obligations</em>, i.e., a mandatory constraint that the PEP must fulfill, i.e., the PEP must successfully execute the instruction, or else the PEP must deny access.</li>
  <li><em>advice</em>, i.e., am optional constraint that the PEP should fulfill, i.e., the PEP should make the best effort to execute the instruction. However, if it fails, access is still granted if the original decision was <code class="language-plaintext highlighter-rouge">permit</code>.</li>
  <li><em>resource replacement</em>, i.e., a special case of an obligation expressing that the PEP must replace the accessed resource with the data supplied in the authorization decision.</li>
</ul>

<p>An authorization decision containing a constraint expresses that the PEP must only grant (or deny) access when it can fulfill all obligations.</p>

<p>For example, any doctor may access a patient’s medical record in an emergency. However,  the system must log access if the doctor is not the attending doctor of the patient in question, triggering an audit process. Such a set of requirements is a so-called “breaking the glass scenario.”</p>

<p>In the library example, the system must log access to age-inappropriate books to let parents discuss the material later with their children.</p>

<p>To do so, modify the <code class="language-plaintext highlighter-rouge">check_age_transform.sapl</code> policy as follows:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>import time.*
policy "check age transform" 
permit action == "read book"
where 
   var age = timeBetween(subject.birthday, dateOf(|&lt;now&gt;), "years");
   age &lt; resource.ageRating;
obligation {
				"type": "logAccess",
				"message": "Attention, "+subject.username+" accessed the book '"+resource.name+"'."
           }
transform
   resource |- {
        @.content : filter.blacken(3,0,"\u2588")
   }
</code></pre></div></div>

<p>When logging in as Alice and attempting to access <code class="language-plaintext highlighter-rouge">http://localhost:8080/api/books/2</code>, access will be denied, and the logs look as follows:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>2022-08-02 01:09:05.780 DEBUG 80816 --- [nio-8080-exec-1] nericInMemoryIndexedPolicyRetrievalPoint :   |- Matching documents:
2022-08-02 01:09:05.780 DEBUG 80816 --- [nio-8080-exec-1] nericInMemoryIndexedPolicyRetrievalPoint :   |  * 'check age compact'
2022-08-02 01:09:05.780 DEBUG 80816 --- [nio-8080-exec-1] nericInMemoryIndexedPolicyRetrievalPoint :   |  * 'check age transform'
2022-08-02 01:09:05.780 DEBUG 80816 --- [nio-8080-exec-1] i.s.g.s.i.CombiningAlgorithmImplCustom   :   |- Evaluate: check age compact 
2022-08-02 01:09:05.780 DEBUG 80816 --- [nio-8080-exec-1] i.s.grammar.sapl.impl.PolicyImplCustom   :   |  |- Evaluate 'check age compact'
2022-08-02 01:09:05.780 DEBUG 80816 --- [nio-8080-exec-1] i.s.g.s.i.CombiningAlgorithmImplCustom   :   |- Evaluate: check age transform 
2022-08-02 01:09:05.780 DEBUG 80816 --- [nio-8080-exec-1] i.s.grammar.sapl.impl.PolicyImplCustom   :   |  |- Evaluate 'check age transform'
2022-08-02 01:09:05.781 DEBUG 80816 --- [nio-8080-exec-1] i.s.grammar.sapl.impl.PolicyImplCustom   :   |     |- NOT_APPLICABLE 'check age compact': AuthorizationDecision(decision=NOT_APPLICABLE, resource=Optional.empty, obligations=Optional.empty, advice=Optional.empty)
2022-08-02 01:09:05.782 DEBUG 80816 --- [nio-8080-exec-1] i.s.grammar.sapl.impl.PolicyImplCustom   :   |     |- PERMIT 'check age transform': AuthorizationDecision(decision=PERMIT, resource=Optional[{"id":2,"name":"The Rescue Mission: (Pokemon: Kalos Reader #1)","ageRating":4,"content":"Got█████████████████"}], obligations=Optional[[{"type":"logAccess","message":"Attention, alice accessed the book 'The Rescue Mission: (Pokemon: Kalos Reader #1)'."}]], advice=Optional.empty)
2022-08-02 01:09:05.782 DEBUG 80816 --- [nio-8080-exec-1] enyOverridesCombiningAlgorithmImplCustom : | |-- PERMIT Combined AuthorizationDecision: AuthorizationDecision(decision=PERMIT, resource=Optional[{"id":2,"name":"The Rescue Mission: (Pokemon: Kalos Reader #1)","ageRating":4,"content":"Got█████████████████"}], obligations=Optional[[{"type":"logAccess","message":"Attention, alice accessed the book 'The Rescue Mission: (Pokemon: Kalos Reader #1)'."}]], advice=Optional.empty)
2022-08-02 01:09:05.782 DEBUG 80816 --- [nio-8080-exec-1] .s.m.b.PostEnforcePolicyEnforcementPoint : AuthzDecision    : AuthorizationDecision(decision=PERMIT, resource=Optional[{"id":2,"name":"The Rescue Mission: (Pokemon: Kalos Reader #1)","ageRating":4,"content":"Got█████████████████"}], obligations=Optional[[{"type":"logAccess","message":"Attention, alice accessed the book 'The Rescue Mission: (Pokemon: Kalos Reader #1)'."}]], advice=Optional.empty)
</code></pre></div></div>

<p>The PDP communicated a <code class="language-plaintext highlighter-rouge">permit</code> decision containing the two constraints to replace the resource and log the console’s access. 
The PEP failed to enforce the logging obligation and thus denied access.</p>

<p>SAPL expresses constraints as arbitrary JSON objects. Also, SAPL does not know which constraints may be relevant in an application domain and how policies decide to describe them.</p>

<p>To support the logging obligation, implement a so-called <em>constraint handler provider</em>:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Slf4j</span>
<span class="nd">@Service</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">LoggingConstraintHandlerProvider</span> <span class="kd">implements</span> <span class="nc">RunnableConstraintHandlerProvider</span> <span class="o">{</span>

	<span class="nd">@Override</span>
	<span class="kd">public</span> <span class="nc">Signal</span> <span class="nf">getSignal</span><span class="o">()</span> <span class="o">{</span>
		<span class="k">return</span> <span class="nc">Signal</span><span class="o">.</span><span class="na">ON_DECISION</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="nd">@Override</span>
	<span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">isResponsible</span><span class="o">(</span><span class="nc">JsonNode</span> <span class="n">constraint</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">return</span> <span class="n">constraint</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">constraint</span><span class="o">.</span><span class="na">has</span><span class="o">(</span><span class="s">"type"</span><span class="o">)</span>
				<span class="o">&amp;&amp;</span> <span class="s">"logAccess"</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">constraint</span><span class="o">.</span><span class="na">findValue</span><span class="o">(</span><span class="s">"type"</span><span class="o">).</span><span class="na">asText</span><span class="o">());</span>
	<span class="o">}</span>

	<span class="nd">@Override</span>
	<span class="kd">public</span> <span class="nc">Runnable</span> <span class="nf">getHandler</span><span class="o">(</span><span class="nc">JsonNode</span> <span class="n">constraint</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">return</span> <span class="o">()</span> <span class="o">-&gt;</span> <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="n">constraint</span><span class="o">.</span><span class="na">findValue</span><span class="o">(</span><span class="s">"message"</span><span class="o">).</span><span class="na">asText</span><span class="o">());</span>

	<span class="o">}</span>

<span class="o">}</span>
</code></pre></div></div>

<p>The SAPL Spring integration offers different hooks in the execution path where applications can add constraint handlers. Depending on the annotation, and if the underlying method returns a value synchronously or uses reactive datatypes like <code class="language-plaintext highlighter-rouge">Flux&lt;&gt;</code> different hooks are available. 
For each of these hooks, the constraint handlers can influence the execution differently. E.g., for <code class="language-plaintext highlighter-rouge">@PreEnforce</code> the constraint handler may attempt to change the arguments handed over to the method. The different hooks map to interfaces a service bean can implement to provide the capability of enforcing different types of constraints. You can find a full list of the potential interfaces in the <a href="https://github.com/heutelbeck/sapl-policy-engine/tree/master/sapl-pep-api/src/main/java/io/sapl/spring/constraints/api"><code class="language-plaintext highlighter-rouge">sapl-pep-api</code> Module</a>.</p>

<p>In the case of logging, the constraint handler triggers a side-effect by logging the message contained in the obligation to the console. Therefore, the <code class="language-plaintext highlighter-rouge">RunnableConstraintHandlerProvider</code> is the appropriate service interface to implement. 
This interface requires three methods:</p>
<ul>
  <li><code class="language-plaintext highlighter-rouge">getSignal</code> returns when the <code class="language-plaintext highlighter-rouge">Runnable</code> should be executed. Here, the  PDP immediately executes the <code class="language-plaintext highlighter-rouge">Runnable</code>  after it receives the decision from the PDP. Most other signals are primarily relevant for reactive data types and are out of the scope of this tutorial.</li>
  <li><code class="language-plaintext highlighter-rouge">isResponsible</code> returns <code class="language-plaintext highlighter-rouge">true</code> if the handlers provided can fulfill the constraint.</li>
  <li><code class="language-plaintext highlighter-rouge">getHandler</code> returns the <code class="language-plaintext highlighter-rouge">Runnable</code> enforcing the constraint.</li>
</ul>

<p>When logging in as Alice and attempting to access <code class="language-plaintext highlighter-rouge">http://localhost:8080/api/books/2</code> access will be granted, and the logs now contain the following line:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[nio-8080-exec-1] i.s.t.s.LoggingConstraintHandlerProvider : Attention, alice accessed the book 'The Rescue Mission: (Pokemon: Kalos Reader #1)'.
</code></pre></div></div>

<p>You can download the demo project from the <a href="https://github.com/heutelbeck/sapl-tutorial-01-spring">GitHub repository for this tutorial</a>.</p>

<h2 id="conclusions">Conclusions</h2>

<p>In this tutorial series, you have learned the basics of attribute-based access control and how to secure a Spring application with SAPL.</p>

<p>You can achieve much more with SAPL, including deploying flexible distributed organization-wide authorization infrastructures.
The following tutorials in this series will focus on more complex obligations, testing, reactive data types, data streaming, customizing UIs 
based on policies and applications based on the Axon framework.</p>

<p>Feel free to engage with the developers and community on our <a href="https://discord.gg/pRXEVWm3xM">Discord Server</a>.</p>

  </div><a class="u-url" href="/tutorials/2022/08/04/tutorial_01_spring.html" hidden></a>
</article>

      </div>
    </main><footer class="site-footer h-card">
    <data class="u-url" href="/"></data> 
    <div class="wrapper">
      <p>SAPL is a powerful policy language and engine to implement Attribute-based access control (ABAC). It comes with developement tools for testing, authorization servers, authoring tools. Framework integrations are available for Spring, Axon, and Vaadin to provide flexible policy enforcement points (PEPs) in your application.</p>
      <p>
        <a href="/imprint">Imprint</a><br/>
        <a href="/privacy">Privacy Policy</a>
      </p>
    </div>  
</footer>
<script>
function addIframe(div) {
  var iframe = document.createElement("iframe");
  iframe.setAttribute(
    "src",
    "https://www.youtube-nocookie.com/embed/" + div.dataset.id + "?autoplay=1&rel=0"
  );
  iframe.setAttribute("frameborder", "0");
  iframe.setAttribute("allowfullscreen", "1");
  iframe.setAttribute(
    "allow",
    "accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture"
  );
  div.parentNode.replaceChild(iframe, div);
}

function initYouTubeVideos() {
  var playerElements = document.getElementsByClassName("youtube-player");
  for (var n = 0; n < playerElements.length; n++) {
    var videoId = playerElements[n].dataset.id;
    var div = document.createElement("div");
    div.setAttribute("data-id", videoId);
    var thumbNode = document.createElement("img");
    thumbNode.src = "https://i.ytimg.com/vi/ID/hqdefault.jpg".replace(
      "ID",
      videoId
    );
    div.appendChild(thumbNode);
    var playButton = document.createElement("div");
    playButton.setAttribute("class", "play");
    div.appendChild(playButton);
    div.onclick = function () {
      addIframe(this);
    };
    playerElements[n].appendChild(div);
  }
}

document.addEventListener("DOMContentLoaded", initYouTubeVideos);
</script></body>

</html>
