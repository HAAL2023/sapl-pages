<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<!--[if IE]><meta http-equiv="X-UA-Compatible" content="IE=edge"><![endif]-->
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 1.5.8">
<meta name="author" content="Dominic Heutelbeck">
<title>SAPL - Structure and Agency Policy Language</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700">
<style>
/* Asciidoctor default stylesheet | MIT License | http://asciidoctor.org */
/* Uncomment @import statement below to use as custom stylesheet */
/*@import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700";*/
article,aside,details,figcaption,figure,footer,header,hgroup,main,nav,section,summary{display:block}
audio,canvas,video{display:inline-block}
audio:not([controls]){display:none;height:0}
script{display:none!important}
html{font-family:sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}
a{background:transparent}
a:focus{outline:thin dotted}
a:active,a:hover{outline:0}
h1{font-size:2em;margin:.67em 0}
abbr[title]{border-bottom:1px dotted}
b,strong{font-weight:bold}
dfn{font-style:italic}
hr{-moz-box-sizing:content-box;box-sizing:content-box;height:0}
mark{background:#ff0;color:#000}
code,kbd,pre,samp{font-family:monospace;font-size:1em}
pre{white-space:pre-wrap}
q{quotes:"\201C" "\201D" "\2018" "\2019"}
small{font-size:80%}
sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}
sup{top:-.5em}
sub{bottom:-.25em}
img{border:0}
svg:not(:root){overflow:hidden}
figure{margin:0}
fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}
legend{border:0;padding:0}
button,input,select,textarea{font-family:inherit;font-size:100%;margin:0}
button,input{line-height:normal}
button,select{text-transform:none}
button,html input[type="button"],input[type="reset"],input[type="submit"]{-webkit-appearance:button;cursor:pointer}
button[disabled],html input[disabled]{cursor:default}
input[type="checkbox"],input[type="radio"]{box-sizing:border-box;padding:0}
button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}
textarea{overflow:auto;vertical-align:top}
table{border-collapse:collapse;border-spacing:0}
*,*::before,*::after{-moz-box-sizing:border-box;-webkit-box-sizing:border-box;box-sizing:border-box}
html,body{font-size:100%}
body{background:#fff;color:rgba(0,0,0,.8);padding:0;margin:0;font-family:"Noto Serif","DejaVu Serif",serif;font-weight:400;font-style:normal;line-height:1;position:relative;cursor:auto;tab-size:4;-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased}
a:hover{cursor:pointer}
img,object,embed{max-width:100%;height:auto}
object,embed{height:100%}
img{-ms-interpolation-mode:bicubic}
.left{float:left!important}
.right{float:right!important}
.text-left{text-align:left!important}
.text-right{text-align:right!important}
.text-center{text-align:center!important}
.text-justify{text-align:justify!important}
.hide{display:none}
img,object,svg{display:inline-block;vertical-align:middle}
textarea{height:auto;min-height:50px}
select{width:100%}
.center{margin-left:auto;margin-right:auto}
.stretch{width:100%}
.subheader,.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{line-height:1.45;color:#7a2518;font-weight:400;margin-top:0;margin-bottom:.25em}
div,dl,dt,dd,ul,ol,li,h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6,pre,form,p,blockquote,th,td{margin:0;padding:0;direction:ltr}
a{color:#2156a5;text-decoration:underline;line-height:inherit}
a:hover,a:focus{color:#1d4b8f}
a img{border:none}
p{font-family:inherit;font-weight:400;font-size:1em;line-height:1.6;margin-bottom:1.25em;text-rendering:optimizeLegibility}
p aside{font-size:.875em;line-height:1.35;font-style:italic}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{font-family:"Open Sans","DejaVu Sans",sans-serif;font-weight:300;font-style:normal;color:#ba3925;text-rendering:optimizeLegibility;margin-top:1em;margin-bottom:.5em;line-height:1.0125em}
h1 small,h2 small,h3 small,#toctitle small,.sidebarblock>.content>.title small,h4 small,h5 small,h6 small{font-size:60%;color:#e99b8f;line-height:0}
h1{font-size:2.125em}
h2{font-size:1.6875em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.375em}
h4,h5{font-size:1.125em}
h6{font-size:1em}
hr{border:solid #dddddf;border-width:1px 0 0;clear:both;margin:1.25em 0 1.1875em;height:0}
em,i{font-style:italic;line-height:inherit}
strong,b{font-weight:bold;line-height:inherit}
small{font-size:60%;line-height:inherit}
code{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;color:rgba(0,0,0,.9)}
ul,ol,dl{font-size:1em;line-height:1.6;margin-bottom:1.25em;list-style-position:outside;font-family:inherit}
ul,ol{margin-left:1.5em}
ul li ul,ul li ol{margin-left:1.25em;margin-bottom:0;font-size:1em}
ul.square li ul,ul.circle li ul,ul.disc li ul{list-style:inherit}
ul.square{list-style-type:square}
ul.circle{list-style-type:circle}
ul.disc{list-style-type:disc}
ol li ul,ol li ol{margin-left:1.25em;margin-bottom:0}
dl dt{margin-bottom:.3125em;font-weight:bold}
dl dd{margin-bottom:1.25em}
abbr,acronym{text-transform:uppercase;font-size:90%;color:rgba(0,0,0,.8);border-bottom:1px dotted #ddd;cursor:help}
abbr{text-transform:none}
blockquote{margin:0 0 1.25em;padding:.5625em 1.25em 0 1.1875em;border-left:1px solid #ddd}
blockquote cite{display:block;font-size:.9375em;color:rgba(0,0,0,.6)}
blockquote cite::before{content:"\2014 \0020"}
blockquote cite a,blockquote cite a:visited{color:rgba(0,0,0,.6)}
blockquote,blockquote p{line-height:1.6;color:rgba(0,0,0,.85)}
@media screen and (min-width:768px){h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2}
h1{font-size:2.75em}
h2{font-size:2.3125em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.6875em}
h4{font-size:1.4375em}}
table{background:#fff;margin-bottom:1.25em;border:solid 1px #dedede}
table thead,table tfoot{background:#f7f8f7}
table thead tr th,table thead tr td,table tfoot tr th,table tfoot tr td{padding:.5em .625em .625em;font-size:inherit;color:rgba(0,0,0,.8);text-align:left}
table tr th,table tr td{padding:.5625em .625em;font-size:inherit;color:rgba(0,0,0,.8)}
table tr.even,table tr.alt,table tr:nth-of-type(even){background:#f8f8f7}
table thead tr th,table tfoot tr th,table tbody tr td,table tr td,table tfoot tr td{display:table-cell;line-height:1.6}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2;word-spacing:-.05em}
h1 strong,h2 strong,h3 strong,#toctitle strong,.sidebarblock>.content>.title strong,h4 strong,h5 strong,h6 strong{font-weight:400}
.clearfix::before,.clearfix::after,.float-group::before,.float-group::after{content:" ";display:table}
.clearfix::after,.float-group::after{clear:both}
*:not(pre)>code{font-size:.9375em;font-style:normal!important;letter-spacing:0;padding:.1em .5ex;word-spacing:-.15em;background-color:#f7f7f8;-webkit-border-radius:4px;border-radius:4px;line-height:1.45;text-rendering:optimizeSpeed;word-wrap:break-word}
*:not(pre)>code.nobreak{word-wrap:normal}
*:not(pre)>code.nowrap{white-space:nowrap}
pre,pre>code{line-height:1.45;color:rgba(0,0,0,.9);font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;text-rendering:optimizeSpeed}
em em{font-style:normal}
strong strong{font-weight:400}
.keyseq{color:rgba(51,51,51,.8)}
kbd{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;display:inline-block;color:rgba(0,0,0,.8);font-size:.65em;line-height:1.45;background-color:#f7f7f7;border:1px solid #ccc;-webkit-border-radius:3px;border-radius:3px;-webkit-box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em white inset;box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em #fff inset;margin:0 .15em;padding:.2em .5em;vertical-align:middle;position:relative;top:-.1em;white-space:nowrap}
.keyseq kbd:first-child{margin-left:0}
.keyseq kbd:last-child{margin-right:0}
.menuseq,.menuref{color:#000}
.menuseq b:not(.caret),.menuref{font-weight:inherit}
.menuseq{word-spacing:-.02em}
.menuseq b.caret{font-size:1.25em;line-height:.8}
.menuseq i.caret{font-weight:bold;text-align:center;width:.45em}
b.button::before,b.button::after{position:relative;top:-1px;font-weight:400}
b.button::before{content:"[";padding:0 3px 0 2px}
b.button::after{content:"]";padding:0 2px 0 3px}
p a>code:hover{color:rgba(0,0,0,.9)}
#header,#content,#footnotes,#footer{width:100%;margin-left:auto;margin-right:auto;margin-top:0;margin-bottom:0;max-width:62.5em;*zoom:1;position:relative;padding-left:.9375em;padding-right:.9375em}
#header::before,#header::after,#content::before,#content::after,#footnotes::before,#footnotes::after,#footer::before,#footer::after{content:" ";display:table}
#header::after,#content::after,#footnotes::after,#footer::after{clear:both}
#content{margin-top:1.25em}
#content::before{content:none}
#header>h1:first-child{color:rgba(0,0,0,.85);margin-top:2.25rem;margin-bottom:0}
#header>h1:first-child+#toc{margin-top:8px;border-top:1px solid #dddddf}
#header>h1:only-child,body.toc2 #header>h1:nth-last-child(2){border-bottom:1px solid #dddddf;padding-bottom:8px}
#header .details{border-bottom:1px solid #dddddf;line-height:1.45;padding-top:.25em;padding-bottom:.25em;padding-left:.25em;color:rgba(0,0,0,.6);display:-ms-flexbox;display:-webkit-flex;display:flex;-ms-flex-flow:row wrap;-webkit-flex-flow:row wrap;flex-flow:row wrap}
#header .details span:first-child{margin-left:-.125em}
#header .details span.email a{color:rgba(0,0,0,.85)}
#header .details br{display:none}
#header .details br+span::before{content:"\00a0\2013\00a0"}
#header .details br+span.author::before{content:"\00a0\22c5\00a0";color:rgba(0,0,0,.85)}
#header .details br+span#revremark::before{content:"\00a0|\00a0"}
#header #revnumber{text-transform:capitalize}
#header #revnumber::after{content:"\00a0"}
#content>h1:first-child:not([class]){color:rgba(0,0,0,.85);border-bottom:1px solid #dddddf;padding-bottom:8px;margin-top:0;padding-top:1rem;margin-bottom:1.25rem}
#toc{border-bottom:1px solid #e7e7e9;padding-bottom:.5em}
#toc>ul{margin-left:.125em}
#toc ul.sectlevel0>li>a{font-style:italic}
#toc ul.sectlevel0 ul.sectlevel1{margin:.5em 0}
#toc ul{font-family:"Open Sans","DejaVu Sans",sans-serif;list-style-type:none}
#toc li{line-height:1.3334;margin-top:.3334em}
#toc a{text-decoration:none}
#toc a:active{text-decoration:underline}
#toctitle{color:#7a2518;font-size:1.2em}
@media screen and (min-width:768px){#toctitle{font-size:1.375em}
body.toc2{padding-left:15em;padding-right:0}
#toc.toc2{margin-top:0!important;background-color:#f8f8f7;position:fixed;width:15em;left:0;top:0;border-right:1px solid #e7e7e9;border-top-width:0!important;border-bottom-width:0!important;z-index:1000;padding:1.25em 1em;height:100%;overflow:auto}
#toc.toc2 #toctitle{margin-top:0;margin-bottom:.8rem;font-size:1.2em}
#toc.toc2>ul{font-size:.9em;margin-bottom:0}
#toc.toc2 ul ul{margin-left:0;padding-left:1em}
#toc.toc2 ul.sectlevel0 ul.sectlevel1{padding-left:0;margin-top:.5em;margin-bottom:.5em}
body.toc2.toc-right{padding-left:0;padding-right:15em}
body.toc2.toc-right #toc.toc2{border-right-width:0;border-left:1px solid #e7e7e9;left:auto;right:0}}
@media screen and (min-width:1280px){body.toc2{padding-left:20em;padding-right:0}
#toc.toc2{width:20em}
#toc.toc2 #toctitle{font-size:1.375em}
#toc.toc2>ul{font-size:.95em}
#toc.toc2 ul ul{padding-left:1.25em}
body.toc2.toc-right{padding-left:0;padding-right:20em}}
#content #toc{border-style:solid;border-width:1px;border-color:#e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;-webkit-border-radius:4px;border-radius:4px}
#content #toc>:first-child{margin-top:0}
#content #toc>:last-child{margin-bottom:0}
#footer{max-width:100%;background-color:rgba(0,0,0,.8);padding:1.25em}
#footer-text{color:rgba(255,255,255,.8);line-height:1.44}
#content{margin-bottom:.625em}
.sect1{padding-bottom:.625em}
@media screen and (min-width:768px){#content{margin-bottom:1.25em}
.sect1{padding-bottom:1.25em}}
.sect1:last-child{padding-bottom:0}
.sect1+.sect1{border-top:1px solid #e7e7e9}
#content h1>a.anchor,h2>a.anchor,h3>a.anchor,#toctitle>a.anchor,.sidebarblock>.content>.title>a.anchor,h4>a.anchor,h5>a.anchor,h6>a.anchor{position:absolute;z-index:1001;width:1.5ex;margin-left:-1.5ex;display:block;text-decoration:none!important;visibility:hidden;text-align:center;font-weight:400}
#content h1>a.anchor::before,h2>a.anchor::before,h3>a.anchor::before,#toctitle>a.anchor::before,.sidebarblock>.content>.title>a.anchor::before,h4>a.anchor::before,h5>a.anchor::before,h6>a.anchor::before{content:"\00A7";font-size:.85em;display:block;padding-top:.1em}
#content h1:hover>a.anchor,#content h1>a.anchor:hover,h2:hover>a.anchor,h2>a.anchor:hover,h3:hover>a.anchor,#toctitle:hover>a.anchor,.sidebarblock>.content>.title:hover>a.anchor,h3>a.anchor:hover,#toctitle>a.anchor:hover,.sidebarblock>.content>.title>a.anchor:hover,h4:hover>a.anchor,h4>a.anchor:hover,h5:hover>a.anchor,h5>a.anchor:hover,h6:hover>a.anchor,h6>a.anchor:hover{visibility:visible}
#content h1>a.link,h2>a.link,h3>a.link,#toctitle>a.link,.sidebarblock>.content>.title>a.link,h4>a.link,h5>a.link,h6>a.link{color:#ba3925;text-decoration:none}
#content h1>a.link:hover,h2>a.link:hover,h3>a.link:hover,#toctitle>a.link:hover,.sidebarblock>.content>.title>a.link:hover,h4>a.link:hover,h5>a.link:hover,h6>a.link:hover{color:#a53221}
.audioblock,.imageblock,.literalblock,.listingblock,.stemblock,.videoblock{margin-bottom:1.25em}
.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{text-rendering:optimizeLegibility;text-align:left;font-family:"Noto Serif","DejaVu Serif",serif;font-size:1rem;font-style:italic}
table.tableblock.fit-content>caption.title{white-space:nowrap;width:0}
.paragraph.lead>p,#preamble>.sectionbody>[class="paragraph"]:first-of-type p{font-size:1.21875em;line-height:1.6;color:rgba(0,0,0,.85)}
table.tableblock #preamble>.sectionbody>[class="paragraph"]:first-of-type p{font-size:inherit}
.admonitionblock>table{border-collapse:separate;border:0;background:none;width:100%}
.admonitionblock>table td.icon{text-align:center;width:80px}
.admonitionblock>table td.icon img{max-width:none}
.admonitionblock>table td.icon .title{font-weight:bold;font-family:"Open Sans","DejaVu Sans",sans-serif;text-transform:uppercase}
.admonitionblock>table td.content{padding-left:1.125em;padding-right:1.25em;border-left:1px solid #dddddf;color:rgba(0,0,0,.6)}
.admonitionblock>table td.content>:last-child>:last-child{margin-bottom:0}
.exampleblock>.content{border-style:solid;border-width:1px;border-color:#e6e6e6;margin-bottom:1.25em;padding:1.25em;background:#fff;-webkit-border-radius:4px;border-radius:4px}
.exampleblock>.content>:first-child{margin-top:0}
.exampleblock>.content>:last-child{margin-bottom:0}
.sidebarblock{border-style:solid;border-width:1px;border-color:#e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;-webkit-border-radius:4px;border-radius:4px}
.sidebarblock>:first-child{margin-top:0}
.sidebarblock>:last-child{margin-bottom:0}
.sidebarblock>.content>.title{color:#7a2518;margin-top:0;text-align:center}
.exampleblock>.content>:last-child>:last-child,.exampleblock>.content .olist>ol>li:last-child>:last-child,.exampleblock>.content .ulist>ul>li:last-child>:last-child,.exampleblock>.content .qlist>ol>li:last-child>:last-child,.sidebarblock>.content>:last-child>:last-child,.sidebarblock>.content .olist>ol>li:last-child>:last-child,.sidebarblock>.content .ulist>ul>li:last-child>:last-child,.sidebarblock>.content .qlist>ol>li:last-child>:last-child{margin-bottom:0}
.literalblock pre,.listingblock pre:not(.highlight),.listingblock pre[class="highlight"],.listingblock pre[class^="highlight "],.listingblock pre.CodeRay,.listingblock pre.prettyprint{background:#f7f7f8}
.sidebarblock .literalblock pre,.sidebarblock .listingblock pre:not(.highlight),.sidebarblock .listingblock pre[class="highlight"],.sidebarblock .listingblock pre[class^="highlight "],.sidebarblock .listingblock pre.CodeRay,.sidebarblock .listingblock pre.prettyprint{background:#f2f1f1}
.literalblock pre,.literalblock pre[class],.listingblock pre,.listingblock pre[class]{-webkit-border-radius:4px;border-radius:4px;word-wrap:break-word;overflow-x:auto;padding:1em;font-size:.8125em}
@media screen and (min-width:768px){.literalblock pre,.literalblock pre[class],.listingblock pre,.listingblock pre[class]{font-size:.90625em}}
@media screen and (min-width:1280px){.literalblock pre,.literalblock pre[class],.listingblock pre,.listingblock pre[class]{font-size:1em}}
.literalblock pre.nowrap,.literalblock pre.nowrap pre,.listingblock pre.nowrap,.listingblock pre.nowrap pre{white-space:pre;word-wrap:normal}
.literalblock.output pre{color:#f7f7f8;background-color:rgba(0,0,0,.9)}
.listingblock pre.highlightjs{padding:0}
.listingblock pre.highlightjs>code{padding:1em;-webkit-border-radius:4px;border-radius:4px}
.listingblock pre.prettyprint{border-width:0}
.listingblock>.content{position:relative}
.listingblock code[data-lang]::before{display:none;content:attr(data-lang);position:absolute;font-size:.75em;top:.425rem;right:.5rem;line-height:1;text-transform:uppercase;color:#999}
.listingblock:hover code[data-lang]::before{display:block}
.listingblock.terminal pre .command::before{content:attr(data-prompt);padding-right:.5em;color:#999}
.listingblock.terminal pre .command:not([data-prompt])::before{content:"$"}
table.pyhltable{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.pyhltable td{vertical-align:top;padding-top:0;padding-bottom:0;line-height:1.45}
table.pyhltable td.code{padding-left:.75em;padding-right:0}
pre.pygments .lineno,table.pyhltable td:not(.code){color:#999;padding-left:0;padding-right:.5em;border-right:1px solid #dddddf}
pre.pygments .lineno{display:inline-block;margin-right:.25em}
table.pyhltable .linenodiv{background:none!important;padding-right:0!important}
.quoteblock{margin:0 1em 1.25em 1.5em;display:table}
.quoteblock>.title{margin-left:-1.5em;margin-bottom:.75em}
.quoteblock blockquote,.quoteblock p{color:rgba(0,0,0,.85);font-size:1.15rem;line-height:1.75;word-spacing:.1em;letter-spacing:0;font-style:italic;text-align:justify}
.quoteblock blockquote{margin:0;padding:0;border:0}
.quoteblock blockquote::before{content:"\201c";float:left;font-size:2.75em;font-weight:bold;line-height:.6em;margin-left:-.6em;color:#7a2518;text-shadow:0 1px 2px rgba(0,0,0,.1)}
.quoteblock blockquote>.paragraph:last-child p{margin-bottom:0}
.quoteblock .attribution{margin-top:.75em;margin-right:.5ex;text-align:right}
.verseblock{margin:0 1em 1.25em}
.verseblock pre{font-family:"Open Sans","DejaVu Sans",sans;font-size:1.15rem;color:rgba(0,0,0,.85);font-weight:300;text-rendering:optimizeLegibility}
.verseblock pre strong{font-weight:400}
.verseblock .attribution{margin-top:1.25rem;margin-left:.5ex}
.quoteblock .attribution,.verseblock .attribution{font-size:.9375em;line-height:1.45;font-style:italic}
.quoteblock .attribution br,.verseblock .attribution br{display:none}
.quoteblock .attribution cite,.verseblock .attribution cite{display:block;letter-spacing:-.025em;color:rgba(0,0,0,.6)}
.quoteblock.abstract blockquote::before,.quoteblock.excerpt blockquote::before,.quoteblock .quoteblock blockquote::before{display:none}
.quoteblock.abstract blockquote,.quoteblock.abstract p,.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{line-height:1.6;word-spacing:0}
.quoteblock.abstract{margin:0 1em 1.25em;display:block}
.quoteblock.abstract>.title{margin:0 0 .375em;font-size:1.15em;text-align:center}
.quoteblock.excerpt,.quoteblock .quoteblock{margin:0 0 1.25em;padding:0 0 .25em 1em;border-left:.25em solid #dddddf}
.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{color:inherit;font-size:1.0625rem}
.quoteblock.excerpt .attribution,.quoteblock .quoteblock .attribution{color:inherit;text-align:left;margin-right:0}
table.tableblock{max-width:100%;border-collapse:separate}
p.tableblock:last-child{margin-bottom:0}
td.tableblock>.content{margin-bottom:-1.25em}
table.tableblock,th.tableblock,td.tableblock{border:0 solid #dedede}
table.grid-all>thead>tr>.tableblock,table.grid-all>tbody>tr>.tableblock{border-width:0 1px 1px 0}
table.grid-all>tfoot>tr>.tableblock{border-width:1px 1px 0 0}
table.grid-cols>*>tr>.tableblock{border-width:0 1px 0 0}
table.grid-rows>thead>tr>.tableblock,table.grid-rows>tbody>tr>.tableblock{border-width:0 0 1px}
table.grid-rows>tfoot>tr>.tableblock{border-width:1px 0 0}
table.grid-all>*>tr>.tableblock:last-child,table.grid-cols>*>tr>.tableblock:last-child{border-right-width:0}
table.grid-all>tbody>tr:last-child>.tableblock,table.grid-all>thead:last-child>tr>.tableblock,table.grid-rows>tbody>tr:last-child>.tableblock,table.grid-rows>thead:last-child>tr>.tableblock{border-bottom-width:0}
table.frame-all{border-width:1px}
table.frame-sides{border-width:0 1px}
table.frame-topbot,table.frame-ends{border-width:1px 0}
table.stripes-all tr,table.stripes-odd tr:nth-of-type(odd){background:#f8f8f7}
table.stripes-none tr,table.stripes-odd tr:nth-of-type(even){background:none}
th.halign-left,td.halign-left{text-align:left}
th.halign-right,td.halign-right{text-align:right}
th.halign-center,td.halign-center{text-align:center}
th.valign-top,td.valign-top{vertical-align:top}
th.valign-bottom,td.valign-bottom{vertical-align:bottom}
th.valign-middle,td.valign-middle{vertical-align:middle}
table thead th,table tfoot th{font-weight:bold}
tbody tr th{display:table-cell;line-height:1.6;background:#f7f8f7}
tbody tr th,tbody tr th p,tfoot tr th,tfoot tr th p{color:rgba(0,0,0,.8);font-weight:bold}
p.tableblock>code:only-child{background:none;padding:0}
p.tableblock{font-size:1em}
td>div.verse{white-space:pre}
ol{margin-left:1.75em}
ul li ol{margin-left:1.5em}
dl dd{margin-left:1.125em}
dl dd:last-child,dl dd:last-child>:last-child{margin-bottom:0}
ol>li p,ul>li p,ul dd,ol dd,.olist .olist,.ulist .ulist,.ulist .olist,.olist .ulist{margin-bottom:.625em}
ul.checklist,ul.none,ol.none,ul.no-bullet,ol.no-bullet,ol.unnumbered,ul.unstyled,ol.unstyled{list-style-type:none}
ul.no-bullet,ol.no-bullet,ol.unnumbered{margin-left:.625em}
ul.unstyled,ol.unstyled{margin-left:0}
ul.checklist{margin-left:.625em}
ul.checklist li>p:first-child>.fa-square-o:first-child,ul.checklist li>p:first-child>.fa-check-square-o:first-child{width:1.25em;font-size:.8em;position:relative;bottom:.125em}
ul.checklist li>p:first-child>input[type="checkbox"]:first-child{margin-right:.25em}
ul.inline{display:-ms-flexbox;display:-webkit-box;display:flex;-ms-flex-flow:row wrap;-webkit-flex-flow:row wrap;flex-flow:row wrap;list-style:none;margin:0 0 .625em -1.25em}
ul.inline>li{margin-left:1.25em}
.unstyled dl dt{font-weight:400;font-style:normal}
ol.arabic{list-style-type:decimal}
ol.decimal{list-style-type:decimal-leading-zero}
ol.loweralpha{list-style-type:lower-alpha}
ol.upperalpha{list-style-type:upper-alpha}
ol.lowerroman{list-style-type:lower-roman}
ol.upperroman{list-style-type:upper-roman}
ol.lowergreek{list-style-type:lower-greek}
.hdlist>table,.colist>table{border:0;background:none}
.hdlist>table>tbody>tr,.colist>table>tbody>tr{background:none}
td.hdlist1,td.hdlist2{vertical-align:top;padding:0 .625em}
td.hdlist1{font-weight:bold;padding-bottom:1.25em}
.literalblock+.colist,.listingblock+.colist{margin-top:-.5em}
.colist td:not([class]):first-child{padding:.4em .75em 0;line-height:1;vertical-align:top}
.colist td:not([class]):first-child img{max-width:none}
.colist td:not([class]):last-child{padding:.25em 0}
.thumb,.th{line-height:0;display:inline-block;border:solid 4px #fff;-webkit-box-shadow:0 0 0 1px #ddd;box-shadow:0 0 0 1px #ddd}
.imageblock.left{margin:.25em .625em 1.25em 0}
.imageblock.right{margin:.25em 0 1.25em .625em}
.imageblock>.title{margin-bottom:0}
.imageblock.thumb,.imageblock.th{border-width:6px}
.imageblock.thumb>.title,.imageblock.th>.title{padding:0 .125em}
.image.left,.image.right{margin-top:.25em;margin-bottom:.25em;display:inline-block;line-height:0}
.image.left{margin-right:.625em}
.image.right{margin-left:.625em}
a.image{text-decoration:none;display:inline-block}
a.image object{pointer-events:none}
sup.footnote,sup.footnoteref{font-size:.875em;position:static;vertical-align:super}
sup.footnote a,sup.footnoteref a{text-decoration:none}
sup.footnote a:active,sup.footnoteref a:active{text-decoration:underline}
#footnotes{padding-top:.75em;padding-bottom:.75em;margin-bottom:.625em}
#footnotes hr{width:20%;min-width:6.25em;margin:-.25em 0 .75em;border-width:1px 0 0}
#footnotes .footnote{padding:0 .375em 0 .225em;line-height:1.3334;font-size:.875em;margin-left:1.2em;margin-bottom:.2em}
#footnotes .footnote a:first-of-type{font-weight:bold;text-decoration:none;margin-left:-1.05em}
#footnotes .footnote:last-of-type{margin-bottom:0}
#content #footnotes{margin-top:-.625em;margin-bottom:0;padding:.75em 0}
.gist .file-data>table{border:0;background:#fff;width:100%;margin-bottom:0}
.gist .file-data>table td.line-data{width:99%}
div.unbreakable{page-break-inside:avoid}
.big{font-size:larger}
.small{font-size:smaller}
.underline{text-decoration:underline}
.overline{text-decoration:overline}
.line-through{text-decoration:line-through}
.aqua{color:#00bfbf}
.aqua-background{background-color:#00fafa}
.black{color:#000}
.black-background{background-color:#000}
.blue{color:#0000bf}
.blue-background{background-color:#0000fa}
.fuchsia{color:#bf00bf}
.fuchsia-background{background-color:#fa00fa}
.gray{color:#606060}
.gray-background{background-color:#7d7d7d}
.green{color:#006000}
.green-background{background-color:#007d00}
.lime{color:#00bf00}
.lime-background{background-color:#00fa00}
.maroon{color:#600000}
.maroon-background{background-color:#7d0000}
.navy{color:#000060}
.navy-background{background-color:#00007d}
.olive{color:#606000}
.olive-background{background-color:#7d7d00}
.purple{color:#600060}
.purple-background{background-color:#7d007d}
.red{color:#bf0000}
.red-background{background-color:#fa0000}
.silver{color:#909090}
.silver-background{background-color:#bcbcbc}
.teal{color:#006060}
.teal-background{background-color:#007d7d}
.white{color:#bfbfbf}
.white-background{background-color:#fafafa}
.yellow{color:#bfbf00}
.yellow-background{background-color:#fafa00}
span.icon>.fa{cursor:default}
a span.icon>.fa{cursor:inherit}
.admonitionblock td.icon [class^="fa icon-"]{font-size:2.5em;text-shadow:1px 1px 2px rgba(0,0,0,.5);cursor:default}
.admonitionblock td.icon .icon-note::before{content:"\f05a";color:#19407c}
.admonitionblock td.icon .icon-tip::before{content:"\f0eb";text-shadow:1px 1px 2px rgba(155,155,0,.8);color:#111}
.admonitionblock td.icon .icon-warning::before{content:"\f071";color:#bf6900}
.admonitionblock td.icon .icon-caution::before{content:"\f06d";color:#bf3400}
.admonitionblock td.icon .icon-important::before{content:"\f06a";color:#bf0000}
.conum[data-value]{display:inline-block;color:#fff!important;background-color:rgba(0,0,0,.8);-webkit-border-radius:100px;border-radius:100px;text-align:center;font-size:.75em;width:1.67em;height:1.67em;line-height:1.67em;font-family:"Open Sans","DejaVu Sans",sans-serif;font-style:normal;font-weight:bold}
.conum[data-value] *{color:#fff!important}
.conum[data-value]+b{display:none}
.conum[data-value]::after{content:attr(data-value)}
pre .conum[data-value]{position:relative;top:-.125em}
b.conum *{color:inherit!important}
.conum:not([data-value]):empty{display:none}
dt,th.tableblock,td.content,div.footnote{text-rendering:optimizeLegibility}
h1,h2,p,td.content,span.alt{letter-spacing:-.01em}
p strong,td.content strong,div.footnote strong{letter-spacing:-.005em}
p,blockquote,dt,td.content,span.alt{font-size:1.0625rem}
p{margin-bottom:1.25rem}
.sidebarblock p,.sidebarblock dt,.sidebarblock td.content,p.tableblock{font-size:1em}
.exampleblock>.content{background-color:#fffef7;border-color:#e0e0dc;-webkit-box-shadow:0 1px 4px #e0e0dc;box-shadow:0 1px 4px #e0e0dc}
.print-only{display:none!important}
@page{margin:1.25cm .75cm}
@media print{*{-webkit-box-shadow:none!important;box-shadow:none!important;text-shadow:none!important}
html{font-size:80%}
a{color:inherit!important;text-decoration:underline!important}
a.bare,a[href^="#"],a[href^="mailto:"]{text-decoration:none!important}
a[href^="http:"]:not(.bare)::after,a[href^="https:"]:not(.bare)::after{content:"(" attr(href) ")";display:inline-block;font-size:.875em;padding-left:.25em}
abbr[title]::after{content:" (" attr(title) ")"}
pre,blockquote,tr,img,object,svg{page-break-inside:avoid}
thead{display:table-header-group}
svg{max-width:100%}
p,blockquote,dt,td.content{font-size:1em;orphans:3;widows:3}
h2,h3,#toctitle,.sidebarblock>.content>.title{page-break-after:avoid}
#toc,.sidebarblock,.exampleblock>.content{background:none!important}
#toc{border-bottom:1px solid #dddddf!important;padding-bottom:0!important}
body.book #header{text-align:center}
body.book #header>h1:first-child{border:0!important;margin:2.5em 0 1em}
body.book #header .details{border:0!important;display:block;padding:0!important}
body.book #header .details span:first-child{margin-left:0!important}
body.book #header .details br{display:block}
body.book #header .details br+span::before{content:none!important}
body.book #toc{border:0!important;text-align:left!important;padding:0!important;margin:0!important}
body.book #toc,body.book #preamble,body.book h1.sect0,body.book .sect1>h2{page-break-before:always}
.listingblock code[data-lang]::before{display:block}
#footer{padding:0 .9375em}
.hide-on-print{display:none!important}
.print-only{display:block!important}
.hide-for-print{display:none!important}
.show-for-print{display:inherit!important}}
@media print,amzn-kf8{#header>h1:first-child{margin-top:1.25rem}
.sect1{padding:0!important}
.sect1+.sect1{border:0}
#footer{background:none}
#footer-text{color:rgba(0,0,0,.6);font-size:.9em}}
@media amzn-kf8{#header,#content,#footnotes,#footer{padding:0}}
</style>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
<style>
/* Stylesheet for CodeRay to match GitHub theme | MIT License | http://foundation.zurb.com */
/*pre.CodeRay {background-color:#f7f7f8;}*/
.CodeRay .line-numbers{border-right:1px solid #d8d8d8;padding:0 0.5em 0 .25em}
.CodeRay span.line-numbers{display:inline-block;margin-right:.5em;color:rgba(0,0,0,.3)}
.CodeRay .line-numbers strong{color:rgba(0,0,0,.4)}
table.CodeRay{border-collapse:separate;border-spacing:0;margin-bottom:0;border:0;background:none}
table.CodeRay td{vertical-align: top;line-height:1.45}
table.CodeRay td.line-numbers{text-align:right}
table.CodeRay td.line-numbers>pre{padding:0;color:rgba(0,0,0,.3)}
table.CodeRay td.code{padding:0 0 0 .5em}
table.CodeRay td.code>pre{padding:0}
.CodeRay .debug{color:#fff !important;background:#000080 !important}
.CodeRay .annotation{color:#007}
.CodeRay .attribute-name{color:#000080}
.CodeRay .attribute-value{color:#700}
.CodeRay .binary{color:#509}
.CodeRay .comment{color:#998;font-style:italic}
.CodeRay .char{color:#04d}
.CodeRay .char .content{color:#04d}
.CodeRay .char .delimiter{color:#039}
.CodeRay .class{color:#458;font-weight:bold}
.CodeRay .complex{color:#a08}
.CodeRay .constant,.CodeRay .predefined-constant{color:#008080}
.CodeRay .color{color:#099}
.CodeRay .class-variable{color:#369}
.CodeRay .decorator{color:#b0b}
.CodeRay .definition{color:#099}
.CodeRay .delimiter{color:#000}
.CodeRay .doc{color:#970}
.CodeRay .doctype{color:#34b}
.CodeRay .doc-string{color:#d42}
.CodeRay .escape{color:#666}
.CodeRay .entity{color:#800}
.CodeRay .error{color:#808}
.CodeRay .exception{color:inherit}
.CodeRay .filename{color:#099}
.CodeRay .function{color:#900;font-weight:bold}
.CodeRay .global-variable{color:#008080}
.CodeRay .hex{color:#058}
.CodeRay .integer,.CodeRay .float{color:#099}
.CodeRay .include{color:#555}
.CodeRay .inline{color:#000}
.CodeRay .inline .inline{background:#ccc}
.CodeRay .inline .inline .inline{background:#bbb}
.CodeRay .inline .inline-delimiter{color:#d14}
.CodeRay .inline-delimiter{color:#d14}
.CodeRay .important{color:#555;font-weight:bold}
.CodeRay .interpreted{color:#b2b}
.CodeRay .instance-variable{color:#008080}
.CodeRay .label{color:#970}
.CodeRay .local-variable{color:#963}
.CodeRay .octal{color:#40e}
.CodeRay .predefined{color:#369}
.CodeRay .preprocessor{color:#579}
.CodeRay .pseudo-class{color:#555}
.CodeRay .directive{font-weight:bold}
.CodeRay .type{font-weight:bold}
.CodeRay .predefined-type{color:inherit}
.CodeRay .reserved,.CodeRay .keyword {color:#000;font-weight:bold}
.CodeRay .key{color:#808}
.CodeRay .key .delimiter{color:#606}
.CodeRay .key .char{color:#80f}
.CodeRay .value{color:#088}
.CodeRay .regexp .delimiter{color:#808}
.CodeRay .regexp .content{color:#808}
.CodeRay .regexp .modifier{color:#808}
.CodeRay .regexp .char{color:#d14}
.CodeRay .regexp .function{color:#404;font-weight:bold}
.CodeRay .string{color:#d20}
.CodeRay .string .string .string{background:#ffd0d0}
.CodeRay .string .content{color:#d14}
.CodeRay .string .char{color:#d14}
.CodeRay .string .delimiter{color:#d14}
.CodeRay .shell{color:#d14}
.CodeRay .shell .delimiter{color:#d14}
.CodeRay .symbol{color:#990073}
.CodeRay .symbol .content{color:#a60}
.CodeRay .symbol .delimiter{color:#630}
.CodeRay .tag{color:#008080}
.CodeRay .tag-special{color:#d70}
.CodeRay .variable{color:#036}
.CodeRay .insert{background:#afa}
.CodeRay .delete{background:#faa}
.CodeRay .change{color:#aaf;background:#007}
.CodeRay .head{color:#f8f;background:#505}
.CodeRay .insert .insert{color:#080}
.CodeRay .delete .delete{color:#800}
.CodeRay .change .change{color:#66f}
.CodeRay .head .head{color:#f4f}
</style>
</head>
<body class="article toc2 toc-left">
<div id="header">
<h1>SAPL - Structure and Agency Policy Language</h1>
<div class="details">
<span id="author" class="author">Dominic Heutelbeck</span><br>
<span id="revnumber">version 2.0.0-SNAPSHOT</span>
</div>
<div id="toc" class="toc2">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#introduction">Introduction</a>
<ul class="sectlevel2">
<li><a href="#authorization-subscriptions">Authorization Subscriptions</a></li>
<li><a href="#structure-of-a-sapl-policy">Structure of a SAPL Policy</a></li>
<li><a href="#authorization-decisions">Authorization Decisions</a></li>
<li><a href="#accessing-attributes">Accessing Attributes</a></li>
<li><a href="#getting-started">Getting Started</a></li>
</ul>
</li>
<li><a href="#reference-architecture">Reference Architecture</a>
<ul class="sectlevel2">
<li><a href="#policy-enforcement-point-pep">Policy Enforcement Point (PEP)</a></li>
<li><a href="#policy-decision-point-pdp">Policy Decision Point (PDP)</a></li>
<li><a href="#policy-administration-point-pap">Policy Administration Point (PAP)</a></li>
</ul>
</li>
<li><a href="#publish-subscribe-protocol">Publish / Subscribe Protocol</a>
<ul class="sectlevel2">
<li><a href="#sapl-authorization-subscription">SAPL Authorization Subscription</a></li>
<li><a href="#sapl-authorization-decision">SAPL Authorization Decision</a></li>
<li><a href="#policy-evaluation">Policy Evaluation</a></li>
</ul>
</li>
<li><a href="#multi-subscriptions">Multi-Subscriptions</a></li>
<li><a href="#the-sapl-policy-language">The SAPL Policy Language</a>
<ul class="sectlevel2">
<li><a href="#overview">Overview</a></li>
<li><a href="#imports">Imports</a></li>
<li><a href="#sapl-policy">SAPL Policy</a></li>
<li><a href="#sapl-policy-set">SAPL Policy Set</a></li>
<li><a href="#language-elements">Language Elements</a></li>
<li><a href="#sapl-expressions">SAPL Expressions</a></li>
</ul>
</li>
<li><a href="#authorization-subscription-evaluation">Authorization Subscription Evaluation</a>
<ul class="sectlevel2">
<li><a href="#policy-2">Policy</a></li>
<li><a href="#policy-set">Policy Set</a></li>
<li><a href="#authorization-subscription">Authorization Subscription</a></li>
<li><a href="#combining-algorithm-2">Combining Algorithm</a></li>
<li><a href="#transformation-2">Transformation</a></li>
<li><a href="#obligation-advice">Obligation / Advice</a></li>
</ul>
</li>
<li><a href="#functions">Functions</a>
<ul class="sectlevel2">
<li><a href="#the-standard-function-library">The Standard Function Library</a></li>
<li><a href="#custom-function-libraries">Custom Function Libraries</a></li>
</ul>
</li>
<li><a href="#attribute-finders">Attribute Finders</a>
<ul class="sectlevel2">
<li><a href="#the-standard-attribute-finders">The Standard Attribute Finders</a></li>
<li><a href="#custom-attribute-finders">Custom Attribute Finders</a></li>
</ul>
</li>
</ul>
</div>
</div>
<div id="content">
<div class="sect1">
<h2 id="introduction"><a class="anchor" href="#introduction"></a>Introduction</h2>
<div class="sectionbody">
<div class="paragraph">
<p>SAPL (Streaming Attribute or Structure and Agency Policy Language) describes both a <strong>domain specific language (DSL)</strong> for expressing access control policies and a <strong>publish/subscribe protocol</strong> based on <a href="http://json.org/">JSON</a>.
Policies expressed in SAPL describe conditions for access control in applications and distributed systems. The underlying policy engine implements a variant of Attribute-based Access control (ABAC) which is enables processing of data streams and follows reactive programming patterns. Namely, the SAPL policy engine implements Attribute Stream-based Access Control (ASBAC).</p>
</div>
<div class="paragraph">
<p>A typical scenario for the application of SAPL would be a subject (e.g., a user or system) attempting to take an action (e.g., read or cancel an order) on a protected resource (e.g., a domain object of an application or a file). The subject makes a subscription request to the system (e.g., an application) for executing the action on the resource. The system implements a <strong>policy enforcement point (PEP)</strong> protecting the resources. The PEP collects information about the subject, action, resource, and potential other relevant data in an authorization subscription request and sends it to a <strong>policy decision point (PDP)</strong> which checks SAPL policies in order to decide whether access to the resource should be permitted as requested. This decision is packed in an authorization decision object and sent back to the PEP which accordingly either grants access according to the decision or prevents access to the resource. All data sources for the decision are subscribed to by the PDP and new decisions are sent to the PEP whenever indicated by the policies and data sources.</p>
</div>
<div class="paragraph">
<p>There exist several proprietary platform dependent or standardized languages, such as <a href="http://docs.oasis-open.org/xacml/3.0/xacml-3.0-core-spec-os-en.html">XACML</a> for expressing policies. SAPL brings a number of advantages over these solutions:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Universality</strong>. SAPL offers a generic, platform independent language for expressing policies. Even in complex heterogeneous environments, policies can be expressed in a common language.</p>
</li>
<li>
<p><strong>Separation of Concerns</strong>. Applying SAPL your domain model is relieved from modeling many aspects of access control. SAPL favors configuration at run-time over implementation and re-deployment of your applications.</p>
</li>
<li>
<p><strong>Modularity and Distribution</strong>. SAPL allows to manage policies in a modular fashion allowing the distribution of authoring responsibilities across teams.</p>
</li>
<li>
<p><strong>Expressiveness</strong>. SAPL provides access control schemata beyond the capabilities of most other practical languages. It allows for attribute-based access control (ABAC), role-based access control (RBAC), forms of entity-based access control (EBAC) and (in the near future) relation-based access control (ReBAC).</p>
</li>
<li>
<p><strong>Human Readability</strong>. The SAPL syntax is designed from the ground up to be easily readable by humans. Basic SAPL is easy to pick-up for getting started but offers enough expressiveness to address complex access control scenarios.</p>
</li>
<li>
<p><strong>Transformation and Filtering</strong>. SAPL allows transforming resources and filtering data from resources (e.g., blacken the first digits of a credit card number, or hiding of birth dates by assigning individuals into age groups).</p>
</li>
<li>
<p><strong>Designed for a session and data stream-based applications</strong>. SAPL is designed to offer low-latency authorization for interactive applications and data streams.</p>
</li>
<li>
<p><strong>Designed for a RESTful World with JSON</strong>. SAPL is designed to be easily integrated with modern JSON-based APIs. The core data model of SAPL is JSON offering easy reasoning over such data and simple access to external attributes from RESTful JSON APIs.</p>
</li>
<li>
<p><strong>Supports Multi-Subscriptions</strong>. SAPL allows to bundle multiple authorization subscriptions into one multi-subscription thus further reducing connection time and latency.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The following sections will explain the basic concepts of SAPL policies and show how to easily integrate SAPL in a Java application. Afterwards the different parts of SAPL are explained in more detail.</p>
</div>
<div class="sect2">
<h3 id="authorization-subscriptions"><a class="anchor" href="#authorization-subscriptions"></a>Authorization Subscriptions</h3>
<div class="paragraph">
<p>A SAPL authorization subscription is a JSON object, i.e., a set of name/value pairs or <em>attributes</em>. It contains attributes with the names <code>subject</code>, <code>action</code>, <code>resource</code> and <code>environment</code>. The values of these attributes may be any arbitrary JSON value, e.g.:</p>
</div>
<div class="listingblock">
<div class="title">Introduction - Sample Authorization Subscription</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="json">{
  <span class="key"><span class="delimiter">&quot;</span><span class="content">subject</span><span class="delimiter">&quot;</span></span>     : {
                    <span class="key"><span class="delimiter">&quot;</span><span class="content">username</span><span class="delimiter">&quot;</span></span>    : <span class="string"><span class="delimiter">&quot;</span><span class="content">alice</span><span class="delimiter">&quot;</span></span>,
                    <span class="key"><span class="delimiter">&quot;</span><span class="content">tracking_id</span><span class="delimiter">&quot;</span></span> : <span class="integer">1234321</span>,
                    <span class="key"><span class="delimiter">&quot;</span><span class="content">nda_signed</span><span class="delimiter">&quot;</span></span>  : <span class="value">true</span>
                  },
  <span class="key"><span class="delimiter">&quot;</span><span class="content">action</span><span class="delimiter">&quot;</span></span>      : <span class="string"><span class="delimiter">&quot;</span><span class="content">HTTP:GET</span><span class="delimiter">&quot;</span></span>,
  <span class="key"><span class="delimiter">&quot;</span><span class="content">resource</span><span class="delimiter">&quot;</span></span>    : <span class="string"><span class="delimiter">&quot;</span><span class="content">https://medical.org/api/patients/123</span><span class="delimiter">&quot;</span></span>,
  <span class="key"><span class="delimiter">&quot;</span><span class="content">environment</span><span class="delimiter">&quot;</span></span> : <span class="value">null</span>
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>This authorization subscription expresses the intent of the user <code>alice</code>, with the given attributes, to <code>HTTP:GET</code> the resource at <code>https://medical.org/api/patients/123</code>. Such a SAPL authorization subscription may be issued in a RESTful API by a PEP in front of the request handlers of the API.</p>
</div>
</div>
<div class="sect2">
<h3 id="structure-of-a-sapl-policy"><a class="anchor" href="#structure-of-a-sapl-policy"></a>Structure of a SAPL Policy</h3>
<div class="paragraph">
<p>A SAPL policy document generally consists of:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>the keyword <code>policy</code>, declaring that the document contains a policy (opposed to a policy set; more on policy sets <a href="#policy-set">see below</a>)</p>
</li>
<li>
<p>a unique (for the PDP) policy name</p>
</li>
<li>
<p>the entitlement, which is the decision result to be returned upon successful evaluation of the policy, i.e., <code>permit</code> or <code>deny</code></p>
</li>
<li>
<p>an optional target expression for indexing and policy selection</p>
</li>
<li>
<p>an optional <code>where</code> clause containing the conditions under which the entitlement (<code>permit</code> or <code>deny</code> as defined above) applies</p>
</li>
<li>
<p>optional <code>advice</code> and <code>obligation</code> clauses to inform the PEP about optional and mandatory requirements for granting access to the resource</p>
</li>
<li>
<p>an optional <code>transformation</code> clause for defining a transformed resource to be used instead of the original resource</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>A simple SAPL policy which allows <code>alice</code> to <code>HTTP:GET</code> the resource <code>https://medical.org/api/patients/123</code> would look as follows (in a real world this policy is too specific):</p>
</div>
<hr>
<div class="listingblock">
<div class="title">Introduction - Sample Policy 1</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="asciidoc">policy &quot;permit_alice_get_patient123&quot; <i class="conum" data-value="1"></i><b>(1)</b>
permit resource =~ &quot;^https://medical.org/api/patients.*&quot; <i class="conum" data-value="2"></i><b>(2)</b>
where <i class="conum" data-value="3"></i><b>(3)</b>
  subject.username == &quot;alice&quot;; <i class="conum" data-value="4"></i><b>(4)</b>
  action == &quot;HTTP:GET&quot;;
  resource == &quot;https://medical.org/api/patients/123&quot;;</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>declares the policy with the name <code>permit_alice_get_patient123</code>. The JSON values of the authorization subscription object are bound to the variables <code>subject</code>, <code>action</code>, <code>resource</code> and <code>environment</code> and can be directly accessed in the policy. The syntax <code>.name</code> accesses attributes of a nested JSON object.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>declares that if the resource is a string starting with <code><a href="https://medical.org/api/patients" class="bare">https://medical.org/api/patients</a></code> (using the regular expression operator <code>=~</code>) and the conditions of the <code>where</code> clause applies, the subject will be permitted access to the resource. Note, that the <code>where</code> clause is only evaluated if the condition of the target expression evaluates to <code>true</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>starts the <code>where</code> clause (policy body) consisting of a list of statements. The policy body evaluates to <code>true</code> if all statements evaluate to <code>true</code>.</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="authorization-decisions"><a class="anchor" href="#authorization-decisions"></a>Authorization Decisions</h3>
<div class="paragraph">
<p>The SAPL authorization decision to the authorization subscription is a JSON object as well. It contains the attribute <code>decision</code> as well as the optional attributes <code>resource</code>, <code>obligation</code> and <code>advice</code>. For the introductory sample authorization subscription with the preceding policy a SAPL authorization decision would look as follows:</p>
</div>
<hr>
<div class="listingblock">
<div class="title">Introduction - Sample Authorization Decision</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="json">{
  <span class="key"><span class="delimiter">&quot;</span><span class="content">decision</span><span class="delimiter">&quot;</span></span>   : <span class="string"><span class="delimiter">&quot;</span><span class="content">PERMIT</span><span class="delimiter">&quot;</span></span>
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>This authorization decision is evaluated by the PEP to grant or deny access.</p>
</div>
</div>
<div class="sect2">
<h3 id="accessing-attributes"><a class="anchor" href="#accessing-attributes"></a>Accessing Attributes</h3>
<div class="paragraph">
<p>In many use-cases, all required information for making a decision may be contained in the authorization subscription object. However, the PEP is usually not aware of the specifics of the access policies and may not have access to all information required for making the decision. In this case, the PDP is able to access external attributes. The following example shows how accessing attributes is expressed in SAPL.</p>
</div>
<div class="paragraph">
<p>Extending the example above, in a real world application there will be multiple patients and multiple users. Thus policies need to be worded in a more abstract way. In a natural language, a suitable policy could be <em>Permit doctors to HTTP:GET data from any patient</em>. The policy addresses the profile attribute of the subject, stored externally. SAPL allows to express this policy as follows:</p>
</div>
<hr>
<div class="listingblock">
<div class="title">Introduction - Sample Policy 2</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="asciidoc"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
</pre></td>
  <td class="code"><pre>policy &quot;doctors_get_patient&quot;
permit
  action == &quot;HTTP:GET&quot; &amp;
  resource =~ &quot;^https://medical\.org/api/patients/\d*$&quot;
where
  subject.username.&lt;user.profile&gt;.function == &quot;doctor&quot;;</pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>In <em>line 4</em> a regular expression is used for identifying a request to any patient&#8217;s data (operator <code>=~</code>). The authorization subscription resource must match this pattern for the policy to apply.</p>
</div>
<div class="paragraph">
<p>The policy assumes that the user&#8217;s function is not provided in the authorization subscription but stored in the user&#8217;s profile. Accordingly <em>line 6</em> accesses the attribute <code>user.profile</code> (using an attribute finder step <code>.&lt;finder.name&gt;</code>) to retrieve the profile for the user with the username provided in <code>subject.username</code>. The fetched profile is a JSON object with a property named <code>function</code> which can be compared to <code>"doctor"</code>.</p>
</div>
<div class="paragraph">
<p><em>Line 6</em> is placed in the policy body (starting with <code>where</code>) instead of the target expression. The reason for this location is that the target expression block is also used for indexing policies efficiently and therefore needs to be evaluated quickly. Hence it is not allowed to include conditions which may need to call an external service.</p>
</div>
<hr>
<div class="paragraph">
<p>This should give you a basic understanding of the operation principles applied in SAPL.</p>
</div>
</div>
<div class="sect2">
<h3 id="getting-started"><a class="anchor" href="#getting-started"></a>Getting Started</h3>
<div class="paragraph">
<p>SAPL provides an embedded PDP including an embedded PRP with a file system policy store which can be easily integrated in a Java applications. Besides this guide, the quickest way to start is to build upon the demo projects hosted on <a href="https://github.com/heutelbeck/sapl-demos">GitHub</a> some good demos to start from are the simple no-framework <a href="https://github.com/heutelbeck/sapl-demos/tree/master/sapl-demo-embedded">Embedded PDP Demo</a> or the full-stack <a href="https://github.com/heutelbeck/sapl-demos/tree/master/sapl-demo-mvc-app">Spring MVC Project</a> or the <a href="https://github.com/heutelbeck/sapl-demos/tree/master/sapl-demo-reactive">Reactive Vaadin Application</a>.</p>
</div>
<div class="sect3">
<h4 id="maven-dependencies"><a class="anchor" href="#maven-dependencies"></a>Maven Dependencies</h4>
<div class="paragraph">
<p>Currently, all SAPL artifacts are hosted on GitHub. To load these as dependencies into your Java project, you need to generate aGitHub personal access token (<a href="https://github.com/settings/tokens" class="bare">https://github.com/settings/tokens</a>), as GitHub does currently not allow unauthenticated access to Maven repositories.
On availability, the 2.0.0 release will be pushed to the central repository, eliminating this step.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Add your GitHub personal access token to your <code>settings.xml</code> file, usually located at: <code>~/.m2/settings.xml</code>.</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="XML">   <span class="tag">&lt;/servers&gt;</span>
      <span class="tag">&lt;server&gt;</span>
         <span class="tag">&lt;id&gt;</span>sapl<span class="tag">&lt;/id&gt;</span>
         <span class="tag">&lt;username&gt;</span>USERNAME<span class="tag">&lt;/username&gt;</span>
         <span class="tag">&lt;password&gt;</span>TOKEN<span class="tag">&lt;/password&gt;</span>
      <span class="tag">&lt;/server&gt;</span>
   <span class="tag">&lt;/servers&gt;</span></code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>SAPL requires Java 11 or later</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="XML">   <span class="tag">&lt;properties&gt;</span>
      <span class="tag">&lt;java.version&gt;</span>11<span class="tag">&lt;/java.version&gt;</span>
      <span class="tag">&lt;maven.compiler.source&gt;</span>${java.version}<span class="tag">&lt;/maven.compiler.source&gt;</span>
      <span class="tag">&lt;maven.compiler.target&gt;</span>${java.version}<span class="tag">&lt;/maven.compiler.target&gt;</span>
   <span class="tag">&lt;/properties&gt;</span></code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Add a SAPL dependency to your application. When using Maven you can add the following dependencies to your project&#8217;s <code>pom.xml</code>:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="XML">   <span class="tag">&lt;dependency&gt;</span>
      <span class="tag">&lt;groupId&gt;</span>io.sapl<span class="tag">&lt;/groupId&gt;</span>
      <span class="tag">&lt;artifactId&gt;</span>sapl-pdp-embedded<span class="tag">&lt;/artifactId&gt;</span>
      <span class="tag">&lt;version&gt;</span>2.0.0-SNAPSHOT<span class="tag">&lt;/version&gt;</span>
   <span class="tag">&lt;/dependency&gt;</span></code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Add the SAPL Maven repository to your <code>pom.xml</code>:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="XML">    <span class="tag">&lt;repositories&gt;</span>
        <span class="comment">&lt;!-- The SAPL dependencies are hosted in this repository. A matching server
            entry has to be set in the settings.xml using a GitHub personal access token --&gt;</span>
        <span class="tag">&lt;repository&gt;</span>
            <span class="tag">&lt;id&gt;</span>sapl<span class="tag">&lt;/id&gt;</span>
            <span class="tag">&lt;name&gt;</span>SAPL Maven Repository<span class="tag">&lt;/name&gt;</span>
            <span class="tag">&lt;url&gt;</span>https://maven.pkg.github.com/heutelbeck/packages<span class="tag">&lt;/url&gt;</span>
            <span class="tag">&lt;snapshots&gt;</span>
                <span class="tag">&lt;enabled&gt;</span>true<span class="tag">&lt;/enabled&gt;</span>
                <span class="tag">&lt;updatePolicy&gt;</span>always<span class="tag">&lt;/updatePolicy&gt;</span>
            <span class="tag">&lt;/snapshots&gt;</span>
        <span class="tag">&lt;/repository&gt;</span>
    <span class="tag">&lt;/repositories&gt;</span></code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>If you plan to use more SAPL dependencies, a useful bill of materials POM is offered, centralizing the dependency management for SAPL artifacts:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="XML">   <span class="tag">&lt;dependencyManagement&gt;</span>
      <span class="tag">&lt;dependencies&gt;</span>
         <span class="tag">&lt;dependency&gt;</span>
            <span class="tag">&lt;groupId&gt;</span>io.sapl<span class="tag">&lt;/groupId&gt;</span>
            <span class="tag">&lt;artifactId&gt;</span>sapl-bom<span class="tag">&lt;/artifactId&gt;</span>
            <span class="tag">&lt;version&gt;</span>${sapl.version}<span class="tag">&lt;/version&gt;</span>
            <span class="tag">&lt;type&gt;</span>pom<span class="tag">&lt;/type&gt;</span>
            <span class="tag">&lt;scope&gt;</span>import<span class="tag">&lt;/scope&gt;</span>
         <span class="tag">&lt;/dependency&gt;</span>
      <span class="tag">&lt;/dependencies&gt;</span>
   <span class="tag">&lt;/dependencyManagement&gt;</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="coding"><a class="anchor" href="#coding"></a>Coding</h4>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>In your application, create a new <code>EmbeddedPolicyDecisionPoint</code>. The argument <code>"~/sapl"</code> specifies directory which contain the configuration file <code>pdp.json</code> and all policies.</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="Java"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
</pre></td>
  <td class="code"><pre>EmbeddedPolicyDecisionPoint pdp = PolicyDecisionPointFactory.filesystemPolicyDecisionPoint(<span class="string"><span class="delimiter">&quot;</span><span class="content">~/sapl</span><span class="delimiter">&quot;</span></span>);</pre></td>
</tr></table></code></pre>
</div>
</div>
</li>
<li>
<p>Add a <code>pdp.json</code> with the following content to the directory "~/sapl":</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="linenums">{
    &quot;algorithm&quot;: &quot;DENY_UNLESS_PERMIT&quot;,
    &quot;variables&quot;: {}
}</code></pre>
</div>
</div>
</li>
<li>
<p>Add some policy sets or policies to <code>"~/sapl"</code>. Both policy sets and policies are files with the extension <code>.sapl</code>. E.g., you could add the following policy:</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>policy "test_policy"
permit subject == "admin"</code></pre>
</div>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Obtain a decision using the PDP&#8217;s <code>decide</code> method.</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="Java"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
</pre></td>
  <td class="code"><pre>var subscription = AuthorizationSubscription.of(<span class="string"><span class="delimiter">&quot;</span><span class="content">admin</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">an_action</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">a_resource</span><span class="delimiter">&quot;</span></span>);
Flux&lt;AuthorizationDecision&gt; authzDecisions = pdp.decide(authzSubscription);
authzDecisions.subscribe(authzDecision -&gt; <span class="predefined-type">System</span>.out.println(authzDecision.getDecision()));</pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>The console output should be <code>PERMIT</code>. With subject set to <code>"alice"</code> instead of <code>"admin"</code>, the output should be <code>DENY</code>.</p>
</div>
<div class="paragraph">
<p>Not at runtime you can modify the policy, add or remove polices and observe how the decision change.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="reference-architecture"><a class="anchor" href="#reference-architecture"></a>Reference Architecture</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The architecture of the SAPL policy engine is in accordance with the terminology defined by <a href="https://tools.ietf.org/html/rfc2904">RFC2904 "AAA Authorization Framework"</a>.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/SAPL_Architecture.svg" alt="SAPL Architecture">
</div>
</div>
<div class="sect2">
<h3 id="policy-enforcement-point-pep"><a class="anchor" href="#policy-enforcement-point-pep"></a>Policy Enforcement Point (PEP)</h3>
<div class="paragraph">
<p>The PEP is a software entity which intercepts actions taken by users within an application. Its task is to obtain a decision whether the requested action should be allowed and accordingly either let the application process the action or deny access. For this purpose the PEP includes data describing the subscription context (like the subject, the resource, the action and other environment information) in an authorization subscription object which the PEP hands over to a PDP. The PEP subsequently receives an authorization decision object containing a decision as well as optionally a resource, obligations and advice.</p>
</div>
<div class="paragraph">
<p>The PEP must let the application process the action if and only if the decision is <code>PERMIT</code>. If the authorization decision object also contains an <code>obligation</code> the PEP must fulfill this obligation. Proper fulfillment is an additional requirement for granting access. In case the decision is not <code>PERMIT</code> or the obligation cannot be fulfilled, access has to be denied. Since policies may contain instructions to alter the resource (like blackening certain information, e.g., credit card numbers) the PEP should ensure that the application only reveals the resource contained in the authorization decision object if one is returned.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
A PEP strongly depends on the application domain. SAPL comes with a default PEP implementation using a passed in constraint handler service to handle obligations and advice contained in an authorization decision. PEPs should be integrated with the platforms and frameworks used by the application developers. SAPL comes with an Spring Security integration and matching spring-boot-starter modules.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="policy-decision-point-pdp"><a class="anchor" href="#policy-decision-point-pdp"></a>Policy Decision Point (PDP)</h3>
<div class="paragraph">
<p>The PDP has to make an authorization decision based on an authorization subscription object and the access policies which it receives from a <strong>Policy Retrieval Point (PRP)</strong> connected to a policy store. Beginning with the authorization subscription object the PDP fetches policy sets and policies matching the authorization subscription, evaluates them and combines the results to create and return an authorization decision object. As there may be multiple matching policies which might evaluate to different results the PDP needs to be configured with a <strong>combining algorithm</strong> (e.g., <code>permit-overrides</code> stating that the decision will be <code>permit</code> if any applicable policy evaluates to <code>permit</code>).</p>
</div>
<div class="paragraph">
<p>A policy may refer to attributes which are not included in the authorization subscription object and have to be obtained from external <strong>Policy Information Points (PIP)</strong>. The PDP fetches those attributes while evaluating the policy. To be able to access external PIPs the PDP can be extended by custom attribute finders. Policies might also contain functions not included in the default SAPL implementation. Such custom functions can be added through <strong>Policy Function Providers (PFP)</strong>.</p>
</div>
<div class="paragraph">
<p>SAPL provides two simple PDP implementations: An <strong>embedded PDP</strong> with an embedded PRP which can be integrated easily into a Java application and a <strong>remote PDP client</strong> which obtains decisions through a RESTful interface.</p>
</div>
</div>
<div class="sect2">
<h3 id="policy-administration-point-pap"><a class="anchor" href="#policy-administration-point-pap"></a>Policy Administration Point (PAP)</h3>
<div class="paragraph">
<p>The PAP is an entity which allows managing policies contained in the policy store. In the embedded PDP with the Resources PRP the policy store can be a simple folder within the local file system containing <code>.sapl</code> files. Therefore any access to files in this folder (e.g., FTP or SSH) can be seen as a very simple PAP. The PAP may be a separate application or be included in an existing administration panel.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="publish-subscribe-protocol"><a class="anchor" href="#publish-subscribe-protocol"></a>Publish / Subscribe Protocol</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The PDP receives an authorization subscription from a PEP and sends an authorization decision. Both subscription and decision are JSON objects consisting of name/value pairs (also called attributes) with predefined names. A PEP must be able to create an authorization subscription and to process an authorization decision object.</p>
</div>
<div class="sect2">
<h3 id="sapl-authorization-subscription"><a class="anchor" href="#sapl-authorization-subscription"></a>SAPL Authorization Subscription</h3>
<div class="paragraph">
<p>A SAPL authorization subscription contains attributes with the names <code>subject</code>, <code>resource</code>, <code>action</code> and <code>environment</code>. Each attribute value can be any JSON value (i.e., an object, an array, a number, a string, <code>true</code>, <code>false</code> or <code>null</code>).</p>
</div>
</div>
<div class="sect2">
<h3 id="sapl-authorization-decision"><a class="anchor" href="#sapl-authorization-decision"></a>SAPL Authorization Decision</h3>
<div class="paragraph">
<p>The SAPL authorization decision contains the attributes <code>decision</code>, <code>resource</code>, <code>obligation</code> and <code>advice</code>.</p>
</div>
<div class="sect3">
<h4 id="decision"><a class="anchor" href="#decision"></a>Decision</h4>
<div class="paragraph">
<p>The <code>decision</code> tells the PEP whether to grant or deny access. Access should be granted only if the decision is <code>"PERMIT"</code>. The <code>decision</code> attribute can be one of the following string values with the described meanings:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>"PERMIT"</code>: Access must be granted.</p>
</li>
<li>
<p><code>"DENY"</code>: Access must be denied.</p>
</li>
<li>
<p><code>"NOT_APPLICABLE"</code>: A decision could not be made because no policy is applicable to the authorization subscription.</p>
</li>
<li>
<p><code>"INDETERMINATE"</code>: A decision could not be made because an error occurred.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="resource"><a class="anchor" href="#resource"></a>Resource</h4>
<div class="paragraph">
<p>The PEP knows which resource it requested access for. Thus there usually is no need for returning this resource in the authorization decision object. However SAPL policies may contain a <code>transform</code> statement describing how the resource needs to be altered before it is returned to the subject seeking permission. This can be used to remove or blacken certain parts of the resource document (e.g., a policy could allow doctors to view patient data but remove any bank account details as they can only be accessed by the accounting department). If a policy which evaluates to <code>PERMIT</code> contains a <code>transform</code> statement, the authorization decision attribute <code>resource</code> contains the transformed resource. Otherwise there will not be a <code>resource</code> attribute in the authorization decision object.</p>
</div>
</div>
<div class="sect3">
<h4 id="obligation"><a class="anchor" href="#obligation"></a>Obligation</h4>
<div class="paragraph">
<p>The value of <code>obligation</code> contains assignments which the PEP must fulfill before granting or denying access. As there can be multiple policies applicable to the authorization subscription with different obligations, the <code>obligation</code> value in the authorization decision object is an array containing a list of tasks. If the PEP is not able to fulfill these tasks access must not be granted. The array items can be any JSON value (e.g., a string or an object). Consequently the PEP must know how to identify and process the obligations contained in the policies. An <code>obligation</code> attribute is only included in the authorization decision object if there is at least one obligation.</p>
</div>
<div class="paragraph">
<p>A authorization decision could, for example, contain the obligation to create a log entry.</p>
</div>
</div>
<div class="sect3">
<h4 id="advice"><a class="anchor" href="#advice"></a>Advice</h4>
<div class="paragraph">
<p>The value of <code>advice</code> is an array with assignments for the PEP as well and works similar to obligations except for one difference: The fulfillment of the tasks is no requirement for granting access. I.e., in case the <code>decision</code> is <code>PERMIT</code>, the PEP should also grant access if it can not fulfill the tasks contained in <code>advice</code>. An <code>advice</code> attribute is only included in the authorization decision object if there is at least one advice.</p>
</div>
<div class="paragraph">
<p>In addition to the obligation to create a log entry, a policy could specify the advice to inform the system administrator via email about the access.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="policy-evaluation"><a class="anchor" href="#policy-evaluation"></a>Policy Evaluation</h3>
<div class="paragraph">
<p>To come to the final decision included in the authorization decision object, the PDP evaluates all existing policy sets and top level policies (i.e., policies which are not part of a policy set) against the authorization subscription and combines the results. Each individual policy set and policy evaluates to <code>PERMIT</code>, <code>DENY</code>, <code>NOT_APPLICABLE</code> or <code>INDETERMINATE</code> (see <a href="#evaluation">below</a>). The PDP can be configured with a <strong>combining algorithm</strong> which determines how to deal with multiple results. E.g., if access should only be granted if at least one policy evaluates to <code>PERMIT</code> and should be denied otherwise, the algorithm <code>deny-unless-permit</code> could be used.</p>
</div>
<div class="paragraph">
<p>Available combining algorithms for the PDP are:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>deny-unless-permit</code></p>
</li>
<li>
<p><code>permit-unless-deny</code></p>
</li>
<li>
<p><code>only-one-applicable</code></p>
</li>
<li>
<p><code>deny-overrides</code></p>
</li>
<li>
<p><code>permit-overrides</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The algorithm <code>first-applicable</code> is not available for the PDP since the PDP&#8217;s collection of policy sets and policies is an unordered set.</p>
</div>
<div class="paragraph">
<p>The combining algorithms are described in more detail <a href="#combining-algorithms">later</a>.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="multi-subscriptions"><a class="anchor" href="#multi-subscriptions"></a>Multi-Subscriptions</h2>
<div class="sectionbody">
<div class="paragraph">
<p>SAPL allows for bundling multiple authorization subscriptions into one multi-subscription. A multi-subscription is a JSON object with the following structure:</p>
</div>
<div class="listingblock">
<div class="title">Multi-Subscriptions - JSON Structure</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="json">{
  <span class="key"><span class="delimiter">&quot;</span><span class="content">subjects</span><span class="delimiter">&quot;</span></span>                   : [<span class="string"><span class="delimiter">&quot;</span><span class="content">bs@simpsons.com</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">ms@simpsons.com</span><span class="delimiter">&quot;</span></span>],
  <span class="key"><span class="delimiter">&quot;</span><span class="content">actions</span><span class="delimiter">&quot;</span></span>                    : [<span class="string"><span class="delimiter">&quot;</span><span class="content">read</span><span class="delimiter">&quot;</span></span>],
  <span class="key"><span class="delimiter">&quot;</span><span class="content">resources</span><span class="delimiter">&quot;</span></span>                  : [<span class="string"><span class="delimiter">&quot;</span><span class="content">file://example/med/record/patient/BartSimpson</span><span class="delimiter">&quot;</span></span>,
                                  <span class="string"><span class="delimiter">&quot;</span><span class="content">file://example/med/record/patient/MaggieSimpson</span><span class="delimiter">&quot;</span></span>],
  <span class="key"><span class="delimiter">&quot;</span><span class="content">environments</span><span class="delimiter">&quot;</span></span>               : [],

  <span class="key"><span class="delimiter">&quot;</span><span class="content">authorizationSubscriptions</span><span class="delimiter">&quot;</span></span> : {
                                   <span class="key"><span class="delimiter">&quot;</span><span class="content">id-1</span><span class="delimiter">&quot;</span></span> : { <span class="key"><span class="delimiter">&quot;</span><span class="content">subjectId</span><span class="delimiter">&quot;</span></span>: <span class="integer">0</span>, <span class="key"><span class="delimiter">&quot;</span><span class="content">actionId</span><span class="delimiter">&quot;</span></span>: <span class="integer">0</span>, <span class="key"><span class="delimiter">&quot;</span><span class="content">resourceId</span><span class="delimiter">&quot;</span></span>: <span class="integer">0</span> },
                                   <span class="key"><span class="delimiter">&quot;</span><span class="content">id-2</span><span class="delimiter">&quot;</span></span> : { <span class="key"><span class="delimiter">&quot;</span><span class="content">subjectId</span><span class="delimiter">&quot;</span></span>: <span class="integer">1</span>, <span class="key"><span class="delimiter">&quot;</span><span class="content">actionId</span><span class="delimiter">&quot;</span></span>: <span class="integer">0</span>, <span class="key"><span class="delimiter">&quot;</span><span class="content">resourceId</span><span class="delimiter">&quot;</span></span>: <span class="integer">1</span> }
                                 }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>It contains distinct lists of all subjects, actions, resources and environments referenced by the single authorization subscriptions being part of the multi-subscription. The authorization subscriptions themselves are stored in a map of subscription IDs pointing to an object defining an authorization subscription by providing indexes into the four lists mentioned before.</p>
</div>
<div class="paragraph">
<p>The multi-subscription shown in the example above contains two authorization subscriptions. The user <code>bs@simpsons.com</code> wants to <code>read</code> the file <code><a href="file://example/med/record/patient/BartSimpson" class="bare">file://example/med/record/patient/BartSimpson</a></code> and the user <code>ms@simpsons.com</code> wants to <code>read</code> the file <code><a href="file://example/med/record/patient/MaggieSimpson" class="bare">file://example/med/record/patient/MaggieSimpson</a></code>.</p>
</div>
<div class="paragraph">
<p>The SAPL PDP processes all individual authorization subscriptions contained in the multi-subscription in parallel and either returns the related authorization decisions as soon as they are available or it collects all the authorization decisions of the individual authorization subscriptions and returns them as a multi-decision. In both cases the authorization decisions are associated with the subscription IDs of the related authorization subscription. The following listings show the JSON structures of the two authorization decision types:</p>
</div>
<div class="listingblock">
<div class="title">Single Authorization Decision with Associated Subscription ID - JSON Structure</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="json">{
  <span class="key"><span class="delimiter">&quot;</span><span class="content">authorizationSubscriptionId</span><span class="delimiter">&quot;</span></span> : <span class="string"><span class="delimiter">&quot;</span><span class="content">id-1</span><span class="delimiter">&quot;</span></span>,
  <span class="key"><span class="delimiter">&quot;</span><span class="content">authorizationDecision</span><span class="delimiter">&quot;</span></span>       : {
                                    <span class="key"><span class="delimiter">&quot;</span><span class="content">decision</span><span class="delimiter">&quot;</span></span> : <span class="string"><span class="delimiter">&quot;</span><span class="content">PERMIT</span><span class="delimiter">&quot;</span></span>,
                                    <span class="key"><span class="delimiter">&quot;</span><span class="content">resource</span><span class="delimiter">&quot;</span></span> : { <span class="error">.</span><span class="error">.</span><span class="error">.</span> }
                                  }
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Multi-Decision - JSON Structure</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="json">{
  <span class="key"><span class="delimiter">&quot;</span><span class="content">authorizationDecisions</span><span class="delimiter">&quot;</span></span> : {
                               <span class="key"><span class="delimiter">&quot;</span><span class="content">id-1</span><span class="delimiter">&quot;</span></span> : {
                                          <span class="key"><span class="delimiter">&quot;</span><span class="content">decision</span><span class="delimiter">&quot;</span></span> : <span class="string"><span class="delimiter">&quot;</span><span class="content">PERMIT</span><span class="delimiter">&quot;</span></span>,
                                          <span class="key"><span class="delimiter">&quot;</span><span class="content">resource</span><span class="delimiter">&quot;</span></span> : { <span class="error">.</span><span class="error">.</span><span class="error">.</span> }
                                        },
                               <span class="key"><span class="delimiter">&quot;</span><span class="content">id-2</span><span class="delimiter">&quot;</span></span> : {
                                          <span class="key"><span class="delimiter">&quot;</span><span class="content">decision</span><span class="delimiter">&quot;</span></span> : <span class="string"><span class="delimiter">&quot;</span><span class="content">DENY</span><span class="delimiter">&quot;</span></span>
                                        }
                             }
}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="the-sapl-policy-language"><a class="anchor" href="#the-sapl-policy-language"></a>The SAPL Policy Language</h2>
<div class="sectionbody">
<div class="paragraph">
<p>SAPL defines a feature-rich domain specific language (DSL) for creating access policies.</p>
</div>
<div class="paragraph">
<p>Those access policies describe when access requests will be granted and when access will be denied. The underlying concept to describe these permissions is an attribute-based access control model (ABAC): A SAPL authorization subscription is a JSON object with the attributes <code>subject</code>, <code>action</code>, <code>resource</code> and <code>environment</code> each with an assigned JSON value. Each of these values may be a JSON object itself containing multiple attributes. Policies can make use of boolean conditions referring to those attributes (e.g., <code>subject.username == "admin"</code>).</p>
</div>
<div class="paragraph">
<p>However a role based access control (RBAC) system in which permissions are assigned to a certain role and roles can be assigned to users can be created with SAPL as well.</p>
</div>
<div class="sect2">
<h3 id="overview"><a class="anchor" href="#overview"></a>Overview</h3>
<div class="paragraph">
<p>SAPL knows two types of documents: Policy sets and policies. The decisions of the PDP are based on all documents published in the policy store of the PDP.
A policy set contains a number of connected policies.</p>
</div>
<div class="sect3">
<h4 id="policy-structure"><a class="anchor" href="#policy-structure"></a>Policy Structure</h4>
<div class="paragraph">
<p>A SAPL policy consists of optional <strong>imports</strong>,  a <strong>name</strong>, an <strong>entitlement</strong> specification, an optional <strong>target expression</strong>, an optional <strong>body</strong> with one or more statements, and optional sections for <strong>obligation</strong>, <strong>advice</strong> and <strong>transformation</strong>. An example of a simple policy is:</p>
</div>
<div class="listingblock">
<div class="title">Sample SAPL Policy</div>
<div class="content">
<pre class="CodeRay highlight"><code>import filter as filter <i class="conum" data-value="1"></i><b>(1)</b>

policy "test_policy" <i class="conum" data-value="2"></i><b>(2)</b>
permit <i class="conum" data-value="3"></i><b>(3)</b>
    subject.id == "anId" | action == "anAction" <i class="conum" data-value="4"></i><b>(4)</b>
where
    var variable = "anAttribute";
    subject.attribute == variable; <i class="conum" data-value="5"></i><b>(5)</b>
obligation
    "logging:log_access" <i class="conum" data-value="6"></i><b>(6)</b>
advice
    "logging:inform_admin" <i class="conum" data-value="7"></i><b>(7)</b>
transform
    resource.content |- filter.blacken <i class="conum" data-value="8"></i><b>(8)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Imports (optional)</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Name</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Entitlement</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Target Expression (optional)</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Body (optional)</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>Obligation (optional)</td>
</tr>
<tr>
<td><i class="conum" data-value="7"></i><b>7</b></td>
<td>Advice (optional)</td>
</tr>
<tr>
<td><i class="conum" data-value="8"></i><b>8</b></td>
<td>Transformation (optional)</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="policy-set-structure"><a class="anchor" href="#policy-set-structure"></a>Policy Set Structure</h4>
<div class="paragraph">
<p>A SAPL policy set contains optional <strong>imports</strong>, a <strong>name</strong>, a <strong>combining algorithm</strong>, an optional <strong>target expression</strong>, optional <strong>variable definitions</strong> and a list of <strong>policies</strong>. The following example shows a simple policy set with two policies:</p>
</div>
<div class="listingblock">
<div class="title">Sample SAPL Policy Set</div>
<div class="content">
<pre class="CodeRay highlight"><code>import filter.* <i class="conum" data-value="1"></i><b>(1)</b>

set "test_policy_set" <i class="conum" data-value="2"></i><b>(2)</b>
deny-unless-permit <i class="conum" data-value="3"></i><b>(3)</b>
for resource.type == "aType" <i class="conum" data-value="4"></i><b>(4)</b>
var dbUser = "admin";<i class="conum" data-value="5"></i><b>(5)</b>

    policy "test_permit_admin" <i class="conum" data-value="6"></i><b>(6)</b>
    permit subject.function == "admin"

    policy "test_permit_read" <i class="conum" data-value="7"></i><b>(7)</b>
    permit action == "read"
    transform resource |- blacken</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Imports (optional)</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Name</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Combining Algorithm</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Target Expression (optional)</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Variable Assignments (optional)</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>Policy 1</td>
</tr>
<tr>
<td><i class="conum" data-value="7"></i><b>7</b></td>
<td>Policy 2</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="imports"><a class="anchor" href="#imports"></a>Imports</h3>
<div id="imports" class="paragraph">
<p>SAPL provides access to functions or attribute finders stored in libraries. The names of those libraries usually consist of different parts separated by periods (e.g. <code>sapl.pip.http</code> - a library containing functions to obtain attributes through HTTP requests). In policy documents, the functions and finders can be accessed by their fully qualified name, i.e. the name of the library followed by a period (<code>.</code>) and the function or finder name, e.g. <code>sapl.pip.http.get</code>.</p>
</div>
<div class="paragraph">
<p>For any SAPL top level document (i.e. a policy set or a policy which is not part of a policy set) any number of imports can be specified. Imports allow using a shorter name instead of the fully qualified name for a function or an attribute finder within a SAPL document. Thus imports can make policy sets and policies easier to read and write.</p>
</div>
<div class="paragraph">
<p>Each import statement starts with the keyword <code>import</code>.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Basic Import</strong>: A function or an attribute finder can be imported by providing its fully qualified name (e.g. <code>import sapl.pip.http.get</code>). It will be available under its simple name (in the example: <code>get</code>) in the whole SAPL document.</p>
</li>
<li>
<p><strong>Wildcard Import</strong>: All functions or attribute finders from a library can be imported by providing an asterisk instead of a function or finder name (e.g. <code>import sapl.pip.http.*</code>). All functions or finders from the library will be available under their simple names (in the example: <code>get</code>).</p>
</li>
<li>
<p><strong>Library Alias Import</strong>: All functions or attribute finders from a library can be imported by providing the library name followed by <code>as</code> and an alias, e.g. <code>import sapl.pip.http as rest</code>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The SAPL document can contain any number of imports, e.g.</p>
</div>
<div class="listingblock">
<div class="title">Sample Imports</div>
<div class="content">
<pre class="CodeRay highlight"><code>import sapl.pip.http.*
import filter.blacken
import simple.append

policy "sample"
...</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="sapl-policy"><a class="anchor" href="#sapl-policy"></a>SAPL Policy</h3>
<div id="policy" class="paragraph">
<p>This section describes the elements of a SAPL policy in more detail. A policy contains an entitlement (<code>permit</code> or <code>deny</code>) and can be evaluated against an authorization subscription. If the conditions in the target expression and in the body are fulfilled, the policy evaluates to its entitlement. Otherwise it evaluates to <code>NOT_APPLICABLE</code> (if one of the conditions is not satisfied) or <code>INDETERMINATE</code> (if an error occurred).</p>
</div>
<div class="paragraph">
<p>A SAPL policy starts with the keyword <code>policy</code>.</p>
</div>
<div class="sect3">
<h4 id="name"><a class="anchor" href="#name"></a>Name</h4>
<div class="paragraph">
<p>The keyword <code>policy</code> is followed by the policy name. The name is a string <em>identifying</em> the policy, thus it has to be unique. Accordingly in systems with many policy sets and policies it is recommended to use a schema to create names (e.g., <code>"policy:patientdata:permit-doctors-read"</code>).</p>
</div>
</div>
<div class="sect3">
<h4 id="entitlement"><a class="anchor" href="#entitlement"></a>Entitlement</h4>
<div class="paragraph">
<p>SAPL expects an entitlement specification. This can either be <code>permit</code> or <code>deny</code>. The entitlement is the value which the policy evaluates to if the policy is applicable to the authorization subscription, i.e., if both the conditions in the policy&#8217;s target expression and in the policy body are satisfied.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Since multiple policies can be applicable and the combining algorithm can be chosen, it might make a difference whether there is an explicit <code>deny</code>-policy or whether there is just no permitting policy for a certain situation.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="target-expression"><a class="anchor" href="#target-expression"></a>Target Expression</h4>
<div class="paragraph">
<p>Subsequent to the entitlement, an <strong>optional</strong> target expression can be specified. This is a condition for applying the policy, hence an expression which must evaluate to either <code>true</code> or <code>false</code>. Which elements are allowed in SAPL expressions is described <a href="#expressions">below</a>.</p>
</div>
<div class="paragraph">
<p>If the target expression evaluates to <code>true</code> for a certain authorization subscription, the policy <em>matches</em> this subscription. A missing target expression makes the policy match any subscription.</p>
</div>
<div class="paragraph">
<p>A matching policy whose conditions in the body evaluate to <code>true</code> is called <em>applicable</em> to an authorization subscription and returns its entitlement. Both target expression and body define conditions which must be satisfied for the policy to be applicable. Although they seem to serve a similar purpose there is an important difference: For an authorization subscription the target expression of each top level document is checked in order to select policies matching the subscription from a possibly large set of policy documents. Indexing mechanisms may be used to fulfill this task efficiently.</p>
</div>
<div class="paragraph">
<p>Accordingly, there are two limitations regarding the elements allowed in the target:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>As lazy evaluation deviates from boolean logic and prevents effective indexing, the logical operators <code>&amp;&amp;</code> and <code>||</code> may not be used. Instead, the target needs to make use of the operators <code>&amp;</code> and <code>|</code>, for which eager evaluation is applied.</p>
</li>
<li>
<p><a href="#attribute-finders">Attribute finder steps</a> which have access to environment variables and may contact external PIPs are not allowed in the target. Yet functions may be used because their output only depends on the arguments passed.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="body"><a class="anchor" href="#body"></a>Body</h4>
<div class="paragraph">
<p>The policy body is <strong>optional</strong> and starts with the keyword <code>where</code>. It contains one or more statements each of which must evaluate to <code>true</code> for the policy to apply to a certain authorization subscription. Accordingly the body extends the condition in the target expression and further limits the policy&#8217;s applicability.</p>
</div>
<div class="paragraph">
<p>A statement within the body can either be a variable assignment which makes a variable available under a certain name (and always evaluates to <code>true</code>)</p>
</div>
<div class="listingblock">
<div class="title">Sample Variable Assignment</div>
<div class="content">
<pre class="CodeRay highlight"><code>var a_name = expression;</code></pre>
</div>
</div>
<div class="paragraph">
<p>or a condition, i.e., an expression that evaluates to <code>true</code> or <code>false</code>.</p>
</div>
<div class="listingblock">
<div class="title">Sample Condition</div>
<div class="content">
<pre class="CodeRay highlight"><code>a_name == "a_string";</code></pre>
</div>
</div>
<div class="paragraph">
<p>Each statement is concluded with a semicolon <code>;</code>.</p>
</div>
<div class="paragraph">
<p>There are no restrictions on the syntax elements allowed in the policy body. Lazy evaluation is used for the conjunction of the statements - i.e., if one statement evaluates to <code>false</code>, the policy returns the deicision <code>NOT_APPLICABLE</code>, even if future statements would cause an error.</p>
</div>
<div class="paragraph">
<p>If the body is missing (or does not contain any condition statement) the policy is applicable to any authorization subscription which the policy matches (i.e., for which the target expression evaluates to <code>true</code>).</p>
</div>
<div class="sect4">
<h5 id="variable-assignment"><a class="anchor" href="#variable-assignment"></a>Variable Assignment</h5>
<div id="value-assignment" class="paragraph">
<p>A variable assignment starts with the keyword <code>var</code>, followed by an identifier under which the assigned value should be available, followed by <code>=</code> and an expression.</p>
</div>
<div class="paragraph">
<p>After a variable assignment, the result of evaluating the expression can be used in later conditions within the same policy under the specified name. This is useful because it allows to execute time consuming calculations or requests to external attribute stores only once although the result can be used in multiple expressions. Besides it can make policies shorter and more readable.</p>
</div>
<div class="paragraph">
<p>The expression can make use of any element of the SAPL expression language, especially of attribute finder steps which are not allowed in the target expression.</p>
</div>
<div class="paragraph">
<p>The value assignment statement always evaluates to <code>true</code>.</p>
</div>
</div>
<div class="sect4">
<h5 id="condition"><a class="anchor" href="#condition"></a>Condition</h5>
<div class="paragraph">
<p>A condition statement simply consists of an expression that has to evaluate to <code>true</code> or <code>false</code>.</p>
</div>
<div class="paragraph">
<p>The expression can make use of any element of the SAPL expression language, especially of attribute finder steps which are not allowed in the target expression. Conditions in the policy body are used to further limit the applicability of a policy.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="obligation-2"><a class="anchor" href="#obligation-2"></a>Obligation</h4>
<div class="paragraph">
<p>An <strong>optional</strong> obligation expression contains a task which the PEP must fulfill before granting or denying access. It consists of the keyword <code>obligation</code> followed by an expression.</p>
</div>
<div class="paragraph">
<p>A common situation in which obligations are useful are <em>Break the Glass Scenarios</em>. Assuming in case of an emergency a doctor should also have access to medical records that she normally cannot read. However this emergency access has to be logged in order to prevent abuse. In this situation, logging is a requirement for granting access and therefore must be commanded in an obligation.</p>
</div>
<div class="paragraph">
<p>Obligations are only returned in the authorization decision if the decision is <code>PERMIT</code> or <code>DENY</code>. The PDP simply collects all obligations from policies evaluating to one of these entitlements. Depending on the final decision, the obligations and advice which belong to this decision are included in the authorization decision object. It does not matter if the obligation is described with a string (like <code>"create_emergency_access_log"</code>) or an object (like <code>{ "task" : "create_log", "content" : "emergency_access" }</code>) or another JSON value - only the PEP must be implemented in a way that it knows how to process these obligations.</p>
</div>
</div>
<div class="sect3">
<h4 id="advice-2"><a class="anchor" href="#advice-2"></a>Advice</h4>
<div class="paragraph">
<p>An <strong>optional</strong> advice expression is treated similarly to an obligation expression. Unlike obligations, fulfilling the described tasks in advice is not a requirement for granting or denying access. The advice expression consists of the keyword <code>advice</code> followed by any expression.</p>
</div>
<div class="paragraph">
<p>If the final decision is <code>PERMIT</code> or <code>DENY</code>, advice from all policies evaluating to this decision is included in the authorization decision object by the PDP.</p>
</div>
</div>
<div class="sect3">
<h4 id="transformation"><a class="anchor" href="#transformation"></a>Transformation</h4>
<div class="paragraph">
<p>An <strong>optional</strong> transformation statement is preluded with the keyword <code>transform</code> and followed by an expression. If a transformation statement is supplied and the policy evaluates to <code>permit</code>, the result of evaluating the expression will be returned as <code>resource</code> in the authorization decision object.</p>
</div>
<div class="paragraph">
<p>Accordingly, a transformation statement might be used to hide certain information (e.g., <em>a doctor can access patient data but should not see bank account details</em>). This can be reached by applying a filter to the original resource which removes or blackens certain attributes. Thus SAPL allows for <strong>fine grained</strong> or <strong>field level</strong> access control without the need to treat each attribute as a resource and write an own policy for it.</p>
</div>
<div class="paragraph">
<p>The original resource is accessible via the identifier <code>resource</code> and can be filtered as follows:</p>
</div>
<div class="listingblock">
<div class="title">Transformation Example</div>
<div class="content">
<pre>transform
    resource |- {
        @.someValue : remove,
        @.anotherValue : filter.blacken
    }</pre>
</div>
</div>
<div class="paragraph">
<p>The example would remove the attribute <code>someValue</code> and blacken the value of the attribute <code>anotherValue</code>. The filtering functions are described in more detail <a href="#filtering">below</a>.</p>
</div>
<div class="paragraph">
<p>It is not possible to combine multiple transformation statements through multiple policies. Each combining algorithm in SAPL will not return the decision <code>PERMIT</code> if there are more than one policies evaluating to <code>PERMIT</code> and at least one of them contains a transformation statement (this is called <em>transformation uncertainty</em>). For more details, <a href="#combining-algorithms">see below</a>.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="sapl-policy-set"><a class="anchor" href="#sapl-policy-set"></a>SAPL Policy Set</h3>
<div class="paragraph">
<p>While a policy can either be a top level SAPL document or be contained in a policy set, policy sets are always top level documents. I.e., for evaluating an authorization subscription, the PDP evaluates any existing policy set. Policy sets are evaluated against an authorization subscription by checking their target expression, if applicable evaluating their policies and if necessary combining multiple decision according to a combining algorithm specified in the policy set. Finally, similar to policies, policy sets evaluate to either <code>PERMIT</code>, <code>DENY</code>, <code>NOT_APPLICABLE</code> or <code>INDETERMINATE</code>.</p>
</div>
<div class="paragraph">
<p>Policy sets are used to structure multiple policies and provide an order for the policies they contain. Thus their policies can be evaluated one after another.</p>
</div>
<div class="paragraph">
<p>A policy set definition starts with the keyword <code>set</code>.</p>
</div>
<div class="sect3">
<h4 id="name-2"><a class="anchor" href="#name-2"></a>Name</h4>
<div class="paragraph">
<p>The keyword <code>set</code> is followed by the policy set name. The name is a string <em>identifying</em> the policy set. Thus it has to be unique within all policy sets and policies.</p>
</div>
</div>
<div class="sect3">
<h4 id="combining-algorithm"><a class="anchor" href="#combining-algorithm"></a>Combining Algorithm</h4>
<div class="paragraph">
<p>The name is followed by a combining algorithm. This algorithm describes how to combine the results from evaluating every policy to come to a result for the policy set.</p>
</div>
<div class="paragraph">
<p>Possible values are:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>deny-unless-permit</code></p>
</li>
<li>
<p><code>permit-unless-deny</code></p>
</li>
<li>
<p><code>only-one-applicable</code></p>
</li>
<li>
<p><code>deny-overrides</code></p>
</li>
<li>
<p><code>permit-overrides</code></p>
</li>
<li>
<p><code>first-applicable</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The combining algorithms are described in more detail <a href="#combining-algorithms">later</a>.</p>
</div>
</div>
<div class="sect3">
<h4 id="target-expression-2"><a class="anchor" href="#target-expression-2"></a>Target Expression</h4>
<div class="paragraph">
<p>Subsequent to the combining algorithm, an <strong>optional</strong> target expression can be specified. The target expression is a condition for applying the policy set. It starts with the keyword <code>for</code> followed by an expression which must evaluate to either <code>true</code> or <code>false</code>. If the condition evaluates to <code>true</code> for a certain authorization subscription the policy set <em>matches</em> this subscription. In case the target expression is missing the policy set matches any authorization subscription.</p>
</div>
<div class="paragraph">
<p>The policy sets' target expression is used to select matching policy sets from a large collection of policy documents before evaluating them. As this needs to be done efficiently, there are no <a href="#attribute-finders">attribute finder steps</a> allowed at this place.</p>
</div>
</div>
<div class="sect3">
<h4 id="variable-assignments"><a class="anchor" href="#variable-assignments"></a>Variable Assignments</h4>
<div id="policy-set-value-assignments" class="paragraph">
<p>The target expression can be followed by any number of variable assignments. Variable assignments are used to make a value available in all subsequent policies under a certain name. An assignment starts with the keyword <code>var</code>, followed by an identifier under which the assigned value should be available, followed by <code>=</code> and an expression (see <a href="#value-assignment">above</a>).</p>
</div>
<div class="paragraph">
<p>Since variable assignments are evaluated only if the policy set&#8217;s target matches, attribute finders may be used.</p>
</div>
<div class="paragraph">
<p>In case a policy within the policy set assigns a variable already assigned in the policy set, the assignment in the policy overwrites the old. The overwritten value only exists within the particular policy. In other policies, the variable has the value defined in the policy set.</p>
</div>
</div>
<div class="sect3">
<h4 id="policies"><a class="anchor" href="#policies"></a>Policies</h4>
<div class="paragraph">
<p>The policy set must contain one or more policies. <a href="#policy">See above</a> how to describe a SAPL policy. If the combining algorithm <code>first-applicable</code> is used, the policies are evaluated in the order in which they appear in the policy set.</p>
</div>
<div class="paragraph">
<p>In each policy, functions and attribute finders imported at the beginning of the SAPL document can be used under their shorter name. All variables assigned for the policy set (see <a href="#policy-set-value-assignments">Value Assignments</a>) are available within the policies, but can be overwritten for a particular policy. The same applies to imports - imports at the policy level overwrite imports defined for the policy set, but are only valid for the particular policy.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="language-elements"><a class="anchor" href="#language-elements"></a>Language Elements</h3>
<div class="paragraph">
<p>The descriptions of the policy and policy set structure sometimes refers to language elements like identifiers and strings. These elements are explained in this section.</p>
</div>
<div class="sect3">
<h4 id="identifiers"><a class="anchor" href="#identifiers"></a>Identifiers</h4>
<div id="identifiers" class="paragraph">
<p>Multiple elements in policies or policy sets require identifiers. E.g. a variable assignments expects an identifier after the keyword <code>var</code> - the name under which the assigned value will be available.</p>
</div>
<div class="paragraph">
<p>An identifier only consists of alphanumeric characters, <code>_</code> and <code>$</code> and must not start with a number.</p>
</div>
<div class="listingblock">
<div class="title">Valid Identifiers</div>
<div class="content">
<pre class="CodeRay highlight"><code>a_long_name
aLongName
$name
_name
name123</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Invalid Identifiers</div>
<div class="content">
<pre class="CodeRay highlight"><code>a#name
1name</code></pre>
</div>
</div>
<div class="paragraph">
<p>A caret <code>^</code> before the identifier may be used to avoid a conflict with SAPL keywords.</p>
</div>
</div>
<div class="sect3">
<h4 id="strings"><a class="anchor" href="#strings"></a>Strings</h4>
<div class="paragraph">
<p>Whenever strings are expected, the SAPL document must contain any sequence of characters enclosed by single quotes <code>'</code> or double quotes <code>"</code>. Any enclosing quote character occurring in the string must be escaped by a preceding <code>\</code>, e.g., <code>"the name is \"John Doe\""</code>.</p>
</div>
</div>
<div class="sect3">
<h4 id="comments"><a class="anchor" href="#comments"></a>Comments</h4>
<div class="paragraph">
<p>Comments are used to store information in a SAPL document which is only intended for human readers and has no meaning for the PDP. Comments are simply ignored when the PDP evaluates a document.</p>
</div>
<div class="paragraph">
<p>SAPL supports single line and multi line comments. A single line comment starts with <code>//</code> and ends at the end of the line, no matter which characters follow.</p>
</div>
<div class="listingblock">
<div class="title">Sample Single Line Comment</div>
<div class="content">
<pre class="CodeRay highlight"><code>policy "test" // a policy for testing</code></pre>
</div>
</div>
<div class="paragraph">
<p>Multi line comments start with <code>/*</code> and end with <code>*/</code>. Everything in between is ignored.</p>
</div>
<div class="listingblock">
<div class="title">Sample Multi Line Comment</div>
<div class="content">
<pre class="CodeRay highlight"><code>policy "test"
/* A policy for testing.
Remove before deployment! */</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="sapl-expressions"><a class="anchor" href="#sapl-expressions"></a>SAPL Expressions</h3>
<div id="expressions" class="paragraph">
<p>To ensure flexibility, various parts of a policy can be <strong>expressions</strong> which are evaluated at runtime. E.g., a policy&#8217;s target has to be an expression evaluating to <code>true</code> or <code>false</code>. SAPL contains a uniform expression language which offers various useful features while still being easy to read and write.</p>
</div>
<div class="paragraph">
<p>Since JSON is the base data model, each expression evaluates to a JSON data type. These data types and the expression syntax are described in this section.</p>
</div>
<div class="sect3">
<h4 id="json-data-types"><a class="anchor" href="#json-data-types"></a>JSON Data Types</h4>
<div class="paragraph">
<p>SAPL is based on the <strong>JavaScript Object Notation</strong> or <strong>JSON</strong>, an <a href="http://www.ecma-international.org/publications/files/ECMA-ST/ECMA-404.pdf">ECMA Standard</a> for the representation of structured data.
Any value occuring within the SAPL language is a JSON data type and any expression within a policy evaluates to a JSON data type.
The types and their JSON notations are:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Primitive Types</p>
<div class="ulist">
<ul>
<li>
<p><strong>Number</strong>: A signed decimal number, e.g., <code>-1.9</code>. There is no distinction between integer and floating-point numbers. In case an integer is expected (e.g. for an numeric index), the decimal number is rounded to an integer number.</p>
</li>
<li>
<p><strong>String</strong>: A sequence of zero or more characters, written in double or single quotes, e.g. <code>"a string"</code> or <code>'a string'</code>.</p>
</li>
<li>
<p><strong>Boolean</strong>: Either <code>true</code> or <code>false</code>.</p>
</li>
<li>
<p><strong>null</strong>: Marks an empty value, <code>null</code>.</p>
</li>
</ul>
</div>
</li>
<li>
<p>Structured Types</p>
<div class="ulist">
<ul>
<li>
<p><strong>Object</strong>: An unordered set of name/value pairs. The name is a string, the value has to be one of the available data types. It can also be an object itself. The name/value pair is also called attribute of the object. E.g.</p>
<div class="listingblock">
<div class="content">
<pre>{
    "firstAttribute" : "first value",
    "secondAttribute" : 123
}</pre>
</div>
</div>
</li>
<li>
<p><strong>Array</strong>: An ordered sequence of zero or more values of any JSON data type. E.g.</p>
<div class="listingblock">
<div class="content">
<pre>[
    "A value",
    123,
    {"attribute" : "value"}
]</pre>
</div>
</div>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="expression-types"><a class="anchor" href="#expression-types"></a>Expression Types</h4>
<div class="paragraph">
<p>SAPL knows <strong>basic expressions</strong> and <strong>operator expressions</strong> (created from other expressions using operators).</p>
</div>
<div class="paragraph">
<p>A <strong>basic expression</strong> is either a</p>
</div>
<div id="basic-relative" class="ulist">
<ul>
<li>
<p><strong>Value Expression</strong>: a value explicitly defined in the corresponding JSON notation (e.g. <code>"a value"</code>)</p>
</li>
<li>
<p><strong>Identifier Expression</strong>: the name of a variable or of a authorization subscription attribute (<code>subject</code>, <code>resource</code>, <code>action</code> or <code>environment</code>)</p>
</li>
<li>
<p><strong>Function Expression</strong>: a function call (e.g. <code>simple.get_minimum(resource.array)</code>)</p>
</li>
<li>
<p><strong>Relative Expression</strong>: <code>@</code>, which refers to a certain value depending on the context</p>
</li>
<li>
<p><strong>Grouped Expression</strong>: any expression enclosed in parantheses, e.g. <code>(1 + 1)</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Each of these basic expressions can contain one or more <strong>selection steps</strong> (e.g., <code>subject.name</code> which is the identifier expression <code>subject</code> followed by the selection step <code>.name</code> selecting the value of the <code>name</code> attribute). Eventually a basic expression can contain a <strong>filter component</strong> (<code>|- Filter</code>) which will be applied to the evaluation result. If the expression evaluates to an array, instead of applying a filter each item can be transformed using a <strong>subtemplate component</strong> (<code>:: Subtemplate</code>).</p>
</div>
<div class="paragraph">
<p><strong>Operator expressions</strong> can be constructed using prefix or infix <strong>operators</strong> (e.g., <code>1 + subject.age</code> or <code>! subject.isBlocked</code>). SAPL supports infix and prefix operators. They may be applied in connection with any expression. An operator expression within parantheses (e.g., <code>(1 + subject.age)</code>) is a basic expression again and thus may contain selection steps, filter or subtemplate statements.</p>
</div>
<div class="sect4">
<h5 id="value-expressions"><a class="anchor" href="#value-expressions"></a>Value Expressions</h5>
<div class="paragraph">
<p>A basic value expression is the most simple type. The value is denoted in the corresponding JSON format.</p>
</div>
<div class="paragraph">
<p><code>true</code>, <code>false</code> and <code>null</code> are value expressions as well as <code>"a string"</code>, <code>'a string'</code> or any number (like <code>6</code> or <code>100.51</code>).</p>
</div>
<div class="paragraph">
<p>For denoting objects the keys need to be strings and the values can be any expression, e.g.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>{
    "id" : (3+5),
    "name" : functions.generate_name()
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>For arrays the items can be any expression, e.g.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>[
    (3+5),
    subject.name
]</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="identifier-expressions"><a class="anchor" href="#identifier-expressions"></a>Identifier Expressions</h5>
<div class="paragraph">
<p>A basic identifier expression consists of the name of a variable or the name of an authorization subscription attribute (i.e., <code>subject</code>, <code>resource</code>, <code>action</code> or <code>environment</code>).</p>
</div>
<div class="paragraph">
<p>It evaluates to the variable&#8217;s or the attribute&#8217;s value.</p>
</div>
</div>
<div class="sect4">
<h5 id="function-expressions"><a class="anchor" href="#function-expressions"></a>Function Expressions</h5>
<div class="paragraph">
<p>A basic function expression consists of a function name and any number of arguments between parentheses which are separated by commas. The arguments have to be expressions, e.g.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>library.a_function(subject.name, (environment.day_of_week + 1))</code></pre>
</div>
</div>
<div class="paragraph">
<p>Each function is available under its fully qualified name. The fully qualified name starts with the library name, consisting of one or more identifiers separated by periods <code>.</code> (e.g. <code>sapl.functions.simple</code>). The library name is followed by a period <code>.</code> and an identifier for the function name (e.g. <code>sapl.functions.simple.append</code>). Which function libraries are available depends on the configuration of the PDP.</p>
</div>
<div class="paragraph">
<p><a href="#imports">Imports</a> at the beginning of a SAPL document can be used to make functions available under shorter names. If a function is imported via a basic import or a wildcard import, it is available under its function name (e.g., <code>append</code>). A library alias import provides an alternative library name (e.g., with the import statement <code>import sap.functions.simple as simple</code>, the append function would be available under <code>simple.append</code>.</p>
</div>
<div class="paragraph">
<p>If there are no arguments passed to the function, empty parentheses have to be denoted (e.g., <code>random_number()</code>).</p>
</div>
<div class="paragraph">
<p>When evaluating a function expression the expressions representing the function call arguments are evaluated first. Afterwards the results are passed as arguments to the function. The expression evaluates to the function&#8217;s return value.</p>
</div>
</div>
<div class="sect4">
<h5 id="relative-expressions"><a class="anchor" href="#relative-expressions"></a>Relative Expressions</h5>
<div class="paragraph">
<p>The basic relative expression is the <code>@</code> symbol.</p>
</div>
<div class="paragraph">
<p>It can be only used in various contexts. Those contexts are characterized by an implicit loop with <code>@</code> dynamically evaluating to the current element. Assuming the variable <code>array</code> contains an array with multiple numbers. The expression <code>array[?(@ &gt; 10)]</code> can be used to return any element greater than 10. In this context, <code>@</code> evaluates to the array item for which the condition is currently checked.</p>
</div>
<div class="paragraph">
<p>The contexts in which <code>@</code> can be used are:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Expression within a condition step (<code>@</code> evaluates to the array item or attribute value for which the condition expression is currently evaluated)</p>
</li>
<li>
<p>Subtemplate (<code>@</code> evaluates to the array item which is currently going to be replaced by the subtemplate)</p>
</li>
<li>
<p>Arguments of a filter function if <code>each</code> is used (<code>@</code> evaluates to the array item to which the filter function is going to be applied)</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect3">
<h4 id="operators"><a class="anchor" href="#operators"></a>Operators</h4>
<div class="paragraph">
<p>SAPL provides a collection of arithmetic, comparison, logical, string and filtering operators which can be used to build expressions from other expressions.</p>
</div>
<div class="sect4">
<h5 id="arithmetic-operators"><a class="anchor" href="#arithmetic-operators"></a>Arithmetic Operators</h5>
<div class="paragraph">
<p>Assuming <code>exp1</code> and <code>exp2</code> are expressions evaluating to numbers, the following operators can be applied. All of them evaluate to a number.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>-exp1</code> (negation)</p>
</li>
<li>
<p><code>exp1 * exp2</code> (multiplication)</p>
</li>
<li>
<p><code>exp1 / exp2</code> (division)</p>
</li>
<li>
<p><code>exp1 + exp2</code> (addition)</p>
</li>
<li>
<p><code>exp1 - exp2</code> (subtraction)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>An expression can contain multiple arithmetic operators. The order in which they are evaluated can be specified using <strong>parentheses</strong>, e.g., <code>(1 + 2) * 3</code>.</p>
</div>
<div class="paragraph">
<p>In case multiple operators are used without parentheses (e.g., <code>4 + 3 * 2</code>) the <strong>operator precedence</strong> determines about how the expression is evaluated. Operators with higher precedence are evaluated first. The following precedence is assigned to arithmetic operators:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>-</code> (negation): precedence <strong>4</strong></p>
</li>
<li>
<p><code>*</code> (multiplication), <code>/</code> (division): precedence <strong>2</strong></p>
</li>
<li>
<p><code>+</code> (addition), <code>-</code> (subtraction): precedence <strong>1</strong></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>As <code>*</code> has a higher precedence than <code>+</code>, <code>4 + 3 * 2</code> would be evaluated like <code>4 + (3 * 2)</code>.</p>
</div>
<div class="paragraph">
<p>Except for the negation, multiple operators with the same precedence (e.g., <code>5 - 2 + 1</code>) are <strong>left-associative</strong>, i.e., <code>5 - 2 + 1</code> is evaluated like <code>(5 - 2) + 1</code>. The negation is non-associative, i.e., <code>--1</code> needs to be replaced by <code>-(-1)</code>.</p>
</div>
</div>
<div class="sect4">
<h5 id="comparison-operators"><a class="anchor" href="#comparison-operators"></a>Comparison Operators</h5>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Number Comparison</p>
<div class="paragraph">
<p>Assuming <code>exp1</code> and <code>exp2</code> are expressions evaluating to numbers, the following operators can be applied. All of them evaluate to <code>true</code> or <code>false</code>.</p>
</div>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p><code>exp1 &lt; exp2</code> (<code>true</code> if <code>exp2</code> is greater than <code>exp1</code>)</p>
</li>
<li>
<p><code>exp1 &gt; exp2</code> (<code>true</code> if <code>exp1</code> is greater than <code>exp2</code>)</p>
</li>
<li>
<p><code>exp1 &lt;= exp2</code> (<code>true</code> if <code>exp2</code> is equal to or greater than <code>exp1</code>)</p>
</li>
<li>
<p><code>exp1 &gt;= exp2</code> (<code>true</code> if <code>exp1</code> is equal to or greater than <code>exp2</code>)</p>
</li>
</ol>
</div>
</li>
<li>
<p>Equals</p>
<div class="paragraph">
<p>Assuming <code>exp1</code> and <code>exp2</code> are expressions, the equals-operator can be used to compare the results:</p>
</div>
<div class="paragraph">
<p><code>exp1 == exp2</code></p>
</div>
<div class="paragraph">
<p>The expression evaluates to <code>true</code> if the result of evaluating <code>exp1</code> is equal to the result of evaluating <code>exp2</code>.</p>
</div>
</li>
<li>
<p>Regular Expression</p>
<div class="paragraph">
<p>Assuming <code>exp1</code> and <code>exp2</code> are expressions evaluating to strings, the regular expression match operator can be used:</p>
</div>
<div class="paragraph">
<p><code>exp1 =~ exp2</code></p>
</div>
<div class="paragraph">
<p>The expression evaluates to <code>true</code> if the result of evaluating <code>exp1</code> matches the pattern contained in the result of evaluating <code>exp2</code>. The pattern needs to be specified according to the <a href="https://docs.oracle.com/javase/7/docs/api/java/util/regex/Pattern.html">java.util.regex package</a>.</p>
</div>
</li>
<li>
<p><code>in</code> (element of)</p>
<div class="paragraph">
<p>Assuming <code>exp1</code> is an expression and <code>exp2</code> is an expression evaluating to an array, the <code>in</code> operator can be used:</p>
</div>
<div class="paragraph">
<p><code>exp1 in exp2</code></p>
</div>
<div class="paragraph">
<p>The expression evaluates to <code>true</code> if the array <code>exp2</code> evaluates to contains the result of evaluating <code>exp1</code>. Otherwise the expression evaluates to <code>false</code>.</p>
</div>
</li>
<li>
<p>Precedence and Associativity</p>
<div class="paragraph">
<p>All comparison operators have the precedence <strong>3</strong>. This is important for combining them with logical operators (see below).</p>
</div>
<div class="paragraph">
<p><code>&lt;</code>, <code>&gt;</code>, <code>&#8656;</code>, <code>&gt;=</code>, <code>==</code>,<code>=~</code> and <code>in</code> are <strong>non-associative</strong>, i.e., an expression may not contain multiple comparison operators (like <code>3 &lt; var &lt; 5</code>). However they can be combined with logical operators which have a different precedence (thus, the faulty example could be replaced by <code>3 &lt; var &amp;&amp; var &lt; 5</code>).</p>
</div>
</li>
</ol>
</div>
</div>
<div class="sect4">
<h5 id="logical-operators"><a class="anchor" href="#logical-operators"></a>Logical Operators</h5>
<div class="paragraph">
<p>Assuming <code>exp1</code> and <code>exp2</code> are expressions evaluating to <code>true</code> or <code>false</code>, the following operators can be applied. The new expression evaluates to <code>true</code> or <code>false</code>:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>!exp1</code> (negation), precedence <strong>4</strong></p>
</li>
<li>
<p><code>exp1 &amp;&amp; exp2</code> or <code>exp1 &amp; exp2</code> (logical AND), precedence <strong>2</strong></p>
</li>
<li>
<p><code>exp1 || exp2</code> or <code>exp1 | exp2</code> (logical OR), precedence <strong>1</strong></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The difference between <code>&amp;&amp;</code> and <code>&amp;</code> (or <code>||</code> and <code>|</code>) is that for <code>&amp;&amp;</code> lazy evaluation is used while <code>&amp;</code> causes eager evaluation. Using <code>&amp;&amp;</code>, if the left side evaluates to <code>false</code> and the right side would cause an error, the result of the operator is <code>false</code>, the right side is not evaluated. The same applies for <code>||</code> if the left side evaluates to <code>true</code>. In this case, the operator evaluates to <code>true</code>, even if the right side would cause an error - the right side is ignored if the result can already be determined. This is different for <code>&amp;</code> and <code>|</code> which always evaluate both sides first (eager evaluation). Whenever there is an error, the expression does not return a result. In a target expression, only the eager evaluation expressions <code>&amp;</code> and <code>|</code> can be used.</p>
</div>
<div class="paragraph">
<p>The operators are already listed in descending order of their <strong>precedence</strong>, i.e. <code>!</code> has the highest precedence followed by <code>&amp;&amp;</code>/<code>&amp;</code> and <code>||</code>/<code>|</code>. The order of evaluation can be changed by the use of parentheses.</p>
</div>
<div class="paragraph">
<p><code>&amp;&amp;</code> and <code>||</code> are left-associative, i.e., in case an expression contains multiple operators the leftmost operator is evaluated first. <code>!</code> is non-associative, i.e., <code>!!true</code> has to be replaced by <code>!(!true))</code>.</p>
</div>
</div>
<div class="sect4">
<h5 id="string-concatenation"><a class="anchor" href="#string-concatenation"></a>String Concatenation</h5>
<div class="paragraph">
<p>The operator <code>+</code> concatenates two strings, e.g. <code>"Hello" + " World!"</code> evaluates to <code>"Hello World!"</code>.</p>
</div>
<div class="paragraph">
<p>String concatenation is applied if the left operand is an expression evaluating to a string. If the right expression evaluates to a string as well, the two strings are concatenated. Otherwise an error is thrown.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="selection-steps"><a class="anchor" href="#selection-steps"></a>Selection Steps</h4>
<div class="paragraph">
<p>SAPL provides an easy way of accessing attributes of an object (or items of an array). The <strong>basic access</strong> mechanism has a similar syntax to programming languages like JavaScript or Java (e.g., <code>object.attribute</code>, <code>user.address.street</code> or <code>array[10]</code>). Beyond that SAPL offers <strong>extended possibilities</strong> for expressing more sophisticated queries against JSON structures (e.g., <code>persons[?(@.age &gt;= 50)]</code>).</p>
</div>
<div class="sect4">
<h5 id="overview-2"><a class="anchor" href="#overview-2"></a>Overview</h5>
<div class="paragraph">
<p>The following table provides an overview of the different types of selection steps.</p>
</div>
<div class="paragraph">
<p>Given that the following object is stored in the variable <code>object</code>:</p>
</div>
<div class="listingblock">
<div class="title">Structure of <code>object</code></div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="javascript">{
    <span class="key"><span class="delimiter">&quot;</span><span class="content">key</span><span class="delimiter">&quot;</span></span> : <span class="string"><span class="delimiter">&quot;</span><span class="content">value1</span><span class="delimiter">&quot;</span></span>,
    <span class="key"><span class="delimiter">&quot;</span><span class="content">array1</span><span class="delimiter">&quot;</span></span> : [
        { <span class="key"><span class="delimiter">&quot;</span><span class="content">key</span><span class="delimiter">&quot;</span></span> : <span class="string"><span class="delimiter">&quot;</span><span class="content">value2</span><span class="delimiter">&quot;</span></span> },
        { <span class="key"><span class="delimiter">&quot;</span><span class="content">key</span><span class="delimiter">&quot;</span></span> : <span class="string"><span class="delimiter">&quot;</span><span class="content">value3</span><span class="delimiter">&quot;</span></span> }
    ],
    <span class="key"><span class="delimiter">&quot;</span><span class="content">array2</span><span class="delimiter">&quot;</span></span> : [
        <span class="integer">1</span>, <span class="integer">2</span>, <span class="integer">3</span>, <span class="integer">4</span>, <span class="integer">5</span>
    ]
}</code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 1. Selection Steps Overview</caption>
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Expression</th>
<th class="tableblock halign-left valign-top">Returned Value</th>
<th class="tableblock halign-left valign-top">Explanation</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>object.key</code><br>
<code>object['key']</code><br>
<code>object["key"]</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>"value1"</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><strong>Key step</strong> in dot notation and bracket notation</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>object.array1[0]</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>{ "key" : "value2" }</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><strong>Index step</strong></p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>object.array2[-1]</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>5</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><strong>Index step</strong> with negative value n returns the n-th last element</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>object.*</code><br>
<code>object[*]</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>[
  "value1",
  [
    { "key" : "value2" },
    { "key" : "value3" }
  ],
  [ 1, 2, 3, 4, 5 ]
]</code></pre>
</div>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><strong>Wildcard step</strong> applied to an object returns an array with the value of each attribute - applied to an array it returns the array itself</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>object.array2[0:-2:2]</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>[ 1, 3 ]</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><strong>Array slicing step</strong> starting from first to second last element with a step size of two</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>object..key</code><br>
<code>object..['key']</code><br>
<code>object..["key"]</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>[ "value1", "value2", "value3" ]</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><strong>Recursive descent step</strong> looking for an attribute</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>object..[0]</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>[ { "key" : "value2" }, 1 ]</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><strong>Recursive descent step</strong> looking for an array index</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>object.array2[(3+1)]</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>5</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><strong>Expression step</strong> that evaluates to a number (index) - can also evaluate to an attribute name</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>object.array2[?(@&gt;2)]</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>[ 3, 4, 5 ]</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><strong>Condition step</strong> that evaluates to true/false, <code>@</code> is a reference to the currently examined item - can also be applied to an object</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>object.array2[2,3]</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>[ 3 , 4 ]</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><strong>Union step</strong> for more than one array index</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>object["key","array2"]</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>[ "value1", [ 1, 2, 3, 4, 5 ] ]</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><strong>Union step</strong> for more than one attribute</p>
</div></div></td>
</tr>
</tbody>
</table>
</div>
<div class="sect4">
<h5 id="basic-access"><a class="anchor" href="#basic-access"></a>Basic Access</h5>
<div class="paragraph">
<p>The basic access syntax is quite similar to accessing an object&#8217;s attributes in JavaScript or Java:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Attributes of an object</strong> can be accessed by their key (<strong>key step</strong>) using the <em>dot notation</em> (<code>resource.key</code>) or the <em>bracket notation</em> (<code>resource["key"]</code>,<code>resource['key']</code>). Both expressions return the value of the specified attribute. For using the dot notation the specified key has to be an <a href="#identifiers">identifier</a>. Otherwise the bracket notation with a string between square brackets is necessary, e.g., if the key contains whitespace characters (<code>resource['another key']</code>).</p>
</li>
<li>
<p><strong>Indices of an array</strong> may be accessed by putting the index between square brackets (<strong>index step</strong>, <code>array[3]</code>). The index can be a negative number <code>-n</code> which evaluates to the <code>n</code>-th element from the end of the array, and starting with -1 as the last element&#8217;s index. <code>array[-2]</code> would return the second last element of the Array <code>array</code>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Multiple selection steps can be <strong>chained</strong>. The steps are evaluated from left to right. Each step is applied to the result returned from the previous step.</p>
</div>
<div class="sidebarblock">
<div class="content">
<div class="paragraph">
<p><strong>Example</strong></p>
</div>
<div class="paragraph">
<p>The expression <code>object.array[2]</code> first selects the attribute with key <code>array</code> from the object <code>object</code> (first step). Then it returns the third element (index <code>2</code>) of that array (second step).</p>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="extended-possibilities"><a class="anchor" href="#extended-possibilities"></a>Extended Possibilities</h5>
<div class="paragraph">
<p>SAPL supports querying for specific parts of a JSON structure. Except for an <strong>expression step</strong>, all of these steps return an array since the number of elements found can vary. Even if only a single result is retrieved the expression returns an array containing one item.</p>
</div>
<div class="sect5">
<h6 id="expression-step-expression"><a class="anchor" href="#expression-step-expression"></a>Expression Step <code>[(Expression)]</code></h6>
<div class="paragraph">
<p>Returns the value of an attribute with a key or an array item with an index specified by an expression. <code>Expression</code> must evaluate to a string or a number. If <code>Expression</code> evaluates to a string, the selection can only be applied to an object. If <code>Expression</code> evaluates to a number, the selection can only be applied to an array.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The expression step can be used to refer to custom variables (<code>object.array[(anIndex+2)]</code>) or apply custom functions (<code>object.array[(max_value(object.array))]</code>.
</td>
</tr>
</table>
</div>
</div>
<div class="sect5">
<h6 id="wildcard-step-or"><a class="anchor" href="#wildcard-step-or"></a>Wildcard Step <code>.*</code> or <code>[*]</code></h6>
<div class="paragraph">
<p>Can be applied to an object or an array. When applied to an object, it returns an array containing all attribute values. As attributes of an object have no ordering, the sorting of the result is not defined. When applied to an array, the step just leaves the array untouched.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Applied to an object <code>{"key1":"value1", "key2":"value2"}</code>, the selection step <code>.*</code> or <code>[*]</code> returns the following array: <code>["value1", "value2"]</code> (possibly with a different sorting of the items).
Applied to an array <code>[1, 2, 3]</code>, the selection step <code>.<strong></code> or <code>[</strong>]</code> returns the original array <code>[1, 2, 3]</code>.
</td>
</tr>
</table>
</div>
</div>
<div class="sect5">
<h6 id="recursive-descent-step-key-key-1-or"><a class="anchor" href="#recursive-descent-step-key-key-1-or"></a>Recursive Descent Step <code>..key</code>, <code>..["key"]</code>, <code>..[1]</code>, <code>..*</code> or <code>..[*]</code></h6>
<div class="paragraph">
<p>Looks for the specified key or array index in the current object or array and, recursively, in its children (i.e., the values of its attributes or its items). The recursive descent step can be applied to both an object and an array. It returns an array containing all attribute values or array items found. If the specified key is an asterisk (<code>..<strong></code> or <code>[</strong>]</code>, wildcard), all attribute values and array items in the whole structure are returned.</p>
</div>
<div class="paragraph">
<p>As attributes of an object are not sorted, the sorting of items in the result array is not guaranteed.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Applied to an <code>object</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="javascript">{
    <span class="key"><span class="delimiter">&quot;</span><span class="content">key</span><span class="delimiter">&quot;</span></span> : <span class="string"><span class="delimiter">&quot;</span><span class="content">value1</span><span class="delimiter">&quot;</span></span>,
    <span class="key"><span class="delimiter">&quot;</span><span class="content">anotherkey</span><span class="delimiter">&quot;</span></span> : {
        <span class="key"><span class="delimiter">&quot;</span><span class="content">key</span><span class="delimiter">&quot;</span></span> : <span class="string"><span class="delimiter">&quot;</span><span class="content">value2</span><span class="delimiter">&quot;</span></span>
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>the selection step <code>object..key</code> returns the following array: <code>["value1", "value2"]</code> (any attribute value with key <code>key</code>, the items may be in a different order).</p>
</div>
<div class="paragraph">
<p>The wildcard selection step <code>object..<strong></code> or <code>object..[</strong>]</code> returns <code>["value1", {"key":"value2"}, "value2"]</code> (recursively each attribute value and array item in the whole structure <code>object</code>, the sorting may be different).</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect5">
<h6 id="condition-condition"><a class="anchor" href="#condition-condition"></a>Condition <code>[?(Condition)]</code></h6>
<div class="paragraph">
<p>Returns an array containing all attribute values or array items for which <code>Condition</code> evaluates to <code>true</code>. Can be applied to both an object (then it checks each attribute value) and an array (then it checks each item). <code>Condition</code> must be an expression, in which <a href="#basic-relative">relative expressions</a> starting with <code>@</code> can be used. <code>@</code> evaluates to the current attribute value or array item for which the condition is evaluated and can be followed by further selection steps.</p>
</div>
<div class="paragraph">
<p>As attributes have no order, the sorting of the result array of a condition step applied to an object is not specified.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Applied to the array <code>[1, 2, 3, 4, 5]</code>, the selection step <code>[?(@ &gt; 2)]</code> returns the array <code>[3, 4, 5]</code> (containing all values that are greater than 2).
</td>
</tr>
</table>
</div>
</div>
<div class="sect5">
<h6 id="array-slicing-startendstep"><a class="anchor" href="#array-slicing-startendstep"></a>Array Slicing <code>[Start:End:Step]</code></h6>
<div class="paragraph">
<p>The slice contains the items with indices between <code>Start</code> and <code>Stop</code> with <code>Start</code> being inclusive and <code>Stop</code> being exclusive. <code>Step</code> describes the distance between the elements to be included in the slice, i.e., with a <code>Step</code> of 2, only each second element would be included (with <code>Start</code> as the first element&#8217;s index). All parts except the first colon are optional. <code>Step</code> defaults to 1.</p>
</div>
<div class="paragraph">
<p>In case <code>Step</code> is positive, <code>Start</code> defaults to 0 and <code>Stop</code> defaults to the length of the array. If <code>Step</code> is negative, <code>Start</code> defaults to the length of the array minus 1 (i.e., the last element&#8217;s index) and <code>Stop</code> defaults to -1. A <code>Step</code> of 0 leads to an error.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Applied to the Array <code>[1, 2, 3, 4, 5]</code>, the selection step <code>[-2:]</code> returns the Array <code>[4, 5]</code> (the last two elements).
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
If start and end are to be left empty, the two colons must be separated by a whitespace to avoid confusion with the sub-template operator. So write <code>[: :-2]</code> instead of <code>[::-2]</code>.
</td>
</tr>
</table>
</div>
</div>
<div class="sect5">
<h6 id="index-union-index1-index2"><a class="anchor" href="#index-union-index1-index2"></a>Index Union <code>[index1, index2, &#8230;&#8203;]</code></h6>
<div class="paragraph">
<p>Using the bracket notation, a set of multiple array indices (numbers) can be denoted separated by commas. This returns an array containing the items of the original array if the item&#8217;s index is contained in the specified indices. Since a <strong>set</strong> of indices is specified, the indices' order is ignored and duplicate elements are removed. The result array contains the specified elements in their original order. Indices which do not exist in the original array are ignored.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Both <code>[3, 2, 2]</code> and <code>[2, 3]</code> return the same result.
</td>
</tr>
</table>
</div>
</div>
<div class="sect5">
<h6 id="attribute-union-attribute1-attribute2"><a class="anchor" href="#attribute-union-attribute1-attribute2"></a>Attribute Union <code>["attribute1", "attribute2", &#8230;&#8203;]</code></h6>
<div class="paragraph">
<p>Using the bracket notation, a set of multiple attribute keys (strings) can be denoted separated by commas. This returns an array containing the values of the denoted attributes. Since a <strong>set</strong> of attribute keys is specified, the keys' order is ignored and duplicate elements are removed. As attributes have no order, the sorting of the result array is not specified. Attributes which do not exist are ignored.</p>
</div>
</div>
<div class="sect5">
<h6 id="attribute-selection-on-array"><a class="anchor" href="#attribute-selection-on-array"></a>Attribute Selection on Array</h6>
<div class="paragraph">
<p>Although arrays do not have attributes (they have items), a key step can be applied to an array (e.g. <code>array.value</code>). This will loop through each item of the array and look for the specified attribute in this item. An array containing all values of the attributes found is returned. In other words the selection step is not applied to the result of the previous step (the array) but to each item of the result and the (sub-)results are concatenated. In case an array item is no object or does not contain the specified attribute, it is skipped.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Applied to an object</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="javascript">{
    <span class="key"><span class="delimiter">&quot;</span><span class="content">array</span><span class="delimiter">&quot;</span></span>:[
        {<span class="key"><span class="delimiter">&quot;</span><span class="content">key</span><span class="delimiter">&quot;</span></span>:<span class="string"><span class="delimiter">&quot;</span><span class="content">value1</span><span class="delimiter">&quot;</span></span>},
        {<span class="key"><span class="delimiter">&quot;</span><span class="content">key</span><span class="delimiter">&quot;</span></span>:<span class="string"><span class="delimiter">&quot;</span><span class="content">value2</span><span class="delimiter">&quot;</span></span>}
    ]
}</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>array.key</code> returns the following array: <code>["value1", "value2"]</code> (the value of the <code>key</code> attribute of each item of <code>array</code>).</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect5">
<h6 id="attribute-finder-finder-name"><a class="anchor" href="#attribute-finder-finder-name"></a>Attribute Finder <code>.&lt;finder.name&gt;</code></h6>
<div class="paragraph">
<p>In SAPL it is possible to receive attributes which are not contained in the authorization subscription. Those attributes can be provided by external PIPs and obtained through attribute finders.</p>
</div>
<div class="paragraph">
<p>The standard attributes in SAPL are indented to gather more information with regards to a given JSON value, i.e., the subject, action, resource, environment objects in the subscription or any other JSON value.</p>
</div>
<div class="paragraph">
<p>A standard attribute finder is called via the selection step <code>.&lt;finder.name&gt;</code>. Where <code>finder.name</code> either is a fully qualified attribute finder name or can be a shorter name if imports are used (the finder name or the library alias followed by a period <code>.</code> and the finder name). this step may follow any number of selection steps.</p>
</div>
<div class="paragraph">
<p>An attribute accessed this way is treated as a subscription. I.e., the PDP will subscribe to the data source and whenever a new value is returned the policy is reevaluated and a new decision is calculated.</p>
</div>
<div class="paragraph">
<p>The attribute finder receives the result of the previous selection as an argument and returns a JSON value. Optionally, an attribute finder may be supplied with a list of parameters: <code>.&lt;finder.name(p1,p2,&#8230;&#8203;)&gt;</code>.</p>
</div>
<div class="paragraph">
<p>Attribute finders may be nested: <code>subject.&lt;finder.name2&gt;.&lt;finder.name(p1,action.&lt;finder.name3&gt;,&#8230;&#8203;)&gt;</code>. Here, whenever the attributes with <code>name2</code> and  <code>name3</code> all have a first result and whenever one of the results change, the attribute with name <code>name</code> is re-subscribed with the new input parameters.</p>
</div>
<div class="paragraph">
<p>An environment attribute finder is an attribute finder intended for accessing information possibly independent of subscription data, e.g., current time or an organization wide emergency level. These environment attributes are not to be confused with the data which is contained in the environment object in the subscription. The data contained there is environment data provided by the PEP from its application context at subscription time and may not be accessible from the PDP otherwise. Environment attributes do not require a left hand input and can be accessed without a leading value, variable, or sequence of selection steps: <code>&lt;organization.emergencyLevel&gt;</code> may refer to a stream indicating an emergency level in an organization. Analogous, to standard attributes, these attributes may be parameterized and nested.</p>
</div>
<div class="paragraph">
<p>All attribute finders may be followed by arbitrary selection steps.</p>
</div>
<div class="paragraph">
<p>In some scenarios it may not be the right thing to subscribe to attributes, but to just retrieve the data once on subscription time.
For this, SAPL offers the head operator for both standard and environment attributes. Prepending the pipe symbol <code>|</code> in front of an attribute finder step will only return the first value returned by the attribute finder. E.g.: <code>subject.id.|&lt;geo.location&gt;</code>. However such an attribute may still return a stream, if used with nested attributes which do not employ the head operator.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Assuming a doctor should only be allowed to access patient data from patients on her unit. The following expression retrieves the unit (attribute finder <code>pip.hospital_units.by_patientid</code>) by the requested patient id (<code>action.patientid</code>) and selects the id of the supervising doctor (<code>.doctorid</code>):</p>
</div>
<div class="literalblock">
<div class="content">
<pre>action.patientid.&lt;pip.hospital_units.by_patientid&gt;.doctorid</pre>
</div>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Attribute finders are described in greater detail <a href="#attribute-finders">below</a>.</p>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="filtering"><a class="anchor" href="#filtering"></a>Filtering</h4>
<div id="filtering" class="paragraph">
<p>SAPL provides syntax elements for having a value pass specified <strong>filters</strong> and thereby modifying it.</p>
</div>
<div class="paragraph">
<p>Filters can only be applied to basic expressions (remember that an expression in parentheses is a basic expression). Filtering is denoted by the <code>|-</code> operator after the expression. Which <strong>filter function</strong> is applied in what way can be defined by a <strong>simple filtering component</strong> or by an <strong>extended filtering component</strong>, which consists of several filter statements.</p>
</div>
<div class="sect4">
<h5 id="filter-functions"><a class="anchor" href="#filter-functions"></a>Filter Functions</h5>
<div class="paragraph">
<p>SAPL provides three <strong>built-in filter functions</strong>:</p>
</div>
<div class="paragraph">
<div class="title">remove</div>
<p>Removes a whole attribute (key and value pair) of an object or an item of an array without leaving a replacement.</p>
</div>
<div class="paragraph">
<div class="title">filter.replace(replacement)</div>
<p>Replaces an attribute or an element by the result of evaluating the expression <code>replacement</code>.</p>
</div>
<div class="paragraph">
<div class="title">filter.blacken(disclose\_left=0,disclose\_right=0,replacement="X")</div>
<p>Replaces each char of a attribute or item (which has to be a string) by <code>replacement</code>, leaving <code>show\_left</code> chars from the beginning and <code>show\_right</code> chars from the end unchanged. By default, no chars are visible and each char is replaced by <code>X</code>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<code>filter.blacken</code> could be used to reveal only the first digit of the credit card number and replace the other digits by <code>X</code>.
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<code>filter.replace</code> and <code>filter.blacken</code> are part of the library <code>filter</code>. Importing this library through <code>import filter</code> makes the functions available under their simple names.
</td>
</tr>
</table>
</div>
<div class="sidebarblock">
<div class="content">
<div class="paragraph">
<p><strong>Example</strong></p>
</div>
<div class="paragraph">
<p>We take the following object:</p>
</div>
<div class="listingblock">
<div class="title">Object Structure</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="javascript">{
    <span class="key"><span class="delimiter">&quot;</span><span class="content">value</span><span class="delimiter">&quot;</span></span> : <span class="string"><span class="delimiter">&quot;</span><span class="content">aValue</span><span class="delimiter">&quot;</span></span>,
    <span class="key"><span class="delimiter">&quot;</span><span class="content">id</span><span class="delimiter">&quot;</span></span> : <span class="integer">5</span>
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>If <code>value</code> is <strong>removed</strong>, the resulting object is <code>{ "id" : 5 }</code>.</p>
</div>
<div class="paragraph">
<p>If instead <strong>filter.replace</strong> is applied to <code>value</code> with the Expression <code>null</code>, the resulting object is <code>{ "value" : null, "id" : 5 }</code>.</p>
</div>
<div class="paragraph">
<p>If the function <strong>filter.blacken</strong> is applied to <code>value</code> without specifying any arguments, the result would be <code>{ "value" : "XXXXXX", "id" : 5 }</code>.</p>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="simple-filtering"><a class="anchor" href="#simple-filtering"></a>Simple Filtering</h5>
<div class="paragraph">
<p>A simple filter component applies a <strong>filter function</strong> to the preceding value. The syntax is:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>BasicExpression |- Function</pre>
</div>
</div>
<div class="paragraph">
<p><code>BasicExpression</code> is evaluated to a value, the function is applied to this value and the result is returned. If no other arguments are passed to the function, the empty parentheses <code>()</code> after the function name can be omitted.</p>
</div>
<div class="paragraph">
<p>In case <code>BasicExpression</code> evaluates to an array, the whole array is passed to the filter function. The <strong>keyword <code>each</code></strong> before <code>Function</code> can be used to apply the function to each array item instead:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>Expression |- each Function</pre>
</div>
</div>
<div class="sidebarblock">
<div class="content">
<div class="paragraph">
<p><strong>Example</strong></p>
</div>
<div class="paragraph">
<p>Let&#8217;s assume our resource contains an array of credit card numbers:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="javascript">{
    <span class="key"><span class="delimiter">&quot;</span><span class="content">numbers</span><span class="delimiter">&quot;</span></span>: [
        <span class="string"><span class="delimiter">&quot;</span><span class="content">1234123412341234</span><span class="delimiter">&quot;</span></span>,
        <span class="string"><span class="delimiter">&quot;</span><span class="content">2345234523452345</span><span class="delimiter">&quot;</span></span>,
        <span class="string"><span class="delimiter">&quot;</span><span class="content">3456345634563456</span><span class="delimiter">&quot;</span></span>
    ]
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The function <code>blacken(1)</code> without any additional parameters takes a string and replaces everything by <code>X</code> except the first char. We can receive the blackened numbers through the basic expression <code>resource.numbers |- each blacken(1)</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="javascript">[
    <span class="string"><span class="delimiter">&quot;</span><span class="content">1XXXXXXXXXXXXXXX</span><span class="delimiter">&quot;</span></span>,
    <span class="string"><span class="delimiter">&quot;</span><span class="content">2XXXXXXXXXXXXXXX</span><span class="delimiter">&quot;</span></span>,
    <span class="string"><span class="delimiter">&quot;</span><span class="content">3XXXXXXXXXXXXXXX</span><span class="delimiter">&quot;</span></span>
]</code></pre>
</div>
</div>
<div class="paragraph">
<p>Without the keyword <code>each</code>, the function <code>blacken</code> would be applied to the array itself, resulting in an error (since as stated above, <code>blacken</code> can only be applied to a String).</p>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="extended-filtering"><a class="anchor" href="#extended-filtering"></a>Extended Filtering</h5>
<div class="paragraph">
<p>Extended filtering can be used to state more precisely how a value will be altered.</p>
</div>
<div class="paragraph">
<p>E.g., the expression</p>
</div>
<div class="listingblock">
<div class="content">
<pre>resource |- { @.credit_card : blacken }</pre>
</div>
</div>
<div class="paragraph">
<p>would return the original resource except for the value of the attribute <code>credit_card</code> being blackened.</p>
</div>
<div class="paragraph">
<p>Extended filtering components consist of one or more <strong>filter statements</strong>. Each filter statement has a target expression and specifies a filter function that shall be applied to the attribute value (or to each of its items if the keyword <code>each</code> is used). The basic syntax is:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>Expression |- {
    FilterStatement,
    FilterStatement,
    ...
}</pre>
</div>
</div>
<div class="paragraph">
<p>The syntax of a filter statement is:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>each TargetRelativeExpression : Function</pre>
</div>
</div>
<div class="paragraph">
<p><code>each</code> is an optional keyword. If used, the <code>TargetRelativeExpression</code> has to evaluate to an array. In this case <code>Function</code> is applied to each item of that array.</p>
</div>
<div class="paragraph">
<p><code>TargetRelativeExpression</code> contains a basic relative expression starting with <code>@</code>. The character <code>@</code> references the result of the evaluation of <code>Expression</code>, so attributes of the value to filter can be accessed easily. Mind that attribute finder steps are not allowed at this place. The value of the attribute selected by the target expresion is replaced by the result of the filter function.</p>
</div>
<div class="paragraph">
<p>The filter statements are applied successively from top to bottom.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
Some filter functions can be applied to both arrays and other types (e.g. <code>remove</code>). Yet there are selection steps resulting in a "helper array" that cannot be modified. If, for instance, <code>.*</code> is applied to the object <code>{"key1" : "value1", "key2" : "value2"}</code>, the result would be <code>["value1", "value2"]</code>. It is not possible to apply a filter function directly to this array because changing the array itself would not have any effect. The array has been constructed merely to hold multiple values for further processing. In this case the policy would <strong>have to</strong> use the keyword <code>each</code> and apply the function to each item. Attempting to alter a helper array results in an error.
</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="custom-filter-functions"><a class="anchor" href="#custom-filter-functions"></a>Custom Filter Functions</h5>
<div class="paragraph">
<p>Any function available in SAPL can be used in a filter statement, thus it is easy to add custom filter functions.</p>
</div>
<div class="paragraph">
<p>When used in a filter statement, the value to filter is passed to the function as its first argument. Consequently the arguments specified in the function call are passed as second, third etc. arguments.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Assuming a filter function <code>roundto</code> should round a value to the closest multiple of a given number, e.g., <code>207 |- roundto(100)</code> should return <code>200</code>. In its definition the function needs two formal parameters, the first one is taken for the original value and the second one for the number to round to.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect3">
<h4 id="subtemplate"><a class="anchor" href="#subtemplate"></a>Subtemplate</h4>
<div class="paragraph">
<p>It is possible to define a subtemplate for an array in order to replace each item of the array by this subtemplate. A subtemplate component is an optional part of a basic expression.</p>
</div>
<div class="paragraph">
<p>E.g., the basic expression</p>
</div>
<div class="listingblock">
<div class="content">
<pre>resource.patients :: {
    "name" : @.name
}</pre>
</div>
</div>
<div class="paragraph">
<p>would return the <code>patients</code> array from the resource but with each item containing only one attribute <code>name</code>.</p>
</div>
<div class="paragraph">
<p>The subtemplate is denoted after a double colon:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>Array :: Expression</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>Expression</code> represents the replacement template. In this expression, basic relative expressions (starting with <code>@</code>) can be used to access the attributes of the current array item. <code>@</code> references the array item which is currently being replaced. <code>Array</code> has to evaluate to an array. For each item of <code>Array</code>, <code>Expression</code> is evaluated and the item is replaced by the result.</p>
</div>
<div class="sidebarblock">
<div class="content">
<div class="paragraph">
<p><strong>Example</strong></p>
</div>
<div class="paragraph">
<p>Given the variable <code>array</code> contains the following array:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="javascript">[
    { <span class="key"><span class="delimiter">&quot;</span><span class="content">id</span><span class="delimiter">&quot;</span></span> : <span class="integer">1</span> },
    { <span class="key"><span class="delimiter">&quot;</span><span class="content">id</span><span class="delimiter">&quot;</span></span> : <span class="integer">2</span> }
]</code></pre>
</div>
</div>
<div class="paragraph">
<p>The basic expression</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>array :: {
    "aKey" : "aValue"
    "identifier" : @.id
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>would evaluate to:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="javascript">[
    {<span class="key"><span class="delimiter">&quot;</span><span class="content">aKey</span><span class="delimiter">&quot;</span></span> : <span class="string"><span class="delimiter">&quot;</span><span class="content">aValue</span><span class="delimiter">&quot;</span></span>, <span class="key"><span class="delimiter">&quot;</span><span class="content">identifier</span><span class="delimiter">&quot;</span></span> : <span class="integer">1</span> },
    {<span class="key"><span class="delimiter">&quot;</span><span class="content">aKey</span><span class="delimiter">&quot;</span></span> : <span class="string"><span class="delimiter">&quot;</span><span class="content">aValue</span><span class="delimiter">&quot;</span></span>, <span class="key"><span class="delimiter">&quot;</span><span class="content">identifier</span><span class="delimiter">&quot;</span></span> : <span class="integer">2</span> }
]</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="authorization-subscription-evaluation"><a class="anchor" href="#authorization-subscription-evaluation"></a>Authorization Subscription Evaluation</h2>
<div class="sectionbody">
<div id="evaluation" class="paragraph">
<p>For any authorization subscription the PDP evaluates each top level SAPL document against the subscription and combines the decisions. If a top level document is a policy set, it contains multiple policies which have to be evaluated first. Their decisions are combined to form an evaluation decision for the policy set. Finally a resource might be added to the final result as well as obligations and advice.</p>
</div>
<div class="paragraph">
<p>The underlying concept assumes that during evaluation, a decision is assigned to each document. This process will be explained in the following sections.</p>
</div>
<div class="sect2">
<h3 id="policy-2"><a class="anchor" href="#policy-2"></a>Policy</h3>
<div class="paragraph">
<p>Evaluating a policy against an authorization subscription means assigning a value of <code>NOT_APPLICABLE</code>, <code>INDETERMINATE</code>, <code>PERMIT</code> and <code>DENY</code> to it. The assigned value depends on the result of evaluating the policy&#8217;s target and condition (which are conditions that can either be <code>true</code> or <code>false</code>):</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 2. Policy Evaluation Table</caption>
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Target Expression</th>
<th class="tableblock halign-left valign-top">Condition</th>
<th class="tableblock halign-left valign-top">Policy Value</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>false</code> (not matching)</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>don&#8217;t care</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>NOT_APPLICABLE</code></p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>true</code> (matching)</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>false</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>NOT_APPLICABLE</code></p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><em>Error</em></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>don&#8217;t care</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>INDETERMINATE</code></p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>true</code> (matching)</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><em>Error</em></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>INDETERMINATE</code></p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>true</code> (matching)</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>true</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Policy&#8217;s <strong>Entitlement</strong> (<code>PERMIT</code> or <code>DENY</code>)</p>
</div></div></td>
</tr>
</tbody>
</table>
</div>
<div class="sect2">
<h3 id="policy-set"><a class="anchor" href="#policy-set"></a>Policy Set</h3>
<div id="policy-set" class="paragraph">
<p>A decision value (<code>NOT_APPLICABLE</code>, <code>INDETERMINATE</code>, <code>PERMIT</code> or <code>DENY</code>) can also be assigned to a policy set. This value depends on the result of evaluating the policy set&#8217;s target expression and the policies contained in the policy set:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 3. Policy Set Evaluation Table</caption>
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Target Expression</th>
<th class="tableblock halign-left valign-top">Policy Values</th>
<th class="tableblock halign-left valign-top">Policy Set Value</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>false</code> (not matching)</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>don&#8217;t care</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>NOT_APPLICABLE</code></p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>true</code> (matching)</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>don&#8217;t care</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Result of the <strong>Combining Algorithm</strong> applied to the Policies</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><em>Error</em></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>don&#8217;t care</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>INDETERMINATE</code></p>
</div></div></td>
</tr>
</tbody>
</table>
</div>
<div class="sect2">
<h3 id="authorization-subscription"><a class="anchor" href="#authorization-subscription"></a>Authorization Subscription</h3>
<div class="paragraph">
<p>The value which is assigned to the authorization subscription, i.e., the final authorization decision to be returned by the PDP, is the result of applying a combining algorithm to the values assigned to all top level SAPL documents.</p>
</div>
<div class="paragraph">
<p>Finally in case the decision is <code>PERMIT</code> and there is a <code>transform</code> statement, the transformed resource is added to the authorization decision. Additionally there might be obligation and advice contained in the policies which has to be added to the authorization decision.</p>
</div>
</div>
<div class="sect2">
<h3 id="combining-algorithm-2"><a class="anchor" href="#combining-algorithm-2"></a>Combining Algorithm</h3>
<div id="combining-algorithms" class="paragraph">
<p>There are two layers with possibly multiple decisions which finally need to be consolidated in a single decision:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>A policy set might contain multiple policies evaluating to different decisions. There must be a final decision for the policy set (<em>Policy Combination</em>).</p>
</li>
<li>
<p>The PDP might know multiple policy sets and policies which may evaluate to different decisions. In the end the PDP has to include a final decision in the SAPL authorization decision (<em>Document Combination</em>).</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>A combining algorithm describes how to come to the final decision. Both the PDP itself and each policy set have to be configured with a combining algorithm.</p>
</div>
<div class="paragraph">
<p>Some complexity is added to the algorithms if transformation statements in policies are used: There is no possibility to combine multiple transformation statements. Hence the combining algorithms have to deal with the situation that multiple policies evaluate to <code>PERMIT</code> and at least one of them contains a transformation part. In case of such <em>transformation uncertainty</em> the decision must not be <code>PERMIT</code>.</p>
</div>
<div class="paragraph">
<p>SAPL provides the following combining algorithms:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>deny-unless-permit</code></p>
</li>
<li>
<p><code>permit-unless-deny</code></p>
</li>
<li>
<p><code>only-one-applicable</code></p>
</li>
<li>
<p><code>deny-overrides</code></p>
</li>
<li>
<p><code>permit-overrides</code></p>
</li>
<li>
<p><code>first-applicable</code> (not allowed on PDP level for document combination)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The algorithms work similarly on the PDP and on the policy set level. Thus the following section describes their function in general, using the term <em>policy document</em> for a policy and a policy set. If the algorithm is used on the PDP level, a <em>policy document</em> could be either a (top level) policy or a policy set, on the policy set level a <em>policy document</em> is always a policy.</p>
</div>
<div class="sect3">
<h4 id="deny-unless-permit"><a class="anchor" href="#deny-unless-permit"></a><code>deny-unless-permit</code></h4>
<div class="paragraph">
<p>This strict algorithm is used if the decision should be <code>DENY</code> except for there is a <code>PERMIT</code>. It ensures that any decision is either <code>DENY</code> or <code>PERMIT</code>.</p>
</div>
<div class="paragraph">
<p>It works as follows:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>If any policy document evaluates to <code>PERMIT</code> and there is no <em>transformation uncertainty</em> (multiple policies evaluate to <code>PERMIT</code> and at least one of them has a transformation statement), the decision is <code>PERMIT</code>.</p>
</li>
<li>
<p>Otherwise the decision is <code>DENY</code>.</p>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="permit-unless-deny"><a class="anchor" href="#permit-unless-deny"></a><code>permit-unless-deny</code></h4>
<div class="paragraph">
<p>This generous algorithm is used if the decision should be <code>PERMIT</code> except for there is a <code>DENY</code>. It ensures that any decision is either <code>DENY</code> or <code>PERMIT</code>.</p>
</div>
<div class="paragraph">
<p>It works as follows:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>If any policy document evaluates to <code>DENY</code> or if there is a <em>transformation uncertainty</em> (multiple policies evaluate to <code>PERMIT</code> and at least one of them has a transformation statement), the decision is <code>DENY</code>.</p>
</li>
<li>
<p>Otherwise the decision is <code>PERMIT</code>.</p>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="only-one-applicable"><a class="anchor" href="#only-one-applicable"></a><code>only-one-applicable</code></h4>
<div class="paragraph">
<p>This algorithm is used if policy sets and policies are constructed in a way that multiple policy documents with a matching target are considered an error. A <code>PERMIT</code> or <code>DENY</code> decision will only be returned if there is exactly one policy set or policy with matching target expression and if this policy document evaluates to <code>PERMIT</code> or <code>DENY</code>.</p>
</div>
<div class="paragraph">
<p>It works as follows:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>If any target evaluation results in an error (<code>INDETERMINATE</code>) or if more than one policy documents have a matching target, the decision is <code>INDETERMINATE</code>.</p>
</li>
<li>
<p>Otherwise:</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>If there is no matching policy document, the decision is <code>NOT_APPLICABLE</code>.</p>
</li>
<li>
<p>Otherwise, i.e., there is exactly one matching policy document, the decision is the result of evaluating this policy document.</p>
</li>
</ol>
</div>
</li>
</ol>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Transformation uncertainty may not occur using the <code>only-one-applicable</code> combining algorithm.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="deny-overrides"><a class="anchor" href="#deny-overrides"></a><code>deny-overrides</code></h4>
<div class="paragraph">
<p>This algorithm is used if a <code>DENY</code> decision should prevail a <code>PERMIT</code> without setting a default decision.</p>
</div>
<div class="paragraph">
<p>It works as follows:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>If any policy document evaluates to <code>DENY</code>, the decision is <code>DENY</code>.</p>
</li>
<li>
<p>Otherwise:</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>If there is any <code>INDETERMINATE</code> or there is a <em>transformation uncertainty</em> (multiple policies evaluate to <code>PERMIT</code> and at least one of them has a transformation statement), the decision is <code>INDETERMINATE</code>.</p>
</li>
<li>
<p>Otherwise:</p>
<div class="olist lowerroman">
<ol class="lowerroman" type="i">
<li>
<p>If there is any <code>PERMIT</code> the decision is <code>PERMIT</code>.</p>
</li>
<li>
<p>Otherwise the decision is <code>NOT_APPLICABLE</code>.</p>
</li>
</ol>
</div>
</li>
</ol>
</div>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="permit-overrides"><a class="anchor" href="#permit-overrides"></a><code>permit-overrides</code></h4>
<div class="paragraph">
<p>This algorithm is used if a <code>PERMIT</code> decision should prevail a <code>DENY</code> without setting a default decision.</p>
</div>
<div class="paragraph">
<p>It works as follows:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>If any policy document evaluates to <code>PERMIT</code> and there is no <em>transformation uncertainty</em> (multiple policies evaluate to <code>PERMIT</code> and at least one of them has a transformation statement), the decision is <code>PERMIT</code>.</p>
</li>
<li>
<p>Otherwise:</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>If there is any <code>INDETERMINATE</code> or there is a <em>transformation uncertainty</em> (multiple policies evaluate to <code>PERMIT</code> and at least one of them has a transformation statement), the decision is <code>INDETERMINATE</code>.</p>
</li>
<li>
<p>Otherwise:</p>
<div class="olist lowerroman">
<ol class="lowerroman" type="i">
<li>
<p>If there is any <code>DENY</code> the decision is <code>DENY</code>.</p>
</li>
<li>
<p>Otherwise the decision is <code>NOT_APPLICABLE</code>.</p>
</li>
</ol>
</div>
</li>
</ol>
</div>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="first-applicable"><a class="anchor" href="#first-applicable"></a><code>first-applicable</code></h4>
<div class="paragraph">
<p>This algorithm is used if the policy administrator manages the policy&#8217;s priority by their order in a policy set. As soon as the first policy returns <code>PERMIT</code>, <code>DENY</code> or <code>INDETERMINATE</code>, its result is the final decision. Thus a "default" can be specified by creating a last policy without any conditions. If a decision is found, errors which might occur in later policies are ignored.</p>
</div>
<div class="paragraph">
<p>Since there is no order in the policy documents known to the PDP, the PDP cannot be configured with this algorithm. <code>first-applicable</code> might only be used for policy combination inside a policy set.</p>
</div>
<div class="paragraph">
<p>It works as follows:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Each policy is evaluated in the order specified in the policy set.</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>If it evaluates to <code>INDETERMINATE</code>, the decision is <code>INDETERMINATE</code>.</p>
</li>
<li>
<p>If it evaluates to <code>PERMIT</code> or <code>DENY</code>, the decision is <code>PERMIT</code> or <code>DENY</code></p>
</li>
<li>
<p>If it evaluates to <code>NOT_APPLICABLE</code>, the next policy is evaluated.</p>
</li>
</ol>
</div>
</li>
<li>
<p>If no policy with a decision different from <code>NOT_APPLICABLE</code> has been found, the decision of the policy set is <code>NOT_APPLICABLE</code>.</p>
</li>
</ol>
</div>
</div>
</div>
<div class="sect2">
<h3 id="transformation-2"><a class="anchor" href="#transformation-2"></a>Transformation</h3>
<div class="paragraph">
<p>A policy with entitlement <code>permit</code> can contain a transformation statement. If the decision is <code>PERMIT</code> and there is a policy evaluating to <code>PERMIT</code> with transformation, the result of evaluating the expression after the keyword <code>transform</code> is returned as <code>resource</code> in the authorization decision.</p>
</div>
<div class="paragraph">
<p>The combining algorithms ensure that transformation is always unambiguous. Consequently, there either is exactly one transformation or none.</p>
</div>
</div>
<div class="sect2">
<h3 id="obligation-advice"><a class="anchor" href="#obligation-advice"></a>Obligation / Advice</h3>
<div class="paragraph">
<p>Finally obligation and advice might be added to the authorization decision. Both of them can be defined for each individual policy. If a final decision is <code>PERMIT</code> there can be multiple policies and policy sets evaluating to <code>PERMIT</code>, each of them containing an obligation and/or advice statement - same goes for <code>DENY</code>. The final authorization decision with a certain decision has to contain all obligation and advice from policy documents evaluating to this decision.</p>
</div>
<div class="paragraph">
<p>On the two levels (PDP and policy set), collection of obligation and advice works as follows:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Policy Set</strong>: If the policy set evaluates to a certain decision (<code>PERMIT</code> or <code>DENY</code>), the obligation and advice from all contained policies evaluating to this decision is bundled as the obligation and advice of the policy set.</p>
<div class="paragraph">
<p>(For the combining algorithm <code>first-applicable</code> not all policies might be evaluated. A value <code>PERMIT</code> or <code>DENY</code> is only assigned to evaluated policies. Thus the policy set&#8217;s obligation and advice merely contains obligation and advice from evaluated policies.)</p>
</div>
</li>
<li>
<p><strong>PDP</strong>: If the final decision is <code>PERMIT</code> or <code>DENY</code>, the obligation and advice from all top level policy documents evaluating to this final decision is collected as the final decision&#8217;s obligation and advice.</p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="functions"><a class="anchor" href="#functions"></a>Functions</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Functions can be used within SAPL expressions (basic function expressions). A function takes a number of inputs (called <em>arguments</em>) and returns an output value.</p>
</div>
<div class="paragraph">
<p>Functions are organized in function libraries. Each function library has a <em>name</em> consisting of one or more identifiers separated by periods <code>.</code> (e.g., <code>simple.string</code> or <code>filter</code>). The <em>fully qualified name</em> of a function consists of the library name followed by a period and the function name (e.g., <code>simple.string.append</code>).</p>
</div>
<div class="paragraph">
<p>Functions can be used in any part of a SAPL document, especially in the target expression. Thus their output should only depend on the input arguments and they should not access external resources. Functions do not have access to environment variables.</p>
</div>
<div class="sect2">
<h3 id="the-standard-function-library"><a class="anchor" href="#the-standard-function-library"></a>The Standard Function Library</h3>
<div class="paragraph">
<p>SAPL will come with a standard function library providing the most important functions.</p>
</div>
</div>
<div class="sect2">
<h3 id="custom-function-libraries"><a class="anchor" href="#custom-function-libraries"></a>Custom Function Libraries</h3>
<div class="paragraph">
<p>The standard functions can be extended by custom functions. Function libraries available in SAPL documents are collected in the PDP&#8217;s function context. The embedded PDP provides an <code>AnnotationFunctionContext</code> where Java classes with annotations can be provided as function libraries:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>To be recognized as a function library, a class has to be annotated with <code>@FunctionLibrary</code>. The optional annotation attribute <code>name</code> contains the library&#8217;s name as it will be available in SAPL policies. The attribute value has to be a string consisting of one or more identifiers separated by periods. If the attribute is missing, the name of the Java class is used. The optional annotation attribute <code>description</code> contains a string describing the library for documentation purposes.</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@FunctionLibrary</span>(name = <span class="string"><span class="delimiter">&quot;</span><span class="content">sample.functions</span><span class="delimiter">&quot;</span></span>, description = <span class="string"><span class="delimiter">&quot;</span><span class="content">a sample library</span><span class="delimiter">&quot;</span></span>)
<span class="directive">public</span> <span class="type">class</span> <span class="class">SampleFunctionLibrary</span> {
    ...
}</code></pre>
</div>
</div>
</li>
<li>
<p>The annotation <code>@Function</code> identifies a function in the library. An optional annotation attribute <code>name</code> can contain a function name. The attribute is a string containing an identifier. By default, the name of the Java function will be used. The annotation attribute <code>docs</code> can contain a string describing the function.</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Function</span>(docs = <span class="string"><span class="delimiter">&quot;</span><span class="content">returns the length</span><span class="delimiter">&quot;</span></span>)
<span class="directive">public</span> <span class="directive">static</span> JsonNode length(
        <span class="annotation">@Text</span> parameter
) {
    ...
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Each parameter can be annotated with any number of <code>@Array</code>, <code>@Bool</code>, <code>@Int</code>, <code>@JsonObject</code>, <code>@Long</code>, <code>@Number</code> and <code>@Text</code>. The annotations describe which types are allowed for the parameter (in case of multiple annotations, each of these types is allowed).</p>
</div>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="attribute-finders"><a class="anchor" href="#attribute-finders"></a>Attribute Finders</h2>
<div class="sectionbody">
<div id="attribute-finders" class="paragraph">
<p>Attribute finders are used to receive attributes which are not included in the authorization subscription context from external PIPs. Just like in <code>subject.age</code>, the selection step <code>.age</code> selects the attribute <code>age</code>s value, <code>subject.&lt;user.age&gt;</code> could be used to fetch an <code>age</code> attribute which is not included in <code>subject</code> but can be obtained from a PIP named <code>user</code>.</p>
</div>
<div class="paragraph">
<p>Attribute finders are organized in libraries as well and follow the same naming conventions as functions, including the use of imports. An attribute finder library constitutes a PIP (e.g., <code>user</code>) and can contain any number of attributes (e.g., <code>age</code>). They are called by a selection step applied to any value, e.g., <code>subject.&lt;user.age&gt;</code>. The attribute finder step receives the previous selection result (in the example: <code>subject</code>) and returns the requested attribute.</p>
</div>
<div class="paragraph">
<p>The concept of attribute finders can be used in a flexible manner: There may be finders which take an object (like in the example above, <code>subject.&lt;user.age&gt;</code>) as well as attribute finders which expect a primitive value (e.g., <code>subject.id.&lt;user.age&gt;</code> with <code>id</code> being a number). In addition attribute finders may also return an object which can be traversed in future selection steps (e.g., <code>subject.&lt;user.profile&gt;.age</code>). It is even possible to join multiple attribute finder steps in one expression (e.g., <code>subject.&lt;user.profile&gt;.supervisor.&lt;user.profile&gt;.age</code>).</p>
</div>
<div class="paragraph">
<p>Optionally, an attribute finder may be supplied with a list of parameters: <code>.&lt;finder.name(p1,p2,&#8230;&#8203;)&gt;</code>.</p>
</div>
<div class="paragraph">
<p>Attribute finders often receive the information from external data sources such as files, databases or HTTP requests which may take a certain amount of time. Therefore they must not be used in a target expression. Attribute finders can access environment variables.</p>
</div>
<div class="sect2">
<h3 id="the-standard-attribute-finders"><a class="anchor" href="#the-standard-attribute-finders"></a>The Standard Attribute Finders</h3>
<div class="paragraph">
<p>Most attribute finders will be specific to an organization or an environment. E.g., a hospital might provide information about medical units, doctors and patients and use specific attribute finders for this information. Yet SAPL will offer a number of general purpose attribute finders.</p>
</div>
</div>
<div class="sect2">
<h3 id="custom-attribute-finders"><a class="anchor" href="#custom-attribute-finders"></a>Custom Attribute Finders</h3>
<div class="paragraph">
<p>Attribute finders are functions which take exactly one argument and return any value. Each attribute finder library (also called PIP) has to be known to the PDP. The embedded PDP provides an <code>AnnotationAttributeContext</code> which takes Java classes as PIPs.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>To be recognized as a PIP, the class has to be annotated with <code>@PolicyInformationPoint</code>. The optional annotation attribute <code>name</code> contains the PIP&#8217;s name as it will be available in SAPL policies. The attribute value is a string consisting of one or more identifiers separated by periods. If the attribute is missing, the name of the Java class is used. The optional annotation attribute <code>description</code> contains a string describing the PIP for documentation purposes.</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@PolicyInformationPoint</span>(name = <span class="string"><span class="delimiter">&quot;</span><span class="content">user</span><span class="delimiter">&quot;</span></span>, description = <span class="string"><span class="delimiter">&quot;</span><span class="content">a sample pip</span><span class="delimiter">&quot;</span></span>)
<span class="directive">public</span> <span class="type">class</span> <span class="class">SampleUserPIP</span> {
    ...
}</code></pre>
</div>
</div>
</li>
<li>
<p>The annotation <code>@Attribute</code> identifies an attribute finder, i.e., a function returning an attribute. An optional annotation attribute <code>name</code> can contain a name for the attribute. The attribute has to be a string containing an identifier. By default, the name of the function will be used. The annotation attribute <code>docs</code> can contain a string describing the attribute.</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Attribute</span>(name = <span class="string"><span class="delimiter">&quot;</span><span class="content">profile</span><span class="delimiter">&quot;</span></span>, docs = <span class="string"><span class="delimiter">&quot;</span><span class="content">returns user profile as JSON</span><span class="delimiter">&quot;</span></span>)
<span class="directive">public</span> <span class="directive">static</span> JsonNode userprofile(
        <span class="annotation">@Number</span> id
) {
    ...
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Each attribute function must have exactly one parameter which can be annotated with any number of <code>@Array</code>, <code>@Bool</code>, <code>@Int</code>, <code>@JsonObject</code>, <code>@Long</code>, <code>@Number</code> and <code>@Text</code>. The annotations describe which types are allowed for the argument passed (in case of multiple annotations each of these types is allowed).</p>
</div>
</li>
</ul>
</div>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Version 2.0.0-SNAPSHOT<br>
Last updated 2021-02-16 14:28:36 UTC
</div>
</div>
</body>
</html>